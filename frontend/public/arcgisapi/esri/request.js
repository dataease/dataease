// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("require ./core/global ./core/has ./core/lang ./config ./core/maybe ./core/Error ./core/urlUtils ./core/promiseUtils ./kernel ./support/requestUtils".split(" "),function(G,y,z,H,B,N,C,h,w,n,O){async function q(a,b){var c=h.isDataProtocol(a);const e=h.isBlobProtocol(a);e||c||(a=h.normalize(a));const d={url:a,requestOptions:{...N.unwrap(b)}};let f=h.getInterceptor(a);if(f){a=await P(f,d);if(null!=a)return{data:a,getHeader:D,requestOptions:d.requestOptions,url:d.url};f.after||f.error||(f=null)}a=
d.url;b=d.requestOptions;if("image"===b.responseType){if(z("host-webworker")||z("host-node"))throw p("request:invalid-parameters",Error("responseType 'image' is not supported in Web Workers or Node environment"),d);}else if(c)throw p("request:invalid-parameters",Error("Data URLs are not supported for responseType \x3d "+b.responseType),d);if("head"===b.method){if(b.body)throw p("request:invalid-parameters",Error("body parameter cannot be set when method is 'head'"),d);if(c||e)throw p("request:invalid-parameters",
Error("data and blob URLs are not supported for method 'head'"),d);}await Q();if(A)return A.execute(a,b);const m=w.createAbortController();w.onAbort(b,()=>m.abort());c=await R({controller:m,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:f,params:d,redoRequest:!1,useIdentity:r.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1});f&&f.after&&f.after(c);return c}function S(a){h.isBlobProtocol(a)||h.isDataProtocol(a)||(a=h.getOrigin(a))&&-1===q._corsServers.indexOf(a)&&
q._corsServers.push(a)}function T(a){a=h.getOrigin(a);return!a||a.endsWith(".arcgis.com")||-1!==q._corsServers.indexOf(a)||h.isTrustedServer(a)}function p(a,b,c,e){let d="Error";const f={url:c.url,requestOptions:c.requestOptions,getHeader:D,ssl:!1};if(b instanceof C)return b.details?(b.details=H.clone(b.details),b.details.url=c.url,b.details.requestOptions=c.requestOptions):b.details=f,b;if(b){c=e&&(g=>e.headers.get(g));const m=e&&e.status,k=b.message;k&&(d=k);c&&(f.getHeader=c);f.httpStatus=(null!=
b.httpCode?b.httpCode:b.code)||m||0;f.subCode=b.subcode;f.messageCode=b.messageCode;f.messages="string"===typeof b.details?[b.details]:b.details}return w.isAbortError(b)?w.createAbortError():new C(a,d,f)}async function Q(){z("host-webworker")?A||(A=await new Promise(function(a,b){G(["./core/workers/request"],a,b)})):q._abortableFetch||(q._abortableFetch=y.fetch.bind(y))}async function E(){n.id||await new Promise(function(a,b){G(["./identity/IdentityManager"],function(c){a(Object.freeze({__proto__:null,
"default":c}))},b)})}async function U(a){const b=a.params.url,c=a.params.requestOptions,e=a.controller.signal;var d=c.body;let f=null,m=null,k=null;I&&"HTMLFormElement"in y&&(d instanceof FormData?f=d:d instanceof HTMLFormElement&&(m=d,f=new FormData(m)));"string"===typeof d&&(k=d);a.fetchOptions={cache:c.cacheBust&&!q._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:c.headers||{},method:"head"===c.method?"HEAD":"GET",mode:"cors",redirect:"follow",signal:e};if(f||k)a.fetchOptions.body=
f||k;"anonymous"===c.authMode&&(a.useIdentity=!1);a.hasToken=!!(/token=/i.test(b)||c.query&&c.query.token||f&&f.get&&f.get("token")||m&&m.elements.token);(d=h.getOrigin(b,!0))&&!a.hasToken&&B.apiKey&&d.endsWith(".arcgis.com")&&"elevation3d.arcgis.com"!==d&&"js.arcgis.com"!==d&&"jsdev.arcgis.com"!==d&&"jsqa.arcgis.com"!==d&&(c.query||(c.query={}),c.query.token=B.apiKey,a.hasToken=!0);if(a.useIdentity&&!a.hasToken&&!a.credentialToken&&!J(b)&&!w.isAborted(e)){let g;"immediate"===c.authMode?(await E(),
g=await n.id.getCredential(b,{signal:e}),a.credential=g):"no-prompt"===c.authMode?(await E(),g=await n.id.getCredential(b,{prompt:!1,signal:e}).catch(()=>{}),a.credential=g):n.id&&(g=n.id.findCredential(b));g&&(a.credentialToken=g.token,a.useSSL=!!g.ssl)}}function J(a){return V.some(b=>b.test(a))}async function W(a){let b=a.params.url;const c=a.params.requestOptions,e=a.fetchOptions,d=h.isBlobProtocol(b)||h.isDataProtocol(b),f=c.responseType||"json",m=d?0:null!=c.timeout?c.timeout:r.timeout;var k=
!1;if(!d){a.useSSL&&(b=h.toHTTPS(b));c.cacheBust&&"default"===e.cache&&(b=h.addQueryParameter(b,"request.preventCache",Date.now()));var g={...c.query};a.credentialToken&&(g.token=a.credentialToken);k=h.objectToQuery(g);z("esri-url-encodes-apostrophe")&&(k=k.replace(/'/g,"%27"));const t=b.length+1+k.length;k="post"===c.method||!!c.body||t>r.maxUrlLength;const v=c.useProxy||!!h.getProxyRule(b);if(v){const F=h.getProxyUrl(b);var x=F.path;!k&&x.length+1+t>r.maxUrlLength&&(k=!0);F.query&&(g={...F.query,
...g})}if("HEAD"===e.method&&(k||v)){if(k){if(t>r.maxUrlLength)throw p("request:invalid-parameters",Error("URL exceeds maximum length"),a.params);throw p("request:invalid-parameters",Error("cannot use POST request when method is 'head'"),a.params);}if(v)throw p("request:invalid-parameters",Error("cannot use proxy when method is 'head'"),a.params);}k?(e.method="POST",c.body?b=h.addQueryParameters(b,g):(e.body=h.objectToQuery(g),e.headers["Content-Type"]="application/x-www-form-urlencoded")):b=h.addQueryParameters(b,
g);v&&(a.useProxy=!0,b=`${x}?${b}`);g.token&&I&&e.body instanceof FormData&&(x=e.body,x.set?x.set("token",g.token):x.append("token",g.token));c.hasOwnProperty("withCredentials")?a.withCredentials=c.withCredentials:h.isTrustedServer(b)?a.withCredentials=!0:n.id&&(g=n.id.findServerInfo(b))&&g.webTierAuth&&(a.withCredentials=!0);a.withCredentials&&(e.credentials="include")}g=0;let K=!1;0<m&&(g=setTimeout(()=>{K=!0;a.controller.abort()},m));let u,l;try{if("image"!==c.responseType||"default"!==e.cache||
"GET"!==e.method||k||X(c.headers)||!d&&!a.useProxy&&r.proxyUrl&&!T(b)){if(u=await q._abortableFetch(b,e),a.useProxy||S(b),u.ok&&"HEAD"!==e.method){switch(f){case "array-buffer":l=await u.arrayBuffer();break;case "blob":case "image":l=await u.blob();break;default:l=await u.text()}g&&(clearTimeout(g),g=0);if("json"===f||"xml"===f||"document"===f)if(l)switch(f){case "json":l=JSON.parse(l);break;case "xml":l=L(l,"application/xml");break;case "document":l=L(l,"text/html")}else l=null;if(l){if("array-buffer"===
f||"blob"===f){const t=u.headers.get("Content-Type");if(/application\/json|text\/plain/i.test(t)&&750>=l["blob"===f?"size":"byteLength"])try{const v=await (new Response(l)).json();v.error&&(l=v)}catch{}}"image"===f&&l instanceof Blob&&(l=await M(URL.createObjectURL(l),a,!0))}}}else l=await M(b,a)}catch(t){if("AbortError"===t.name){if(K)throw Error("Timeout exceeded");throw w.createAbortError("Request canceled");}if(!u&&t instanceof TypeError&&r.proxyUrl&&!c.body&&"post"!==c.method&&"head"!==c.method&&
!a.useProxy)a.redoRequest=!0,h.addProxyRule({proxyUrl:r.proxyUrl,urlPrefix:h.removeFile(h.urlToObject(b).path)});else throw t;}finally{g&&clearTimeout(g)}return[u,l]}async function P(a,b){if(null!=a.responseData)return a.responseData;a.headers&&(b.requestOptions.headers={...b.requestOptions.headers,...a.headers});a.query&&(b.requestOptions.query={...b.requestOptions.query,...a.query});if(a.before){let c,e;try{e=await a.before(b)}catch(d){c=p("request:interceptor",d,b)}if(e instanceof Error||e instanceof
C)c=p("request:interceptor",e,b);if(c)throw a.error&&a.error(c),c;return e}}function X(a){if(a)for(const b of Object.getOwnPropertyNames(a))if(a[b])return!0;return!1}function L(a,b){let c;try{c=(new DOMParser).parseFromString(a,b)}catch{}if(!c||c.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return c}async function R(a){await U(a);let b;try{do[b,c]=await W(a);while(!await Y(a,b,c))}catch(f){var c=p("request:server",f,a.params,b);c.details.ssl=a.useSSL;a.interceptor&&
a.interceptor.error&&a.interceptor.error(c);throw c;}var e=a.params.url;/\/sharing\/rest\/(accounts|portals)\/self/i.test(e)&&!a.hasToken&&!a.credentialToken&&c&&c.user&&c.user.username&&!h.isTrustedServer(e)&&(e=h.getOrigin(e,!0))&&r.trustedServers.push(e);if((e=a.credential)&&n.id){var d=n.id.findServerInfo(e.server);if(d=d&&d.owningSystemUrl)d=d.replace(/\/?$/,"/sharing"),(e=n.id.findCredential(d,e.userId))&&-1===n.id._getIdenticalSvcIdx(d,e)&&e.resources.unshift(d)}return{data:c,getHeader:b?f=>
b.headers.get(f):D,requestOptions:a.params.requestOptions,ssl:a.useSSL,url:a.params.url}}async function Y(a,b,c){var e;if(a.redoRequest)return a.redoRequest=!1;if(!b)return!0;if(!b.ok)throw Error(`Unable to load ${b.url} status: ${b.status}`);let d;c&&c.error&&(d=H.mixin(Error(),c.error));let f,m,k;d&&(f=Number(d.code),m=d.hasOwnProperty("subcode")?Number(d.subcode):null,k=(k=d.messageCode)&&k.toUpperCase());b=a.params.requestOptions.authMode;c=String(null==(e=a.params.requestOptions.query)?void 0:
e.token);if(403===f&&(4===m||d.message&&-1<d.message.toLowerCase().indexOf("ssl")&&-1===d.message.toLowerCase().indexOf("permission"))){if(!a.useSSL)return a.useSSL=!0,!1}else if(a.useIdentity&&("no-prompt"!==b||498===f)&&-1!==Z.indexOf(f)&&!J(a.params.url)&&!c.startsWith("AAPK")&&(403!==f||-1===aa.indexOf(k)&&(null==m||2===m&&a.credentialToken))){await E();try{const g=await n.id.getCredential(a.params.url,{error:p("request:server",d,a.params),prompt:"no-prompt"!==b,signal:a.controller.signal,token:a.credentialToken});
a.credential=g;a.credentialToken=g.token;a.useSSL=a.useSSL||g.ssl;return!1}catch(g){if("no-prompt"===b)return a.credential=null,a.credentialToken=null,!1;d=g}}if(d)throw d;return!0}function M(a,b,c=!1){const e=b.controller.signal,d=new Image;d.crossOrigin=b.withCredentials?"use-credentials":"anonymous";d.alt="";d.src=a;return O.loadImageAsync(d,a,c,e)}let A;const r=B.request,I="FormData"in y,Z=[499,498,403,401],aa=["COM_0056","COM_0057","SB_0008"],V=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,
/\/rest\/info/i],D=()=>null;q._abortableFetch=null;q._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"];return q});