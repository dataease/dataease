// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/has ../../core/Logger ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/property ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../core/Error ../../core/urlUtils ../../core/uuid ../../portal/support/resourceExtension ../../core/Evented ../../core/Collection ../../core/watchUtils ../../core/HandleOwner ../../layers/GraphicsLayer ../Attachments/AttachmentsViewModel ../Spinner/SpinnerViewModel ../FeatureForm/FeatureFormViewModel ../FeatureTemplates/FeatureTemplatesViewModel ../../layers/graphics/editingSupport ./CreateWorkflow ./UpdateWorkflow ../Sketch/SketchViewModel".split(" "),
function(w,f,e,z,T,g,U,A,B,V,W,X,C,D,q,E,F,G,H,I,J,K,L,M,N){function l(k,m,c){O.error(new B(k,m,c))}function P(k){return k&&K.isEditableLayer(k.layer)}function Q(k,m){return k&&k.find(c=>c.layer===m)}const O=z.getLogger("esri.widgets.Editor.EditorViewModel"),x=["create","update"];e=function(k){function m(a){a=k.call(this,a)||this;a._sketchGraphicsLayer=new F({listMode:"hide"});a.activeWorkflow=null;a.activityQueue=[];a.failures=[];a.attachmentsViewModel=new G({abilities:{editing:!0}});a.featureFormViewModel=
new I;a.featureTemplatesViewModel=new J;a.layerInfos=null;a.sketchViewModel=new N({layer:a._sketchGraphicsLayer});a.spinnerViewModel=new H;return a}w._inheritsLoose(m,k);var c=m.prototype;c.initialize=function(){this.handles.add([q.on(this,"activeWorkflow","cancel",()=>this.emit("workflow-cancel")),q.on(this,"activeWorkflow","commit",()=>this.emit("workflow-commit")),q.on(this,"view.allLayerViews","change",()=>{this.handles.remove("all-layer-views-prop-watcher");this.notifyChange("editableItems")}),
q.watch(this,"editableItems",()=>{const {activeWorkflow:a}=this;if(a){var {stepId:b}=a;"create"===a.type?(this.refreshCreationTemplates(),"awaiting-feature-creation-info"!==b||this.canCreate||this._cancelWorkflow()):"update"===a.type&&("awaiting-feature-to-update"===b&&!this.canUpdate||"awaiting-update-feature-candidate"===b&&!a.data.candidates.some(d=>{const h=this.editableItems.find(r=>r.layer===d.layer);return h&&-1<h.supports.indexOf("update")}))&&this._cancelWorkflow()}})])};c.destroy=function(){this._cancelWorkflow().then(()=>
this.view=null)};c.startCreateWorkflowAtFeatureTypeSelection=async function(){if(this.canCreate){await this._cancelWorkflow();var a=this._createCreateWorkflow();await a.start();this._set("activeWorkflow",a)}else l("editing:unsupported-workflow","Create workflow is unsupported or disabled.")};c.startCreateWorkflowAtFeatureCreation=async function(a){if(this.canCreate){await this._cancelWorkflow();var b=this._createCreateWorkflow("awaiting-feature-to-create");b.data.creationInfo=a;await b.start();this._set("activeWorkflow",
b)}else l("editing:unsupported-workflow","Update workflow is unsupported or disabled.")};c.startCreateWorkflowAtFeatureEdit=async function(a){if(this.canCreate){await this._cancelWorkflow();var b=this._createCreateWorkflow("editing-new-feature");b.data.edits.feature=a;await b.start();this._set("activeWorkflow",b)}else l("editing:unsupported-workflow","Update workflow is unsupported or disabled.")};c.startUpdateWorkflowAtFeatureSelection=async function(){if(this.canUpdate){await this._cancelWorkflow();
var a=this._createUpdateWorkflow();await a.start();this._set("activeWorkflow",a)}else l("editing:unsupported-workflow","Update workflow is unsupported or disabled.")};c.startUpdateWorkflowAtMultipleFeatureSelection=async function(a){if(this.canUpdate){await this._cancelWorkflow();var b=this._createUpdateWorkflow("awaiting-update-feature-candidate");b.data.candidates=a;await b.start();this._set("activeWorkflow",b)}else l("editing:unsupported-workflow","Update workflow is unsupported or disabled.")};
c.startUpdateWorkflowAtFeatureEdit=async function(a){if(this.canUpdate){await this._cancelWorkflow();var b=this._createUpdateWorkflow("editing-existing-feature");b.data.edits.feature=a;await b.start();this._set("activeWorkflow",b)}else l("editing:unsupported-workflow","Update workflow is unsupported or disabled.")};c.deleteFeatureFromWorkflow=async function(){const {activeWorkflow:a}=this;a&&"create"!==a.type?(await this._delete(a.data.edits.feature),await a.reset()):l("editing:unsupported-workflow",
"Deleting requires an active update workflow.")};c.cancelWorkflow=async function(a){return this._cancelWorkflow({warn:!0,...a})};c.refreshCreationTemplates=function(){this.featureTemplatesViewModel.layers=this.editableItems.filter(({supports:a})=>-1<a.indexOf("create")).map(({layer:a})=>a).toArray()};c._cancelWorkflow=async function(a){const b=this.activeWorkflow;b?a&&!1===a.force?(await b.cancel(a),this._set("activeWorkflow",null)):(this.emit("workflow-cancel"),this._set("activeWorkflow",null),await b.cancel(a)):
a&&a.warn&&l("editing:no-active-workflow","There is no active workflow to cancel.")};c._createCreateWorkflow=function(a){return L.create(this,a,b=>this._create(b))};c._createUpdateWorkflow=function(a){return M.create(this,a,b=>this._update(b))};c._create=async function(a){await this._applyEdits(a.layer,{addFeatures:[a]})};c._delete=async function(a){await this._applyEdits(a.layer,{deleteFeatures:[a]})};c._update=async function(a){await this._applyEdits(a.layer,{updateFeatures:[a]})};c._applyEdits=
async function(a,b){await this._queueOperation(()=>a.applyEdits(b));const d=await this.view.whenLayerView(a);await q.whenFalseOnce(d,"updating")};c._queueOperation=function(a){this.activityQueue.push(a);this.notifyChange("syncing");const b=(d,h)=>{d=h.indexOf(d);-1<d&&h.splice(d,1)};return a().then(({addFeatureResults:d,deleteFeatureResults:h,updateFeatureResults:r})=>{if(d=d.find(n=>!!n.error)||r.find(n=>!!n.error)||h.find(n=>!!n.error))throw d.error;}).catch(d=>{l("editing:operation-error","An error occurred.",
{error:d});const h={error:d,retry:()=>{b(h,this.failures);return this._queueOperation(a)},cancel:()=>{b(h,this.failures)}};this._set("failures",[...this.failures,h])}).then(()=>{b(a,this.activityQueue);this.notifyChange("syncing")})};w._createClass(m,[{key:"allowedWorkflows",get:function(){return this._get("allowedWorkflows")},set:function(a){a&&0!==a.length||(a=[...x]);this._set("allowedWorkflows",a)}},{key:"canCreate",get:function(){return this.editableItems.some(a=>-1<a.supports.indexOf("create"))}},
{key:"canUpdate",get:function(){return this.editableItems.some(a=>-1<a.supports.indexOf("update"))}},{key:"editableItems",get:function(){const a=this.get("view.allLayerViews");if(!a)return new D;const b=()=>this.notifyChange("editableItems");return a.filter(P).map(d=>{this.handles.add(q.watch(d,["suspended","layer.editingEnabled"],b),"all-layer-views-prop-watcher");const {layer:h,suspended:r}=d,{data:n,operations:v}=h.capabilities,p=Q(this.layerInfos,h);d="supportsAttachment"in n&&n.supportsAttachment&&
(!p||!1!==p.allowAttachments);if(r)return{hasAttachments:d,layer:h,supports:[]};const R=this.allowedWorkflows.filter(t=>p?!1!==p.enabled&&("create"===t&&!1!==p.addEnabled||"update"===t&&!1!==p.updateEnabled):!0),y=t=>R.find(S=>S===t),u=[];y("create")&&v.supportsAdd&&u.push("create");y("update")&&v.supportsUpdate&&u.push("update");!1!==(p&&p.deleteEnabled)&&v.supportsDelete&&u.push("delete");return{hasAttachments:d,layer:h,supports:u}}).reverse()}},{key:"state",get:function(){if(!this.get("view.ready")||
0===this.editableItems.length)return"disabled";var a=this.attachmentsViewModel.mode;if("add"===a)return"adding-attachment";if("edit"===a)return"editing-attachment";({activeWorkflow:a}=this);return a?a.stepId:"ready"}},{key:"syncing",get:function(){return 0<this.activityQueue.length}},{key:"view",set:function(a){this.sketchViewModel.view=a;this.spinnerViewModel.view=a;this._set("view",a)}}]);return m}(E.HandleOwnerMixin(C.EventedAccessor));f.__decorate([g.property({readOnly:!0})],e.prototype,"activeWorkflow",
void 0);f.__decorate([g.property({readOnly:!0})],e.prototype,"activityQueue",void 0);f.__decorate([g.property({value:[...x]})],e.prototype,"allowedWorkflows",null);f.__decorate([g.property({readOnly:!0,dependsOn:["editableItems"]})],e.prototype,"canCreate",null);f.__decorate([g.property({readOnly:!0,dependsOn:["editableItems"]})],e.prototype,"canUpdate",null);f.__decorate([g.property({dependsOn:["allowedWorkflows","layerInfos","view.allLayerViews","view.ready"],readOnly:!0})],e.prototype,"editableItems",
null);f.__decorate([g.property({readOnly:!0})],e.prototype,"failures",void 0);f.__decorate([g.property()],e.prototype,"attachmentsViewModel",void 0);f.__decorate([g.property()],e.prototype,"featureFormViewModel",void 0);f.__decorate([g.property()],e.prototype,"featureTemplatesViewModel",void 0);f.__decorate([g.property()],e.prototype,"layerInfos",void 0);f.__decorate([g.property()],e.prototype,"sketchViewModel",void 0);f.__decorate([g.property()],e.prototype,"spinnerViewModel",void 0);f.__decorate([g.property({dependsOn:["attachmentsViewModel.mode",
"editableItems","activeWorkflow.stepId","view.ready"]})],e.prototype,"state",null);f.__decorate([g.property({readOnly:!0})],e.prototype,"syncing",null);f.__decorate([g.property()],e.prototype,"view",null);return e=f.__decorate([A.subclass("esri.widgets.Editor.EditorViewModel")],e)});