// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/has ../../core/maybe ../../core/Logger ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/property ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../core/urlUtils ../../core/uuid ../../portal/support/resourceExtension ../../core/scheduling ../../core/watchUtils ../../core/HandleOwner ../../views/3d/environment/SceneViewLighting ../../views/3d/support/earthUtils ../../views/SceneView ./daylightUtils ./support/SliderWithDropdownViewModel ../support/DatePickerViewModel".split(" "),
function(n,d,c,t,B,C,e,D,u,E,F,G,v,l,w,x,y,z,h,p,q){c=function(r){function m(a){a=r.call(this,a)||this;a.view=null;a.datePickerViewModel=new q;a.timeSliderViewModel=new p.SliderWithDropdownViewModel;a.lightingUpdateInterval=200;a._cachedLightingDateUTC=new Date(0);a._cachedDisplayUTCOffset=0;a._enableShadowsOnFirstInteraction=!0;a._lastLightingUpdate=0;a._nextLightingUpdate=null;a.playSpeedMultiplier=1;return a}n._inheritsLoose(m,r);var k=m.prototype;k.initialize=function(){this.handles.add([l.init(this,
"view",()=>{this.view&&this.view.when(()=>this._updateLighting(null))}),l.watch(this,"view.environment.lighting.date",a=>this._scheduleUpdateLighting(a)),l.on(this,"view.environment.lighting","timezone-will-change",a=>this._timezoneWillChange(a),()=>this._timezoneWillChange(null)),l.init(this,"view.stationary",()=>{(this.dayPlaying||this.yearPlaying)&&this._updateSunriseAndSunset()}),this.watch(["timeSliderPosition","timeSliderViewModel.state"],()=>{"ready"===this.timeSliderViewModel.state&&this.timeSliderViewModel.setValue(0,
this.timeSliderPosition)}),this.timeSliderViewModel.watch("currentItem",a=>this.utcOffset=a.abbr),this.timeSliderViewModel.watch("isDropdownOpen",()=>this.stopPlaying()),this.timeSliderViewModel.watch("values",a=>this.timeSliderPosition=a[0]),this.datePickerViewModel.watch("value",a=>{this.dayPlaying=!1;this.localDate=a}),this.watch("localDate",async a=>{this.datePickerViewModel.value.valueOf()!==a.getTime()&&this.datePickerViewModel.set("value",a)})])};k.destroy=function(){this._nextLightingUpdate&&
(clearTimeout(this._nextLightingUpdate),this._nextLightingUpdate=null);this.view=null};k._timezoneFromCamera=function(a){var b;const f=null==(b=a.camera)?void 0:b.position;if(!f||!a.environment.lighting.cameraTrackingEnabled)return 0;a=t.unwrap(y.positionToTimezone([f.longitude,f.latitude]));return Math.round(a.hours+a.minutes/60+a.seconds/3600)};k.stopPlaying=function(){this.playingState="none"};k.toggleDayPlaying=function(){this.dayPlaying=!this.dayPlaying};k.toggleYearPlaying=function(){this.yearPlaying=
!this.yearPlaying};k.toggleDirectShadows=function(){this.stopPlaying();this.directShadowsEnabled=!this.directShadowsEnabled};k._updateLighting=function(a){var b,f;this._lastLightingUpdate=Date.now();var g=null==(b=this.view)?void 0:null==(f=b.environment)?void 0:f.lighting;g&&(a=a||g.date,g=g.displayUTCOffset,g=null!==g?g:this._timezoneFromCamera(this.view),this._cachedLightingDateUTC.getTime()!==a.getTime()&&(this._cachedLightingDateUTC=new Date(a.getTime())),this._cachedDisplayUTCOffset!==g&&(this._cachedDisplayUTCOffset=
g))};k._timezoneWillChange=function(a){var b,f;const g=null==(b=this.view)?void 0:null==(f=b.environment)?void 0:f.lighting;if(g&&g.cameraTrackingEnabled){if(a)a=a.timezoneOffset;else{if(null!=g.displayUTCOffset)return;a=x.calculateTimezoneOffset(g.positionTimezoneInfo)}g.displayUTCOffset=a;this._scheduleUpdateLighting(null)}};k._scheduleUpdateLighting=function(a){if(!this._nextLightingUpdate){var b=Date.now()-this._lastLightingUpdate;b=this.lightingUpdateInterval-b;0>=b?v.schedule(()=>this._updateLighting(a)):
this._nextLightingUpdate=setTimeout(()=>{this._updateLighting(null);this._nextLightingUpdate=null},b)}};k._play=function(){var a;const b=this.view;if(null!=(a=this.view)&&a.environment&&(this.dayPlaying||this.yearPlaying)){a=(new Date).getTime()-this._lastTime;if(this.dayPlaying){if(this._lastTime=(new Date).getTime(),a*=h.calculatePlaySpeed(this._sunrise,this._sunset,b.environment.lighting.date)*this.playSpeedMultiplier/100,0<a){var f=new Date(b.environment.lighting.date.getTime()+a);const g=((f.getUTCHours()+
b.environment.lighting.displayUTCOffset)%24+24)%24,A=((b.environment.lighting.date.getUTCHours()+b.environment.lighting.displayUTCOffset)%24+24)%24;g<A&&(f=new Date(b.environment.lighting.date.getTime()+a-864E5));b.environment.lighting.date=f}}else 1E3<a&&(this._lastTime=(new Date).getTime(),a=(b.environment.lighting.date.getUTCMonth()+1)%12,f=new Date(b.environment.lighting.date.getTime()),f.setUTCMonth(a),b.environment.lighting.date=f);requestAnimationFrame(()=>this._play())}};k._updateSunriseAndSunset=
function(){const a=h.getSunriseAndSunsetTimes(this.view.environment.lighting.date,this.view.camera.position.latitude,this.view.camera.position.longitude,this.view.environment.lighting.displayUTCOffset);this._sunrise=new Date(a.sunrise);this._sunset=new Date(a.sunset)};n._createClass(m,[{key:"isSupported",get:function(){return!this.view||"3d"===this.view.type}},{key:"utcOffset",get:function(){return this._cachedDisplayUTCOffset},set:function(a){a!==this.utcOffset&&(this.view.environment.lighting.displayUTCOffset=
a,this._updateLighting(null))}},{key:"localDate",get:function(){return h.dateTimeToLocalDate(this._lightingDateDisplay)},set:function(a){a.getTime()!==this.localDate.getTime()&&(this._lightingDateDisplay=h.localDateToDateTime(this._lightingDateDisplay,a))}},{key:"timeSliderPosition",get:function(){return h.dateTimeToSliderPos(this._lightingDateDisplay)},set:function(a){Math.abs(a-this.timeSliderPosition)>1/60&&(this._lightingDateDisplay=h.sliderPosToDateTime(this._lightingDateDisplay,a),this.stopPlaying(),
this._enableShadowsOnFirstInteraction&&(this.directShadowsEnabled=!0,this._enableShadowsOnFirstInteraction=!1))}},{key:"_lightingDateDisplay",get:function(){return h.dateAddHours(this._cachedLightingDateUTC,this._cachedDisplayUTCOffset)},set:function(a){a=h.dateAddHours(a,-this._cachedDisplayUTCOffset);a.getTime()!==this.view.environment.lighting.date.getTime()&&(this.view.environment.lighting.date=a,this._updateLighting(null))}},{key:"playingState",set:function(a){this.playingState!==a&&(this._set("playingState",
a),"none"!==a&&(this._updateSunriseAndSunset(),this._lastTime=(new Date).getTime(),this._play(),this._enableShadowsOnFirstInteraction&&(this.directShadowsEnabled=!0,this._enableShadowsOnFirstInteraction=!1)))}},{key:"dayPlaying",get:function(){return"day"===this.playingState},set:function(a){a?this.playingState="day":this.dayPlaying&&(this.playingState="none")}},{key:"yearPlaying",get:function(){return"year"===this.playingState},set:function(a){a?this.playingState="year":this.yearPlaying&&(this.playingState=
"none")}},{key:"currentSeason",get:function(){return h.getSeasonFromDate(this.localDate,this._currentHemisphere)},set:function(a){this.stopPlaying();a=h.getNorthernHemisphereSeason(a,this._currentHemisphere);this.localDate=h.getSeasonDate(this.localDate,a,h.Hemisphere.NORTHERN)}},{key:"_currentHemisphere",get:function(){var a,b;const f=null==(a=this.view)?void 0:null==(b=a.camera)?void 0:b.position;return f?0<=f.latitude?h.Hemisphere.NORTHERN:h.Hemisphere.SOUTHERN:h.Hemisphere.NORTHERN}}]);return m}(w.HandleOwner);
d.__decorate([e.property({type:z})],c.prototype,"view",void 0);d.__decorate([e.property({type:q})],c.prototype,"datePickerViewModel",void 0);d.__decorate([e.property({type:p.SliderWithDropdownViewModel})],c.prototype,"timeSliderViewModel",void 0);d.__decorate([e.property({dependsOn:["view.type"]})],c.prototype,"isSupported",null);d.__decorate([e.property()],c.prototype,"lightingUpdateInterval",void 0);d.__decorate([e.property()],c.prototype,"_cachedLightingDateUTC",void 0);d.__decorate([e.property()],
c.prototype,"_cachedDisplayUTCOffset",void 0);d.__decorate([e.property()],c.prototype,"_enableShadowsOnFirstInteraction",void 0);d.__decorate([e.property({dependsOn:["_cachedDisplayUTCOffset"]})],c.prototype,"utcOffset",null);d.__decorate([e.property({dependsOn:["_lightingDateDisplay"]})],c.prototype,"localDate",null);d.__decorate([e.property({dependsOn:["_lightingDateDisplay"]})],c.prototype,"timeSliderPosition",null);d.__decorate([e.property({dependsOn:["_cachedDisplayUTCOffset","_cachedLightingDateUTC"]})],
c.prototype,"_lightingDateDisplay",null);d.__decorate([e.property({aliasOf:"view.environment.lighting.directShadowsEnabled"})],c.prototype,"directShadowsEnabled",void 0);d.__decorate([e.property({type:["none","day","year"],value:"none"})],c.prototype,"playingState",null);d.__decorate([e.property({dependsOn:["playingState"]})],c.prototype,"dayPlaying",null);d.__decorate([e.property({dependsOn:["playingState"]})],c.prototype,"yearPlaying",null);d.__decorate([e.property()],c.prototype,"playSpeedMultiplier",
void 0);d.__decorate([e.property({dependsOn:["localDate","_currentHemisphere"]})],c.prototype,"currentSeason",null);d.__decorate([e.property()],c.prototype,"_lastTime",void 0);d.__decorate([e.property()],c.prototype,"_sunrise",void 0);d.__decorate([e.property()],c.prototype,"_sunset",void 0);d.__decorate([e.property({readOnly:!0,dependsOn:["view.camera.position.latitude"]})],c.prototype,"_currentHemisphere",null);return c=d.__decorate([u.subclass("esri.widgets.Daylight.DaylightViewModel")],c)});