// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../core/string ../../core/Logger ../../core/promiseUtils ../../support/arcadeOnDemand ../../Color ../../core/screenUtils ./utils ../../views/2d/arcade/callExpressionWithFeature ./CIMSymbolHelper ./SDFHelper".split(" "),function(J,v,Y,Z,K,aa,ba,A,P,y,Q){function L(a){switch(a){case "Butt":return 0;case "Square":return 2;default:return 1}}function M(a){switch(a){case "Bevel":return 0;case "Miter":return 2;default:return 1}}function ca(a){switch(a){default:return"left";case "Right":return"right";
case "Center":return"center";case "Justify":return"justify"}}function da(a){switch(a){default:return"top";case "Center":return"middle";case "Baseline":return"baseline";case "Bottom":return"bottom"}}function ea(a){let c="normal",f="normal";a&&(a=a.toLowerCase(),-1!==a.indexOf("italic")?c="italic":-1!==a.indexOf("oblique")&&(c="oblique"),-1!==a.indexOf("bold")?f="bold":-1!==a.indexOf("light")&&(f="lighter"));return{style:c,weight:f}}function R(a,c,f,b){let e;a[c]?e=a[c]:(e={},a[c]=e);e[f]=b}function S(a){return(a=
a.markerPlacement)&&a.angleToLine?1:0}function fa(a,c,f,b,e,k){if(a){var n=a.symbolLayers;if(n){var g,h=y.CIMSymbolHelper.getSize(a);"CIMPointSymbol"===a.type&&"Map"===a.angleAlignment&&(g=1);for(var q=n.length;q--;){var d=n[q];if(d&&!1!==d.enable){var p=[];y.OverrideHelper.findApplicableOverrides(d,c,p);switch(d.type){case "CIMSolidFill":ha(d,f,p,b,e);break;case "CIMPictureFill":ia(d,f,p,b,e);break;case "CIMHatchFill":ja(d,f,p,b,e);break;case "CIMGradientFill":var m=f,r=b,t=e,w=v.numericHash(JSON.stringify(d)).toString();
t.push({type:"fill",templateHash:w,materialHash:0===p.length?w:G(w,m,p,r),cim:d,materialOverrides:null,colorLocked:d.colorLocked,effects:d.effects,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1});break;case "CIMSolidStroke":ka(d,f,p,b,e,"CIMPolygonSymbol"===a.type,h);break;case "CIMPictureStroke":la(d,f,p,b,e,"CIMPolygonSymbol"===a.type,h);break;case "CIMGradientStroke":{m=f;r=b;t=e;w="CIMPolygonSymbol"===a.type;var z=h,u=d.primitiveName,x=void 0!==d.width?d.width:4,C=
L(d.capStyle),F=M(d.joinStyle);const B=d.miterLimit,H=v.numericHash(JSON.stringify(d)).toString();t.push({type:"line",templateHash:H,materialHash:0===p.length?H:G(H,m,p,r),cim:d,materialOverrides:null,isOutline:w,colorLocked:d.colorLocked,effects:d.effects,color:{r:128,g:128,b:128,a:1},width:l(u,m,"Width",r,x),cap:l(u,m,"CapStyle",r,C),join:l(u,m,"JoinStyle",r,F),miterLimit:l(u,m,"MiterLimit",r,B),referenceWidth:z,zOrder:N(d.name),isDashed:!1})}break;case "CIMCharacterMarker":O(d,f,p,b,e);break;case "CIMPictureMarker":if(O(d,
f,p,b,e))break;"CIMLineSymbol"===a.type&&(g=S(d));ma(d,f,p,b,e,g,h);break;case "CIMVectorMarker":if(O(d,f,p,b,e))break;"CIMLineSymbol"===a.type&&(g=S(d));m=f;r=b;t=e;w=g;z=h;u=k;if(C=d.markerGraphics){x=0;d.scaleSymbolsProportionally&&(F=d.frame)&&(x=F.ymax-F.ymin);for(const B of C)if(B&&(C=B.symbol))switch(C.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":na(d,B,p,m,r,t,w,z,x,u);break;case "CIMTextSymbol":oa(d,B,m,p,r,t,w,z,x)}}break;default:T.error("Cannot analyze CIM layer",
d.type)}}}}}}function ha(a,c,f,b,e){const k=a.primitiveName,n=A.fromCIMColor(a.color),g=v.numericHash(JSON.stringify(a)).toString();e.push({type:"fill",templateHash:g,materialHash:0===f.length?g:()=>g,cim:a,materialOverrides:null,colorLocked:a.colorLocked,color:l(k,c,"Color",b,n,D),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:a.effects})}function ia(a,c,f,b,e){const k=a.primitiveName,n=a.tintColor?A.fromCIMColor(a.tintColor):{r:255,g:255,b:255,a:1},g=v.numericHash(JSON.stringify(a)).toString(),
h=v.numericHash(`${a.url}${JSON.stringify(a.colorSubstitutions)}`).toString();e.push({type:"fill",templateHash:g,materialHash:0===f.length?h:()=>h,cim:a,materialOverrides:null,colorLocked:a.colorLocked,effects:a.effects,color:l(k,c,"TintColor",b,n,D),height:l(k,c,"Height",b,a.height),scaleX:l(k,c,"ScaleX",b,a.scaleX),angle:l(k,c,"Rotation",b,a.rotation),offsetX:l(k,c,"OffsetX",b,a.offsetX),offsetY:l(k,c,"OffsetY",b,a.offsetY)})}function ja(a,c,f,b,e){const k=["Rotation","OffsetX","OffsetY"],n=f.filter(d=>
d.primitiveName!==a.primitiveName&&-1===k.indexOf(d.propertyName)),g=a.primitiveName,h=v.numericHash(JSON.stringify(a)).toString(),q=v.numericHash(`${a.separation}${JSON.stringify(a.lineSymbol)}`).toString();e.push({type:"fill",templateHash:h,materialHash:0===f.length?q:G(q,c,n,b),cim:a,materialOverrides:n,colorLocked:a.colorLocked,effects:a.effects,color:{r:255,g:255,b:255,a:1},height:l(g,c,"Separation",b,a.separation),scaleX:1,angle:l(g,c,"Rotation",b,a.rotation),offsetX:l(g,c,"OffsetX",b,a.offsetX),
offsetY:l(g,c,"OffsetY",b,a.offsetY)})}function ka(a,c,f,b,e,k,n){const g=v.numericHash(JSON.stringify(a)).toString(),h=a.primitiveName,q=A.fromCIMColor(a.color),d=void 0!==a.width?a.width:4,p=L(a.capStyle),m=M(a.joinStyle),r=a.miterLimit;e.push({type:"line",templateHash:g,materialHash:0===f.length?g:()=>g,cim:a,materialOverrides:null,isOutline:k,colorLocked:a.colorLocked,effects:a.effects,color:l(h,c,"Color",b,q,D),width:l(h,c,"Width",b,d),cap:l(h,c,"CapStyle",b,p),join:l(h,c,"JoinStyle",b,m),miterLimit:l(h,
c,"MiterLimit",b,r),referenceWidth:n,zOrder:N(a.name),isDashed:!1})}function la(a,c,f,b,e,k,n){const g=v.numericHash(`${a.url}${JSON.stringify(a.colorSubstitutions)}`).toString(),h=a.primitiveName,q=A.fromCIMColor(a.tintColor),d=void 0!==a.width?a.width:4,p=L(a.capStyle),m=M(a.joinStyle),r=a.miterLimit,t=v.numericHash(JSON.stringify(a)).toString();e.push({type:"line",templateHash:t,materialHash:0===f.length?g:()=>g,cim:a,materialOverrides:null,isOutline:k,colorLocked:a.colorLocked,effects:a.effects,
color:l(h,c,"TintColor",b,q,D),width:l(h,c,"Width",b,d),cap:l(h,c,"CapStyle",b,p),join:l(h,c,"JoinStyle",b,m),miterLimit:l(h,c,"MiterLimit",b,r),referenceWidth:n,zOrder:N(a.name),isDashed:!1})}function O(a,c,f,b,e){const k=a.markerPlacement;if(!k||"CIMMarkerPlacementInsidePolygon"!==k.type)return!1;const n=["Rotation","OffsetX","OffsetY"],g=f.filter(q=>q.primitiveName!==a.primitiveName&&-1===n.indexOf(q.propertyName)),h=v.numericHash(JSON.stringify(a)).toString();e.push({type:"fill",templateHash:h,
materialHash:0===f.length?h:G(h,c,g,b),cim:a,materialOverrides:g,colorLocked:a.colorLocked,effects:a.effects,color:{r:255,g:255,b:255,a:1},height:l(k.primitiveName,c,"StepY",b,k.stepY),scaleX:1,angle:l(k.primitiveName,c,"GridAngle",b,k.gridAngle),offsetX:l(k.primitiveName,c,"OffsetX",b,k.offsetX),offsetY:l(k.primitiveName,c,"OffsetY",b,k.offsetY)});return!0}function ma(a,c,f,b,e,k,n){const g=a.primitiveName,h=a.size,q=a.scaleX,d=a.rotation,p=a.offsetX,m=a.offsetY,r=A.fromCIMColor(a.tintColor),t=v.numericHash(`${a.url}${JSON.stringify(a.colorSubstitutions)}`).toString();
let w=!1,z="";for(const u of f)u.primitiveName===g&&(void 0!==u.value?z+=`-${u.primitiveName}-${u.propertyName}-${JSON.stringify(u.value)}`:u.valueExpressionInfo&&(w=!0));e.push({type:"marker",templateHash:v.numericHash(JSON.stringify(a)+z).toString(),materialHash:w?()=>t:t,cim:a,materialOverrides:null,colorLocked:a.colorLocked,effects:a.effects,scaleSymbolsProportionally:!1,alignment:k,size:l(g,c,"Size",b,h),scaleX:l(g,c,"ScaleX",b,q),rotation:l(g,c,"Rotation",b,d),offsetX:l(g,c,"OffsetX",b,p),offsetY:l(g,
c,"OffsetY",b,m),color:l(g,c,"TintColor",b,r,D),anchorPoint:a.anchorPoint,isAbsoluteAnchorPoint:"Relative"!==a.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:a.rotateClockwise,referenceSize:n,sizeRatio:1,markerPlacement:a.markerPlacement})}function oa(a,c,f,b,e,k,n,g,h){y.OverrideHelper.findApplicableOverrides(c,b,[]);var q=c.geometry;if("x"in q&&"y"in q){var d=c.symbol;var p=d.underline?"underline":d.strikethrough?"line-through":"none";var m=ea(d.fontStyleName);
d.font={family:d.fontFamilyName,decoration:p,...m};var r=a.frame,t=a.size/h;h=a.primitiveName;p=(d.height||0)*t;m=d.angle||0;var w=((d.offsetX||0)+(q.x-.5*(r.xmin+r.xmax)))*t;q=((d.offsetY||0)+(q.y-.5*(r.ymin+r.ymax)))*t;r=A.fromCIMColor(y.CIMSymbolHelper.getFillColor(d));var z=A.fromCIMColor(y.CIMSymbolHelper.getStrokeColor(d)),u=y.CIMSymbolHelper.getStrokeWidth(d);u||(z=A.fromCIMColor(y.CIMSymbolHelper.getFillColor(d.haloSymbol)),u=d.haloSize*t);t="";for(const x of b)x.primitiveName===h&&void 0!==
x.value&&(t+=`-${x.primitiveName}-${x.propertyName}-${JSON.stringify(x.value)}`);b=JSON.stringify(a.effects)+Number(a.colorLocked)+JSON.stringify(a.anchorPoint)+a.anchorPointUnits+JSON.stringify(a.markerPlacement);b=v.numericHash(JSON.stringify(c)+b+t).toString();k.push({type:"text",templateHash:b,materialHash:()=>v.numericHash(JSON.stringify(d.font)).toString(),cim:d,materialOverrides:null,colorLocked:a.colorLocked,effects:a.effects,alignment:n,anchorPoint:{x:a.anchorPoint?a.anchorPoint.x:0,y:a.anchorPoint?
a.anchorPoint.y:0},isAbsoluteAnchorPoint:"Relative"!==a.anchorPointUnits,fontName:d.fontFamilyName,decoration:"none",weight:"normal",style:"normal",size:l(h,f,"Size",e,p),angle:l(h,f,"Rotation",e,m),offsetX:l(h,f,"OffsetX",e,w),offsetY:l(h,f,"OffsetY",e,q),horizontalAlignment:ca(d.horizontalAlignment),verticalAlignment:da(d.verticalAlignment),text:l(c.primitiveName,f,"TextString",e,c.textString,A._adjustTextCase,d.textCase),color:r,outlineColor:z,outlineSize:u,referenceSize:g,sizeRatio:1,markerPlacement:a.markerPlacement})}}
function na(a,c,f,b,e,k,n,g,h,q){const d=c.geometry;if(d){var p=c.symbol.symbolLayers;if(p)if(q)U(a,c,b,f,e,k,n,g,h);else for(q=p.length;q--;){var m=p[q];if(m&&!1!==m.enable)switch(m.type){case "CIMSolidFill":case "CIMSolidStroke":{var r=Q.getExtent(d);if(!r)continue;const [z,u,x]=Q.getSDFMetrics(r,a.frame,a.size,a.anchorPoint,"Relative"!==a.anchorPointUnits);var t="CIMSolidFill"===m.type;r={type:"sdf",geom:d,asFill:t};var w=a.primitiveName;const C=a.size,F=a.rotation||0,B=a.offsetX,H=a.offsetY,I=
m.primitiveName,pa=t?A.fromCIMColor(y.CIMSymbolHelper.getFillColor(m)):A.fromCIMColor(y.CIMSymbolHelper.getStrokeColor(m)),qa=t?{r:0,g:0,b:0,a:0}:A.fromCIMColor(y.CIMSymbolHelper.getStrokeColor(m)),V=y.CIMSymbolHelper.getStrokeWidth(m);if(!t&&!V)break;t=!1;let W="";for(const E of f)if(E.primitiveName===I||E.primitiveName===w)void 0!==E.value?W+=`-${E.primitiveName}-${E.propertyName}-${JSON.stringify(E.value)}`:E.valueExpressionInfo&&(t=!0);w=JSON.stringify({...a,markerGraphics:null});const X=v.numericHash(JSON.stringify(r)).toString();
m={type:"marker",templateHash:v.numericHash(JSON.stringify(c)+JSON.stringify(m)+w+W).toString(),materialHash:t?()=>X:X,cim:r,materialOverrides:null,colorLocked:a.colorLocked,effects:a.effects,scaleSymbolsProportionally:a.scaleSymbolsProportionally,alignment:n,anchorPoint:{x:u,y:x},isAbsoluteAnchorPoint:!1,size:l(a.primitiveName,b,"Size",e,C),rotation:l(a.primitiveName,b,"Rotation",e,F),offsetX:l(a.primitiveName,b,"OffsetX",e,B),offsetY:l(a.primitiveName,b,"OffsetY",e,H),scaleX:1,frameHeight:h,rotateClockwise:a.rotateClockwise,
referenceSize:g,sizeRatio:z,color:l(I,b,"Color",e,pa,D),outlineColor:l(I,b,"Color",e,qa,D),outlineWidth:l(I,b,"Width",e,V),markerPlacement:a.markerPlacement};k.push(m);break}default:U(a,c,b,f,e,k,n,g,h)}}}}function U(a,c,f,b,e,k,n,g,h){c={type:a.type,enable:!0,name:a.name,colorLocked:a.colorLocked,primitiveName:a.primitiveName,anchorPoint:a.anchorPoint,anchorPointUnits:a.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:a.rotateClockwise,rotation:0,size:a.size,billboardMode3D:a.billboardMode3D,
depth3D:a.depth3D,frame:a.frame,markerGraphics:[c],scaleSymbolsProportionally:a.scaleSymbolsProportionally,respectFrame:a.respectFrame,clippingPath:a.clippingPath,effects:a.effects};let q=[];const d=["Rotation","OffsetX","OffsetY"];q=b.filter(x=>x.primitiveName!==a.primitiveName||-1===d.indexOf(x.propertyName));var p="";for(var m of b)void 0!==m.value&&(p+=`-${m.primitiveName}-${m.propertyName}-${JSON.stringify(m.value)}`);const [r,t,w]=y.CIMSymbolHelper.getTextureAnchor(c);b=a.primitiveName;m=a.rotation||
0;const z=a.offsetX||0,u=a.offsetY||0;p=v.numericHash(JSON.stringify(c)+p).toString();f={type:"marker",templateHash:p,materialHash:0===q.length?p:G(p,f,q,e),cim:c,materialOverrides:q,colorLocked:a.colorLocked,effects:a.effects,scaleSymbolsProportionally:a.scaleSymbolsProportionally,alignment:n,anchorPoint:{x:r,y:t},isAbsoluteAnchorPoint:!1,size:a.size,rotation:l(b,f,"Rotation",e,m),offsetX:l(b,f,"OffsetX",e,z),offsetY:l(b,f,"OffsetY",e,u),color:{r:0,g:0,b:0,a:0},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,
scaleX:1,frameHeight:h,rotateClockwise:a.rotateClockwise,referenceSize:g,sizeRatio:w/ba.pt2px(a.size),markerPlacement:a.markerPlacement};k.push(f)}function N(a){return a&&0===a.indexOf("Level_")?parseInt(a.substr(6),10):0}function D(a){if(!a||0===a.length)return null;a=(new aa(a)).toRgba();return{r:a[0],g:a[1],b:a[2],a:a[3]}}function l(a,c,f,b,e,k,n){if(a=c[a]){const g=a[f];if("string"===typeof g||"number"===typeof g||g instanceof Array)return k?k.call(null,g,n):g;if(null!=g&&g instanceof K.ArcadeExpression)return(h,
q,d)=>{h=P(g,h,{$view:d},b.geometryType,q);null!==h&&k&&(h=k.call(null,h,n));return null!==h?h:e}}return e}function G(a,c,f,b){for(const e of f)if(e.valueExpressionInfo){const k=c[e.primitiveName]&&c[e.primitiveName][e.propertyName];k instanceof K.ArcadeExpression&&(e.fn=(n,g,h)=>P(k,n,{$view:h},b.geometryType,g))}return(e,k,n)=>{for(const g of f)g.fn&&(g.value=g.fn(e,k,n));return v.numericHash(a+y.OverrideHelper.buildOverrideKey(f)).toString()}}const T=Y.getLogger("esri.symbols.cim.cimAnalyzer");
J.analyzeCIMResource=function(a,c){if(!c||0===c.length)return a;a=JSON.parse(JSON.stringify(a));y.OverrideHelper.applyOverrides(a,c);return a};J.analyzeCIMSymbol=async function(a,c,f,b){f=f?f:[];if(!a)return f;let e;const k={};if("CIMSymbolReference"===a.type){if(e=a.symbol,a=a.primitiveOverrides){const g=[];for(const h of a){var n=h.valueExpressionInfo;n&&c?(n=K.createRendererExpression(n.expression,c.spatialReference,c.fields).then(q=>{q&&R(k,h.primitiveName,h.propertyName,q)}),g.push(n)):null!=
h.value&&R(k,h.primitiveName,h.propertyName,h.value)}await Z.all(g)}}else return T.error("Expect cim type to be 'CIMSymbolReference'"),f;switch(e.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":fa(e,a,k,c,f,b)}return f};Object.defineProperty(J,"__esModule",{value:!0})});