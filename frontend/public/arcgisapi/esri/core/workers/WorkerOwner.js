// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../Logger ../Error ../promiseUtils ../../kernel ./utils ./workerFactory".split(" "),function(t,u,k,v,h,w){const x=t.getLogger("esri.core.workers"),{ABORT:r,INVOKE:y,OPEN:z,OPENED:A,RESPONSE:l}=h.MessageType;return function(){function p(a,c){this._outJobs=new Map;this._inJobs=new Map;this.worker=a;this.id=c;a.addEventListener("message",this._onMessage.bind(this));a.addEventListener("error",b=>{b.preventDefault();x.error(b)})}p.create=async function(a){const c=await w.createWorker();return new p(c,
a)};var e=p.prototype;e.terminate=function(){this.worker.terminate()};e.open=async function(a,c={}){const {signal:b}=c,d=h.newJobId();return k.create((m,g)=>{const q=k.onAbortOrThrow(b,()=>{this._outJobs.delete(d);this._post({type:r,jobId:d})});this._outJobs.set(d,{resolve:m,reject:g,abortHandle:q});this._post({type:z,jobId:d,modulePath:a})})};e._onMessage=function(a){if(a=h.receiveMessage(a))switch(a.type){case A:this._onOpenedMessage(a);break;case l:this._onResponseMessage(a);break;case r:this._onAbortMessage(a);
break;case y:this._onInvokeMessage(a)}};e._onAbortMessage=function(a){const c=this._inJobs;a=a.jobId;const b=c.get(a);b&&(b.controller&&b.controller.abort(),c.delete(a))};e._onInvokeMessage=function(a){const {methodName:c,jobId:b,data:d,abortable:m}=a;a=m?k.createAbortController():null;const g=this._inJobs,q=v.workerMessages[c];let n;try{if("function"!==typeof q)throw new TypeError(`${c} is not a function`);n=q.call(null,d,{signal:a?a.signal:null})}catch(f){this._post({type:l,jobId:b,error:h.toInvokeError(f)});
return}k.isPromiseLike(n)?(g.set(b,{controller:a,promise:n}),n.then(f=>{g.has(b)&&(g.delete(b),this._post({type:l,jobId:b},f))},f=>{g.has(b)&&(g.delete(b),f||(f={message:"Error encountered at method"+c}),k.isAbortError(f)||this._post({type:l,jobId:b,error:h.toInvokeError(f||{message:`Error encountered at method ${c}`})}))})):this._post({type:l,jobId:b},n)};e._onOpenedMessage=function(a){var c;const {jobId:b,data:d}=a;if(a=this._outJobs.get(b))this._outJobs.delete(b),null==(c=a.abortHandle)?void 0:
c.remove(),a.resolve(d)};e._onResponseMessage=function(a){var c;const {jobId:b,error:d,data:m}=a;if(a=this._outJobs.get(b))this._outJobs.delete(b),null==(c=a.abortHandle)?void 0:c.remove(),d?a.reject(u.fromJSON(JSON.parse(d))):a.resolve(m)};e._post=function(a,c,b){return h.postMessage(this.worker,a,c,b)};return p}()});