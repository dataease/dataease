// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../core/compilerUtils ../../../core/maybe ../../../core/Logger ../../../Color ../../../Graphic ./sizeVariableUtils ../../support/lengthUtils".split(" "),function(p,E,m,F,x,G,r,H){function y(a,b,c){if(a="visualVariables"in a&&a.visualVariables?a.visualVariables.filter(t=>"color"===t.type)[0]:a)if("esri.renderers.visualVariables.ColorVariable"!==a.declaredClass)q.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");else{var d="number"===
typeof b,e=d?null:b,f=e&&e.attributes,g=d?b:null,l=a.field,{ipData:h,hasExpression:k}=a.cache;b=a.cache.compiledFunc;if(!l&&!k)return(c=a.stops)&&c[0]&&c[0].color;if("number"!==typeof g)if(k){if(!m.isSome(c)||!m.isSome(c.arcade)){q.error("Use of arcade expressions requires an arcade context");return}g=c.arcade.arcadeUtils;l=g.getViewInfo({viewingMode:c.viewingMode,scale:c.scale,spatialReference:c.spatialReference});e=g.createExecContext(e,l);b||(b=g.createSyntaxTree(a.valueExpression),b=g.createFunction(b),
a.cache.compiledFunc=b);g=g.executeFunction(b,e)}else f&&(g=f[l]);e=a.normalizationField;f=f?parseFloat(f[e]):void 0;if(null!=g&&(!e||d||!isNaN(f)&&0!==f)&&(isNaN(f)||d||(g/=f),d=w(g,h)))return f=d[0],e=d[1],c=f===e?a.stops[f].color:x.blendColors(a.stops[f].color,a.stops[e].color,d[2],m.isSome(c)?c.color:void 0),new x(c)}}function z(a,b,c){if(a="visualVariables"in a&&a.visualVariables?a.visualVariables.filter(t=>"opacity"===t.type)[0]:a)if("esri.renderers.visualVariables.OpacityVariable"!==a.declaredClass)q.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");
else{var d="number"===typeof b,e=d?null:b,f=e&&e.attributes,g=d?b:null,l=a.field,{ipData:h,hasExpression:k}=a.cache;b=a.cache.compiledFunc;if(!l&&!k)return(a=a.stops)&&a[0]&&a[0].opacity;if("number"!==typeof g)if(k){if(m.isNone(c)||m.isNone(c.arcade)){q.error("Use of arcade expressions requires an arcade context");return}g=c.arcade.arcadeUtils;c=g.getViewInfo({viewingMode:c.viewingMode,scale:c.scale,spatialReference:c.spatialReference});c=g.createExecContext(e,c);b||(e=g.createSyntaxTree(a.valueExpression),
b=g.createFunction(e),a.cache.compiledFunc=b);g=g.executeFunction(b,c)}else f&&(g=f[l]);c=a.normalizationField;f=f?parseFloat(f[c]):void 0;if(null!=g&&(!c||d||!isNaN(f)&&0!==f)&&(isNaN(f)||d||(g/=f),d=w(g,h))){c=d[0];f=d[1];if(c===f)return a.stops[c].opacity;c=a.stops[c].opacity;return c+(a.stops[f].opacity-c)*d[2]}}}function A(a,b,c){if(a="visualVariables"in a&&a.visualVariables?a.visualVariables.filter(t=>"rotation"===t.type)[0]:a)if("esri.renderers.visualVariables.RotationVariable"!==a.declaredClass)q.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");
else{var d=a.axis||"heading",e="heading"===d&&"arithmetic"===a.rotationType?90:0;d="heading"===d&&"arithmetic"===a.rotationType?-1:1;var f="number"===typeof b?null:b,g=f&&f.attributes,l=a.field,{hasExpression:h}=a.cache;b=a.cache.compiledFunc;var k=0;if(!l&&!h)return k;if(h){if(m.isNone(c)||m.isNone(c.arcade)){q.error("Use of arcade expressions requires an arcade context");return}g=c.arcade.arcadeUtils;c=g.getViewInfo({viewingMode:c.viewingMode,scale:c.scale,spatialReference:c.spatialReference});
c=g.createExecContext(f,c);b||(b=g.createSyntaxTree(a.valueExpression),b=g.createFunction(b),a.cache.compiledFunc=b);k=g.executeFunction(b,c)}else g&&(k=g[l]||0);return k="number"!==typeof k||isNaN(k)?null:e+d*k}}function I(a,b,c){const d="number"===typeof b;var e=d?null:b;const f=e&&e.attributes;var g=d?b:null;const {isScaleDriven:l}=a.cache;b=a.cache.compiledFunc;if(l)e=m.isSome(c)?c.scale:void 0,c=m.isSome(c)?c.view:void 0,null==e||"3d"===c?(e=c=null,(e=a.stops)?(c=e[0].value,e=e[e.length-1].value):
(c=a.minDataValue||0,e=a.maxDataValue||0),c=(c+e)/2):c=e,g=c;else if(!d)switch(a.inputValueType){case "expression":if(m.isNone(c)||m.isNone(c.arcade)){q.error("Use of arcade expressions requires an arcade context");return}g=c.arcade.arcadeUtils;c=g.getViewInfo({viewingMode:c.viewingMode,scale:c.scale,spatialReference:c.spatialReference});c=g.createExecContext(e,c);b||(e=g.createSyntaxTree(a.valueExpression),b=g.createFunction(e),a.cache.compiledFunc=b);g=g.executeFunction(b,c);break;case "field":f&&
(g=f[a.field]);break;case "unknown":g=null}if(!r.isValidNumber(g))return null;if(d||!a.normalizationField)return g;a=f?parseFloat(f[a.normalizationField]):null;return r.isValidNumber(a)&&0!==a?g/a:null}function u(a,b,c){if(a="visualVariables"in a&&a.visualVariables?a.visualVariables.filter(e=>"size"===e.type)[0]:a)if("esri.renderers.visualVariables.SizeVariable"!==a.declaredClass)q.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");else{var d=I(a,b,c);
b=B(d,a,b,c,a.cache.ipData);return null===b||void 0===b||isNaN(b)?0:b}}function n(a,b,c){return null==a?null:r.isSizeVariable(a)?u(a,b,c):r.isValidNumber(a)?a:null}function C(a,b,c){return r.isValidNumber(c)&&a>c?c:r.isValidNumber(b)&&a<b?b:a}function B(a,b,c,d,e){switch(b.transformationType){case "additive":return d=n(b.minSize,c,d),b=a+(d||b.minDataValue);case "constant":return a=(a=b.stops)&&a.length&&a[0].size,null==a&&(a=b.minSize),b=n(a,c,d);case "clamped-linear":e=(a-b.minDataValue)/(b.maxDataValue-
b.minDataValue);var f=n(b.minSize,c,d);c=n(b.maxSize,c,d);d=m.isSome(d)?d.shape:void 0;a<=b.minDataValue?b=f:a>=b.maxDataValue?b=c:"area"===b.scaleBy&&d?(a=(b="circle"===d)?v*Math.pow(f/2,2):f*f,a+=e*((b?v*Math.pow(c/2,2):c*c)-a),b=b?2*Math.sqrt(a/v):Math.sqrt(a)):b=f+e*(c-f);return b;case "proportional":return e=m.isSome(d)?d.shape:void 0,a/=b.minDataValue,f=n(b.minSize,c,d),b=n(b.maxSize,c,d),d=null,d="circle"===e?2*Math.sqrt(a*Math.pow(f/2,2)):"square"===e||"diamond"===e||"image"===e?Math.sqrt(a*
Math.pow(f,2)):a*f,b=C(d,f,b);case "stops":{const [g,l,h]=w(a,e);g===l?b=n(b.stops[g].size,c,d):(a=n(b.stops[g].size,c,d),b=n(b.stops[l].size,c,d),b=a+(b-a)*h)}return b;case "real-world-size":return e=(m.isSome(d)&&d.resolution?d.resolution:1)*H.meterIn[b.valueUnit],f=n(b.minSize,c,d),d=n(b.maxSize,c,d),{valueRepresentation:b}=b,c=null,c="area"===b?2*Math.sqrt(a/v)/e:"radius"===b||"distance"===b?2*a/e:a/e,b=C(c,f,d);case "identity":return a;case "unknown":return null}}function w(a,b){if(b){var c=
0,d=b.length-1;b.some((e,f)=>{if(a<e)return d=f,!0;c=f;return!1});return[c,d,(a-b[c])/(b[d]-b[c])]}}const q=F.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),D=new G,v=Math.PI;p.getAllSizes=function(a,b,c){const d=["proportional","proportional","proportional"];for(const e of a)switch(a=e.useSymbolValue?"symbol-value":u(e,b,c),e.axis){case "width":d[0]=a;break;case "depth":d[1]=a;break;case "height":d[2]=a;break;case "width-and-depth":d[0]=a;d[1]=a;break;case "all":case void 0:case null:d[0]=
a;d[1]=a;d[2]=a;break;default:E.neverReached(e.axis)}return d};p.getColor=y;p.getOpacity=z;p.getRotationAngle=A;p.getSize=u;p.getSizeForValue=B;p.getSizeFromNumberOrVariable=n;p.getSizeRangeAtScale=function(a,b,c){const {isScaleDriven:d}=a.cache;if(!(d&&"3d"===c||b))return null;c={scale:b,view:c};b=n(a.minSize,D,c);a=n(a.maxSize,D,c);if(null!=b||null!=a)return b>a&&(c=a,a=b,b=c),{minSize:b,maxSize:a}};p.getVisualVariableValues=function(a,b,c){if(a.visualVariables){var d=[],e=[],f=[],g=[],l=[];for(const h of a.visualVariables)switch(h.type){case "color":e.push(h);
break;case "opacity":f.push(h);break;case "rotation":l.push(h);break;case "size":g.push(h)}e.forEach(h=>{const k=y(h,b,c);d.push({variable:h,value:k})});f.forEach(h=>{const k=z(h,b,c);d.push({variable:h,value:k})});l.forEach(h=>{const k=A(h,b,c);d.push({variable:h,value:k})});g.forEach(h=>{const k=u(h,b,c);d.push({variable:h,value:k})});return d.filter(h=>null!=h.value)}};p.viewScaleRE=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;Object.defineProperty(p,"__esModule",{value:!0})});