// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/shared ../../../core/accessorSupport/decorators/subclass ../../../core/Error ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/promiseUtils ../../../geometry/Extent ../../../geometry/Polygon ../../../geometry/support/typeUtils ../../../geometry ../../../core/Collection ../../../core/Promise ../../../core/Loadable ../../../Graphic ../../../core/workers/workers ../../../tasks/operations/zscale ../../../tasks/operations/queryZScale ../../../tasks/support/FeatureSet".split(" "),
function(l,x,p,D,t,E,F,q,R,G,H,u,S,T,U,y,I,J,z,V,K,L,M,A,N,O,B,P){let Q=0;const v=E.getLogger("esri.layers.graphics.sources.MemorySource");l.MemorySource=function(C){function r(a){a=C.call(this,a)||this;a._idToClientGraphic=null;a.type="memory";return a}x._inheritsLoose(r,C);var e=r.prototype;e.load=function(a){a=t.isSome(a)?a.signal:null;this.addResolvingPromise(this._startWorker(a));return y.resolve(this)};e.destroy=function(){var a;null==(a=this._connection)?void 0:a.close();this._connection=null};
e.applyEdits=function(a){return this.load().then(()=>this._applyEdits(a))};e.openPorts=function(){return this.load().then(()=>this._connection.openPorts())};e.queryFeatures=async function(a,b={}){await this.load(b);b=await this._connection.invoke("queryFeatures",a?a.toJSON():null,b);B.applyFeatureSetZUnitScaling(a,this.layer.spatialReference,b);a=P.fromJSON(b);if(!this._requiresClientGraphicMapping())return a;b=this.layer.objectIdField;for(const d of a.features){const m=this._idToClientGraphic.get(d.attributes[b]);
m&&(d.geometry=m.geometry)}a.geometryType=this.layer.geometryType;return a};e.queryFeaturesJSON=async function(a,b={}){if(this._requiresClientGraphicMapping())return y.reject(new u("query-features-json:unsupported","Cannot query in JSON format for client only geometry types (mesh and extent)"));await this.load(b);b=await this._connection.invoke("queryFeatures",a?a.toJSON():null,b);B.applyFeatureSetZUnitScaling(a,this.layer.spatialReference,b);return b};e.queryFeatureCount=function(a,b={}){return this.load(b).then(()=>
this._connection.invoke("queryFeatureCount",a?a.toJSON():null,b))};e.queryObjectIds=function(a,b={}){return this.load(b).then(()=>this._connection.invoke("queryObjectIds",a?a.toJSON():null,b))};e.queryExtent=function(a,b={}){return this.load(b).then(()=>this._connection.invoke("queryExtent",a?a.toJSON():null,b)).then(d=>({count:d.count,extent:I.fromJSON(d.extent)}))};e._applyEdits=function(a){if(!this._connection)throw new u("feature-layer-source:edit-failure","Memory source not loaded");const b=
this.layer.objectIdField;let d=null;const m=[],n=[],k=c=>"objectId"in c&&null!=c.objectId?c.objectId:"attributes"in c&&null!=c.attributes[b]?c.attributes[b]:null;a.addFeatures&&(d=this._prepareAddFeatures(a.addFeatures));if(a.deleteFeatures)for(const c of a.deleteFeatures){const g=k(c);null!=g&&m.push(g)}const h=a.updateFeatures&&this._idToClientGraphic?new Map:null;if(a.updateFeatures)for(const c of a.updateFeatures)n.push(this._serializeFeature(c)),h&&(a=k(c),null!=a&&h.set(a,c));O.unapplyEditsZUnitScaling(d?
d.features:null,n,this.layer.spatialReference);return this._connection.invoke("applyEdits",{adds:d?d.features:[],updates:n,deletes:m}).then(({fullExtent:c,featureEditResults:g})=>{this.fullExtent=c;d&&d.finish(g.uidToObjectId);if(this._idToClientGraphic){if(h)for(const f of g.updateResults)f.success&&(c=h.get(f.objectId),null!=c&&this._addIdToClientGraphic(c));for(const f of g.deleteResults)f.success&&this._idToClientGraphic.delete(f.objectId)}return this._createEditsResult(g)})};e._createEditsResult=
function(a){return{addFeatureResults:a.addResults?a.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:a.updateResults?a.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:a.deleteResults?a.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}};e._createFeatureEditResult=function(a){const b=!0===a.success?null:a.error||{code:void 0,description:void 0};return{objectId:a.objectId,
globalId:a.globalId,error:b?new u("feature-layer-source:edit-failure",b.description,{code:b.code}):null}};e._prepareAddFeatures=function(a){const b=new Map,d=Array(a.length);let m=null;for(let k=0;k<a.length;k++){const h=a[k],c=this._serializeFeature(h);!m&&t.isSome(h.geometry)&&(m=h.geometry.type);d[k]=c;b.set(`${c.uid}`,h)}const n=this;return{features:d,inferredGeometryType:m,finish(k){const h=n.sourceJSON.objectIdField;for(const c in k){const g=k[c],f=b.get(c);f&&(f.attributes||(f.attributes={}),
-1===g?delete f.attributes[h]:f.attributes[h]=g,n._addIdToClientGraphic(f))}}}};e._addIdToClientGraphic=function(a){if(this._idToClientGraphic){var b=this.sourceJSON.objectIdField;b=a.attributes&&a.attributes[b];null!=b&&this._idToClientGraphic.set(b,a)}};e._requiresClientGraphicMapping=function(){return this._geometryTypeRequiresClientGraphicMapping(this.layer.geometryType||this.sourceJSON.geometryType)};e._geometryRequiresClientGraphicMapping=function(a){return this._geometryTypeRequiresClientGraphicMapping(a.type)};
e._geometryTypeRequiresClientGraphicMapping=function(a){return"mesh"===a||"multipatch"===a||"extent"===a};e._serializeFeature=function(a){const {attributes:b}=a;a=this._geometryForSerialization(a);const d=(Q++).toString();return a?{uid:d,geometry:a.toJSON(),attributes:b}:{uid:d,attributes:b}};e._geometryForSerialization=function(a){({geometry:a}=a);return t.isNone(a)?null:this._geometryRequiresClientGraphicMapping(a)?a.extent?J.fromExtent(a.extent):null:a};e._startWorker=async function(a){this._connection=
await N.open("MemorySourceWorker",{strategy:D("feature-layers-workers")?"dedicated":"local",signal:a});const {fields:b,spatialReference:d,objectIdField:m,hasM:n,hasZ:k,timeInfo:h}=this.layer;var c="defaults"===this.layer.originOf("spatialReference");const g=this._prepareAddFeatures(this.items);this.on("before-changes",w=>{v.error("Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead");w.preventDefault()});c={features:g.features,fields:b&&b.map(w=>w.toJSON()),
geometryType:z.typeKebabDictionary.toJSON(this.workerGeometryType),hasM:n,hasZ:k,objectIdField:m,spatialReference:c?null:d&&d.toJSON(),timeInfo:h?h.toJSON():null};a=await this._connection.invoke("load",c,{signal:a});for(var f of a.warnings)v.warn(f.message,{layer:this.layer,warning:f});a.featureErrors.length&&v.warn(`Encountered ${a.featureErrors.length} validation errors while loading features`,a.featureErrors);f=a.layerDefinition;this._geometryTypeRequiresClientGraphicMapping(g.inferredGeometryType)&&
(f.geometryType=z.typeKebabDictionary.toJSON(g.inferredGeometryType));if("mesh"===f.geometryType||"mesh"===this.layer.geometryType)f.hasZ=!0;this.sourceJSON=f;this._requiresClientGraphicMapping()&&(this._idToClientGraphic=new Map);g.finish(a.assignedObjectIds)};x._createClass(r,[{key:"workerGeometryType",get:function(){const a=this.layer&&this.layer.geometryType;return a?this._geometryTypeRequiresClientGraphicMapping(a)?"polygon":a:null}}]);return r}(M.LoadableMixin(L.EsriPromiseMixin(K)));p.__decorate([G.shared({Type:A,
ensureType:F.ensureType(A)})],l.MemorySource.prototype,"itemType",void 0);p.__decorate([q.property()],l.MemorySource.prototype,"type",void 0);p.__decorate([q.property({constructOnly:!0})],l.MemorySource.prototype,"layer",void 0);p.__decorate([q.property({readOnly:!0,dependsOn:["layer.geometryType"]})],l.MemorySource.prototype,"workerGeometryType",null);p.__decorate([q.property()],l.MemorySource.prototype,"sourceJSON",void 0);l.MemorySource=p.__decorate([H.subclass("esri.layers.graphics.sources.MemorySource")],
l.MemorySource);l.default=l.MemorySource;Object.defineProperty(l,"__esModule",{value:!0})});