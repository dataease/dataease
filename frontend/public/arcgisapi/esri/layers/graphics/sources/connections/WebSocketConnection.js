// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/Error ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/promiseUtils ../../../../tasks/operations/zscale ./StreamConnection".split(" "),
function(d,w,r,D,t,z,E,x,F,A,g,G,H,I,u,B,C){const f=z.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");(function(e){e[e.CONNECTING=0]="CONNECTING";e[e.OPEN=1]="OPEN";e[e.CLOSING=2]="CLOSING";e[e.CLOSED=3]="CLOSED"})(d.ReadyState||(d.ReadyState={}));d.WebSocketConnection=function(e){function n(c){var a=e.call(this)||this;a.errorString=null;const {geometryType:b,spatialReference:l,sourceSpatialReference:h}=c;a._config=c;a._featureZScaler=B.getGeometryZScaler(b,h,l);a._open();
return a}w._inheritsLoose(n,e);var k=n.prototype;k._open=async function(){await this._tryCreateWebSocket();this.destroyed||await this._handshake()};k.destroy=function(){t.isSome(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close());this._websocket=null};k._tryCreateWebSocket=async function(c=this._config.source.path,a=1E3,b=0){try{this.destroyed||(this._websocket=await this._createWebSocket(c),
this.notifyChange("connectionStatus"))}catch(l){const h=a/1E3;if(this._config.maxReconnectionAttempts&&b>=this._config.maxReconnectionAttempts)f.error(new g("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),this.destroy();else return f.error(new g("websocket-connection",`Failed to connect. Attempting to reconnect in ${h}s`,l)),await u.after(a),this._tryCreateWebSocket(c,Math.min(1.5*a,1E3*this._config.maxReconnectionInterval),b+1)}};k._createWebSocket=
function(c){const a=new WebSocket(c);c=u.create((b,l)=>{a.onopen=()=>b(a);a.onclose=h=>l(h)});c.then(()=>{this.destroyed?(a.onclose=()=>{},a.close()):(a.onclose=b=>this._onClose(b),a.onerror=b=>this._onError(b),a.onmessage=b=>this._onMessage(b))});return c};k._handshake=async function(c=1E4){const a=this._websocket;if(!t.isNone(a)){var b=u.createResolver(),l=a.onmessage,{filter:h,outFields:v,spatialReference:p}=this._config;b.timeout(c);a.onmessage=q=>{var y;let m=null;try{m=JSON.parse(q.data)}catch(J){}m&&
"object"===typeof m||(f.error(new g("websocket-connection","Protocol violation. Handshake failed - malformed message",q.data)),b.reject(),this.destroy());(null==(y=m.spatialReference)?void 0:y.wkid)!==(null==p?void 0:p.wkid)&&(f.error(new g("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${p.wkid}`,q.data)),b.reject(),this.destroy());"json"!==m.format&&(f.error(new g("websocket-connection","Protocol violation. Handshake failed - format is not set",q.data)),b.reject(),
this.destroy());h&&m.filter!==h&&f.error(new g("websocket-connection","Tried to set filter, but server doesn't support it"));v&&m.outFields!==v&&f.error(new g("websocket-connection","Tried to set outFields, but server doesn't support it"));a.onmessage=l;b.resolve()};a.send(JSON.stringify({filter:h,outFields:v,format:"json",spatialReference:{wkid:p.wkid}}));return b.promise}};k._onMessage=function(c){try{const a=JSON.parse(c.data);if("featureResult"!==a.type)throw new g("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",
a);for(const b of a.features)this._featureZScaler&&this._featureZScaler(b.geometry),this.onFeature(b)}catch(a){f.error(new g("websocket-connection","Failed to parse message",a)),this.destroy()}};k._onError=function(c){this._set("errorString","Encountered an error over WebSocket connection");f.error("websocket-connection","Encountered an error over WebSocket connection")};k._onClose=function(c){this._websocket=null;this.notifyChange("connectionStatus");1E3!==c.code&&f.error("websocket-connection",
`WebSocket closed unexpectedly with error code ${c.code}`);this.destroyed||this._open()};w._createClass(n,[{key:"connectionStatus",get:function(){if(t.isNone(this._websocket))return"disconnected";switch(this._websocket.readyState){case d.ReadyState.CONNECTING:case d.ReadyState.OPEN:return"connected";case d.ReadyState.CLOSING:case d.ReadyState.CLOSED:return"disconnected"}}}]);return n}(C);r.__decorate([x.property()],d.WebSocketConnection.prototype,"connectionStatus",null);r.__decorate([x.property()],
d.WebSocketConnection.prototype,"errorString",void 0);d.WebSocketConnection=r.__decorate([A.subclass("esri.layers.graphics.sources.connections.WebSocketConnection")],d.WebSocketConnection);Object.defineProperty(d,"__esModule",{value:!0})});