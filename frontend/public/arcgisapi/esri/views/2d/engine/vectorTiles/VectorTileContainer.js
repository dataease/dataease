// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/promiseUtils ../../../../geometry/support/aaBoundingRect ../../tiling/TileKey ../../tiling/TileCoverage ../webgl/TiledDisplayObject ../webgl/enums ../webgl/TileContainer ./decluttering/debugging ./decluttering/SymbolFader".split(" "),function(C,G,m,H,D,I,J,K,q,A,E,L){function F(f,v){if(f){const d=f.getLayoutProperty("visibility");if(!d||"none"!==d.getValue()&&(void 0===f.minzoom||f.minzoom<v+1E-6)&&
(void 0===f.maxzoom||f.maxzoom>=v-1E-6))return!0}return!1}A=function(f){function v(a){a=f.call(this,a)||this;a._backgroundTiles=[];a._pointToCallbacks=new Map;a._fading=!1;return a}G._inheritsLoose(v,f);var d=v.prototype;d.destroy=function(){this.children.forEach(a=>a.destroy());this.removeAllChildren();this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null);this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null);m.isSome(this._symbolFader)&&(this._symbolFader.clear(),
this._symbolFader=null);this._styleRepository=null;this._backgroundTiles=[];this._pointToCallbacks.clear()};d.setStyleResources=function(a,b,c){this._spriteMosaic=a;this._glyphMosaic=b;this._styleRepository=c;m.isNone(this._symbolFader)&&(a=new L.SymbolFader(this._styleRepository,this.children),a.on("fade-start",()=>{this.emit("fade-start");this._fading=!0;this.requestRender()}),a.on("fade-complete",()=>{this.emit("fade-complete");this._fading=!1;this.requestRender()}),this._symbolFader=a);m.unwrap(this._symbolFader).styleRepository=
c};d.deleteStyleLayers=function(a){m.isSome(this._symbolFader)&&this._symbolFader.deleteStyleLayers(a)};d.hitTest=async function(a,b){a=[a,b];b=H.createResolver();this._pointToCallbacks.set(a,b);this.requestRender();return b.promise};d.enterTileInvalidation=function(){for(const a of this.children)a.invalidating=!0};d.createRenderParams=function(a){return{...f.prototype.createRenderParams.call(this,a),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,
hasClipping:!!this._clippingInfos}};d.doRender=function(a){!this.visible||a.drawPhase!==q.WGLDrawPhase.MAP&&a.drawPhase!==q.WGLDrawPhase.DEBUG||void 0===this._spriteMosaic||f.prototype.doRender.call(this,a)};d.addChild=function(a){f.prototype.addChild.call(this,a);m.isSome(this._symbolFader)?this._symbolFader.addTile(a):a.decluttered=!0;this.requestRender();return a};d.removeChild=function(a){m.isSome(this._symbolFader)&&this._symbolFader.removeTile(a);this.requestRender();return f.prototype.removeChild.call(this,
a)};d.renderChildren=function(a){if(a.drawPhase===q.WGLDrawPhase.DEBUG)f.prototype.renderChildren.call(this,a);else if(this._doRender(a),0<this._pointToCallbacks.size){const {context:b}=a,c=b.getBoundFramebufferObject();a.drawPhase=q.WGLDrawPhase.HITTEST;const h=a.painter.effects.hittest;h.bind(a);this._doRender(a);h.draw(a,this._pointToCallbacks);b.bindFramebuffer(c)}};d.removeAllChildren=function(){for(let a=0;a<this.children.length;a++){const b=this.children[a];m.isSome(this._symbolFader)&&this._symbolFader.removeTile(b);
b.dispose()}f.prototype.removeAllChildren.call(this)};d.getStencilTarget=function(){return this.children.filter(a=>a.neededForCoverage&&a.hasData())};d.restartDeclutter=function(){m.isSome(this._symbolFader)&&this._symbolFader.restartDeclutter()};d._doRender=function(a){var {context:b}=a,c=this._styleRepository;if(c){var h=c.layers,e=!0;a.drawPhase===q.WGLDrawPhase.HITTEST&&(e=!1);0<c.backgroundBucketIds.length&&(a.renderPass="background",this._renderBackgroundLayers(a,c.backgroundBucketIds));f.prototype.renderChildren.call(this,
a);if((c=this.children.filter(r=>r.visible&&r.hasData()))&&0!==c.length){for(var g of c)g.triangleCount=0;b.setStencilWriteMask(0);b.setColorMask(!0,!0,!0,!0);b.setStencilOp(7680,7680,7681);b.setStencilTestEnabled(!0);b.setBlendingEnabled(!1);b.setDepthTestEnabled(!0);b.setDepthWriteEnabled(!0);b.setDepthFunction(515);b.setClearDepth(1);b.clear(b.gl.DEPTH_BUFFER_BIT);a.renderPass="opaque";for(g=h.length-1;0<=g;g--)this._renderStyleLayer(h[g],a,c);b.setDepthWriteEnabled(!1);b.setBlendingEnabled(e);
b.setBlendFunctionSeparate(1,771,1,771);a.renderPass="translucent";for(e=0;e<h.length;e++)this._renderStyleLayer(h[e],a,c);b.setDepthTestEnabled(!1);a.renderPass="symbol";for(e=0;e<h.length;e++)this._renderStyleLayer(h[e],a,c);b.bindVAO();b.setStencilTestEnabled(!0);b.setBlendingEnabled(!0);if(a.drawPhase===q.WGLDrawPhase.MAP&&(this._fade(a.displayLevel,a.state),(a=window.COLLISION_DEBUG_CTX)&&m.isSome(this._symbolFader)&&(a.clearRect(0,0,a.canvas.width,a.canvas.height),!this._fading||window.COLLISION_XRAY)))for(const r of this.children)if(r.symbols){const p=
[];r.symbols.forEach(t=>{p.push(...t)});if(window.COLLISION_SHOW_GRID){var n,k,u;(b=null==(n=this._symbolFader)?void 0:null==(k=n._symbolDeclutterer)?void 0:null==(u=k._collisionJob)?void 0:u._gridIndex)&&E.drawGridIndex(a,b)}E.drawColliders(a,p)}}}};d._fade=function(a,b){m.isSome(this._symbolFader)&&(this._symbolFader.update(a,b)||this.requestRender())};d._renderStyleLayer=function(a,b,c){const {painter:h,renderPass:e}=b;if(void 0!==a){var g=a.getLayoutProperty("visibility");if(!g||"none"!==g.getValue()){switch(a.type){case 0:return;
case 1:if("opaque"!==e&&"translucent"!==b.renderPass)return;var n="vtlFill";break;case 2:if("translucent"!==e)return;n="vtlLine";break;case 4:if("symbol"!==e)return;n="vtlCircle";break;case 3:if("symbol"!==e)return;n="vtlSymbol"}c=3===a.type?c.filter(k=>k.decluttered):c.filter(k=>k.neededForCoverage);if("vtlSymbol"!==n&&(g=b.displayLevel,0===c.length||void 0!==a.minzoom&&a.minzoom>=g+1E-6||void 0!==a.maxzoom&&a.maxzoom<g-1E-6))return;g=a.uid;b.styleLayerUID=g;b.styleLayer=a;for(const k of c)if(k.layerData.has(g)){h.renderObjects(b,
c,n);break}}}};d._renderBackgroundLayers=function(a,b){const {context:c,displayLevel:h,painter:e,state:g}=a,n=this._styleRepository;var k=!1;for(var u of b)if(F(n.getLayerById(u),h)){k=!0;break}if(k){k=this._tileInfoView.getTileCoverage(a.state,0,"smallest");var {spans:r,lodInfo:p}=k,{level:t}=p,y=D.create();u=[];if(this._renderPasses){var w=this._renderPasses[0];m.isSome(this._clippingInfos)&&(w.brushes[0].prepareState(a,this._clippingInfos[0]),w.brushes[0].drawMany(a,this._clippingInfos))}w=this._backgroundTiles;
var B=0;for(const {row:z,colFrom:M,colTo:N}of r)for(let x=M;x<=N;x++){if(B<w.length){var l=w[B];l.key.set(t,z,p.normalizeCol(x),p.getWorldForColumn(x));this._tileInfoView.getTileBounds(y,l.key,!1);l.bounds=y;l.coords[0]=y[0];l.coords[1]=y[3]}else l=new I(t,z,p.normalizeCol(x),p.getWorldForColumn(x)),l=new K.TiledDisplayObject(l,this._tileInfoView.getTileBounds(D.create(),l),[512,512],[4096,4096]),w.push(l);l.setTransform(g,this._tileInfoView.getTileResolution(l.key));u.push(l);B++}c.setStencilWriteMask(0);
c.setColorMask(!0,!0,!0,!0);c.setStencilOp(7680,7680,7681);c.setStencilFunction(514,0,255);t=!0;a.drawPhase===q.WGLDrawPhase.HITTEST&&(t=!1);c.setStencilTestEnabled(t);for(const z of b)b=n.getLayerById(z),F(b,h)&&(a.styleLayerUID=b.uid,a.styleLayer=b,e.renderObjects(a,u,"vtlBackground"));J.pool.release(k)}};return v}(A["default"]);C.VectorTileContainer=A;Object.defineProperty(C,"__esModule",{value:!0})});