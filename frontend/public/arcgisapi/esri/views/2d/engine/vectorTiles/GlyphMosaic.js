// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../../core/has ../../../../core/promiseUtils ../../../webgl/Program ../../../webgl/BufferObject ../../../webgl/Texture ../../../webgl/VertexArrayObject ../../../webgl/Renderbuffer ../../../webgl/FramebufferObject ../../../webgl/ProgramCache ../../../webgl/RenderingContext ../../../webgl/ShaderCompiler ../webgl/Rect ./RectangleBinPack".split(" "),function(D,A,E,F,B,G,H,I,J,K,L,C,x){return function(){function y(b,g,c){this.height=this.width=0;this._dirties=[];this._glyphData=[];this._currentPage=
0;this._glyphIndex={};this._textures=[];this._rangePromises=new Map;this.width=b;this.height=g;this._glyphSource=c;this._binPack=new x(b-4,g-4);this._glyphData.push(new Uint8Array(b*g));this._dirties.push(!0);this._textures.push(void 0)}var t=y.prototype;t.getGlyphItems=function(b,g){const c=[],e=this._glyphSource,h=new Set,w=1/256;for(const d of g)h.add(Math.floor(d*w));const k=[];h.forEach(d=>{if(256>=d){const a=b+d;this._rangePromises.has(a)?k.push(this._rangePromises.get(a)):(d=e.getRange(b,d).then(()=>
{this._rangePromises["delete"](a)},()=>{this._rangePromises["delete"](a)}),this._rangePromises.set(a,d),k.push(d))}});return A.all(k).then(()=>{let d=this._glyphIndex[b];d||(d={},this._glyphIndex[b]=d);for(const m of g){var a=d[m];if(a){c[m]={sdf:!0,rect:a.rect,metrics:a.metrics,page:a.page,code:m};continue}var f=e.getGlyph(b,m);if(!f||!f.metrics)continue;a=f.metrics;let l;if(0===a.width)l=new C(0,0,0,0);else{const n=a.width+6,r=a.height+6;var p=n%4?4-n%4:4,q=r%4?4-r%4:4;1===p&&(p=5);1===q&&(q=5);
l=this._binPack.allocate(n+p,r+q);l.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new x(this.width-4,this.height-4),l=this._binPack.allocate(n+p,r+q));p=this._glyphData[this._currentPage];f=f.bitmap;let z;if(f)for(let u=0;u<r;u++){q=n*u;z=this.width*(l.y+u+1)+l.x;for(let v=0;v<n;v++)p[z+v+1]=f[q+
v]}}d[m]={rect:l,metrics:a,tileIDs:null,page:this._currentPage};c[m]={sdf:!0,rect:l,metrics:a,page:this._currentPage,code:m};this._dirties[this._currentPage]=!0}return c})};t.removeGlyphs=function(b){for(const g in this._glyphIndex){const c=this._glyphIndex[g];if(!c)continue;let e;for(const h in c)if(e=c[h],e.tileIDs["delete"](b),0===e.tileIDs.size){const w=this._glyphData[e.page],k=e.rect;let d,a;for(let f=0;f<k.height;f++)for(d=this.width*(k.y+f)+k.x,a=0;a<k.width;a++)w[d+a]=0;delete c[h];this._dirties[e.page]=
!0}}};t.bind=function(b,g,c,e=0){this._textures[c]||(this._textures[c]=new B(b,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height)));const h=this._textures[c];h.setSamplingMode(g);this._dirties[c]&&h.setData(this._glyphData[c]);b.bindTexture(h,e);this._dirties[c]=!1};t.dispose=function(){this._binPack=null;for(const b of this._textures)b&&b.dispose();this._textures.length=0};return y}()});