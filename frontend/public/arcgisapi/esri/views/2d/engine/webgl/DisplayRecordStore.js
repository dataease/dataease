// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define(["../../../../core/has","./Utils","./FreeList"],function(w,r,t){const q=["FILL","LINE","MARKER","TEXT","LABEL"];return function(){function u(a,b,d,e){this._strides=a;this._displayList=b;this._freeListsAndStorage={};this._dirtyMap=null;this._dirtyMap=d;for(const f in a){this._freeListsAndStorage[f]={vtxFreeList:e?new t.FreeList(e):null,idxFreeList:e?new t.FreeList(e):null,vertexBuffers:{},indexBuffer:e?new Uint32Array(e):null};for(const c in a[f])this._freeListsAndStorage[f].vertexBuffers[c]=
{data:e?r.allocateTypedArrayBuffer(e,a[f][c]):null,stride:a[f][c]}}}u.fromTileData=function(a,b){var d,e=a.getStrides(),f={};for(d=0;d<e.length;d++)f[q[d]]=e[d];d=f;e=[0,0,0,0,0];f=[0,0,0,0,0];var c=a.tileDisplayData.displayObjects;for(var g of c)for(var h of g.displayRecords)e[h.geometryType]=Math.max(e[h.geometryType],h.vertexFrom+h.vertexCount),f[h.geometryType]=Math.max(f[h.geometryType],h.indexFrom+h.indexCount);b=new u(d,a.tileDisplayData.displayList,b,null);for(g=0;g<a.tileBufferData.geometries.length;++g){h=
e[g];c=f[g];var p=a.tileBufferData.geometries[g];d=b._storageFor(q[g]);const n=a.tileBufferData.geometries[g].indexBuffer;d.indexBuffer=n;d.idxFreeList=new t.FreeList(n.length);d.idxFreeList.allocate(c);let k;for(const l in p.vertexBuffer)c=a.tileBufferData.geometries[g].vertexBuffer[l],d.vertexBuffers[l].data=c.data,d.vertexBuffers[l].stride=c.stride,p=r.strideToPackingFactor(c.stride),c=c.data.length*p/c.stride,k||(k=c);d.vtxFreeList=new t.FreeList(k);d.vtxFreeList.allocate(h)}return b};var m=u.prototype;
m.delete=function(a){const b=q[a.geometryType];this._freeVertices(b,a.vertexFrom,a.vertexCount);this._freeIndices(b,a.indexFrom,a.indexCount);this._displayList.removeFromList(a);a.vertexFrom=void 0;a.indexFrom=void 0};m.setMeshData=function(a,b,d,e,f){const c=q[a.geometryType];a.meshData=null;let g=void 0,h=void 0;void 0===a.vertexFrom?(h=b.vertexCount,g=this._allocateVertices(c,h)):b.vertexCount>a.vertexCount?(this._freeVertices(c,a.vertexFrom,a.vertexCount),h=b.vertexCount,g=this._allocateVertices(c,
h)):b.vertexCount===a.vertexCount?(g=a.vertexFrom,h=a.vertexCount):(this._freeVertices(c,a.vertexFrom+b.vertexCount,a.vertexCount-b.vertexCount),g=a.vertexFrom,h=b.vertexCount);let p=!0,n=void 0,k=void 0,l=void 0;void 0===a.indexFrom?(n=f,l=b.indexCount,k=this._allocateIndices(c,l)):b.indexCount>a.indexCount?(n=this._displayList.removeFromList(a),this._freeIndices(c,a.indexFrom,a.indexCount),l=b.indexCount,k=this._allocateIndices(c,l)):b.indexCount===a.indexCount?(p=!1,k=a.indexFrom,l=a.indexCount):
(n=this._displayList.removeFromList(a),this._freeIndices(c,a.indexFrom+b.indexCount,a.indexCount-b.indexCount),k=a.indexFrom,l=b.indexCount);if(-1!==g&&-1!==k){f=this._storageFor(c);r.copyMeshData(g,k,f.vertexBuffers,f.indexBuffer,b,d,e);a.vertexFrom=g;a.indexFrom=k;a.vertexCount=b.vertexCount;a.indexCount=b.indexCount;if(this._dirtyMap){this._dirtyMap.markDirtyIndices(a.geometryType,a.indexFrom,a.indexCount);for(const v in d)this._dirtyMap.markDirtyVertices(a.geometryType,v,a.vertexFrom,a.vertexCount)}p&&
this._displayList.addToList(a,n);return!0}-1!==g&&this._freeVertices(c,g,h);-1!==k&&this._freeIndices(c,k,l);a.setMeshDataFromBuffers(b,d,e);a.vertexFrom=void 0;a.vertexCount=0;a.indexFrom=void 0;a.indexCount=0;return!1};m.tryAddMeshData=function(a,b){const d=b.vertexBuffer;b=b.indexBuffer;var e=q[a.geometryType];const f=this._allocateVertices(e,a.vertexCount);if(-1===f)return this._freeVertices(e,f,a.vertexCount),!1;const c=this._allocateIndices(e,a.indexCount);if(-1===c)return this._freeVertices(e,
f,a.vertexCount),this._freeIndices(e,c,a.indexCount),!1;e=this._storageFor(e);r.copyMeshData(f,c,e.vertexBuffers,e.indexBuffer,a,d,b);a.vertexFrom=f;a.indexFrom=c;if(this._dirtyMap){this._dirtyMap.markDirtyIndices(a.geometryType,a.indexFrom,a.indexCount);for(const g in d)this._dirtyMap.markDirtyVertices(a.geometryType,g,f,a.vertexCount)}this._displayList.addToList(a);return!0};m._allocateVertices=function(a,b){a=this._storageFor(a);b=a.vtxFreeList.allocate(b);return-1===b||.5<a.vtxFreeList.fragmentation?
-1:b};m._freeVertices=function(a,b,d){this._storageFor(a).vtxFreeList.free(b,d)};m._freeIndices=function(a,b,d){this._storageFor(a).idxFreeList.free(b,d)};m._allocateIndices=function(a,b){a=this._storageFor(a);b=a.idxFreeList.allocate(b);return-1===b||.5<a.idxFreeList.fragmentation?-1:b};m._storageFor=function(a){return this._freeListsAndStorage[a]};m._stridesFor=function(a,b){return this._strides[a][b]};return u}()});