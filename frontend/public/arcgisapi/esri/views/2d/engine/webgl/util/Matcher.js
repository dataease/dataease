// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Logger ../../../../../core/Error ../../../../../core/promiseUtils ../../../../../support/arcadeOnDemand ../../../../../symbols/cim/utils ../../../../../core/LRUCache ../../../arcade/callExpressionWithFeature ../../../../../symbols/cim/cimSymbolUtils ../../../layers/features/schemaUtils".split(" "),function(y,r,t,q,z,u,A,B,C,D,n,E){async function F(h,g){const f=h||1;if("number"===typeof f)return(b,c,d)=>f;const a=
await A.createRendererExpression(f,g.spatialReference,g.fields);return(b,c,d)=>D(a,b,{$view:d},g.geometryType,c)||1}const v=q.getLogger("esri/views/2d/engine/webgl/util/Matcher");q=function(){function h(){this.type="feature";this._defaultResult=null}h.fromBasicRenderer=async function(f,a,b){const c=new h;f.symbol&&(f=await n.expandSymbol(f.symbol,b),a=a.createTemplateGroup(f,null),c.setDefault(a));return c};var g=h.prototype;g.size=function(){return 1};g.getDefault=function(){return this._defaultResult};
g.setDefault=function(f){this._defaultResult=f};g.match=function(f,a,b,c,d){return this.getDefault()};g.analyze=async function(f,a,b,c,d){return null};return h}();let G=function(h){function g(a,b,c,d){var e=h.call(this)||this;e.type="interval";e._intervals=[];e._isMaxInclusive=b;e._fieldIndex=d;e._field=a;e._normalizationInfo=c;return e}t._inheritsLoose(g,h);g.fromCBRenderer=async function(a,b,c){const {isMaxInclusive:d,normalizationField:e,normalizationTotal:m,normalizationType:k}=a,l=new g(a.field,
d,{normalizationField:e,normalizationTotal:m,normalizationType:k},a.fieldIndex),p=await n.expandSymbol(a.backgroundFillSymbol,c);await u.all(a.intervals.map(async w=>{var x=await n.expandSymbol(w.symbol,c);x=await b.createTemplateGroup(x,p);l.add({min:w.min,max:w.max},x)}));if(a=await n.expandSymbol(a.defaultSymbol,c))a=await b.createTemplateGroup(a,p),l.setDefault(a);return l};var f=g.prototype;f.add=function(a,b){this._intervals.push({interval:a,result:b});this._intervals.sort((c,d)=>c.interval.min-
d.interval.min)};f.size=function(){return h.prototype.size.call(this)+this._intervals.length};f.match=function(a,b,c,d,e){if(null==this._fieldIndex&&!this._field)return this.getDefault();a=null!=this._fieldIndex?b.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(b);if(!a&&(null===a||void 0===a||isNaN(a)))return this.getDefault();for(b=0;b<this._intervals.length;b++){const {interval:m,result:k}=this._intervals[b];c=this._isMaxInclusive?a<=m.max:a<m.max;if(a>=m.min&&c)return k}return this.getDefault()};
f._needsNormalization=function(){const a=this._normalizationInfo;return a&&(a.normalizationField||a.normalizationTotal||a.normalizationType)};f._getValueFromField=function(a){const b=a.readAttribute(this._field);if(!this._needsNormalization())return b;const {normalizationField:c,normalizationTotal:d,normalizationType:e}=this._normalizationInfo;a=!!c&&a.readAttribute(c);if(e)switch(e){case "esriNormalizeByField":return(a||void 0)&&b/a;case "esriNormalizeByLog":return Math.log(b)*Math.LOG10E;case "esriNormalizeByPercentOfTotal":return b/
d*100;default:v.error(`Found unknown normalization type: ${e}`)}else v.error("Normalization is required, but no type was set!")};return g}(q),H=function(h){function g(a,b,c){var d=h.call(this)||this;d.type="map";d._nullResult=null;d._resultsMap=new Map;d._fieldsIndex=c;d._fields=a;d._seperator=b||"";return d}t._inheritsLoose(g,h);g.fromUVRenderer=async function(a,b,c){const d=a.fieldDelimiter,e=[a.field];a.field2&&e.push(a.field2);a.field3&&e.push(a.field3);const m=await n.expandSymbol(a.backgroundFillSymbol,
c),k=new g(e,d,a.fieldIndex);await u.all(a.map.map(async l=>{var p=await n.expandSymbol(l.symbol,c);p=await b.createTemplateGroup(p,m);"\x3cNull\x3e"===l.value?k.setNullResult(p):k.add(l.value,p)}));if(a=await n.expandSymbol(a.defaultSymbol,c))a=await b.createTemplateGroup(a,m),k.setDefault(a);return k};var f=g.prototype;f.setNullResult=function(a){this._nullResult=a};f.add=function(a,b){this._resultsMap.set(a.toString(),b)};f.size=function(){return h.prototype.size.call(this)+this._resultsMap.size};
f.match=function(a,b,c,d,e){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();a=null!=this._fieldsIndex?b.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(b);if(null!==this._nullResult&&(null==a||""===a||"\x3cNull\x3e"===a))return this._nullResult;if(!a&&null==a)return this.getDefault();a=a.toString();return this._resultsMap.has(a)?this._resultsMap.get(a):this.getDefault()};f._getValueFromFields=function(a){const b=[];for(const c of this._fields){const d=a.readAttribute(c);
b.push(d)}return b.join(this._seperator)};return g}(q),I=function(h){function g(a,b,c,d){var e=h.call(this)||this;e.type="dictionary";e._groupIdCache=new C(100);e._renderer=a;e._fieldMap=a.fieldMap;e._symbolFields=a.getSymbolFields();e._templates=b;e._info=c;e._scaleFn=d;return e}t._inheritsLoose(g,h);g.fromDictionaryRenderer=async function(a,b,c){a=(await new Promise(function(e,m){y(["../../../../../renderers/DictionaryRenderer"],function(k){e(Object.freeze({__proto__:null,"default":k}))},m)})).default.fromJSON(a.renderer);
await a.fetchResources({spatialReference:c.spatialReference,fields:c.fields});const d=await F(a.scaleExpression,c);return new g(a,b,c,d)};var f=g.prototype;f._analyzeFeature=async function(a,b,c,d){a=a.readLegacyFeature();const e=this._scaleFn(a,b,c);b=this._attributeHash(a)+"-"+e;const m=this._groupIdCache.get(b);if(m)return m;c=await this._renderer.getSymbolAsync(a,{...c,spatialReference:this._info.spatialReference,abortOptions:d,fields:this._info.fields});c=E.createSymbolSchema(c,this._renderer);
d=n.expandSymbol(c,this._info,d).then(k=>{if("expanded-cim"!==k.type)return v.error(new z("mapview-bad-type",`Found unexpected type ${k.type} in dictionary response`)),null;k.hash+="-"+e;for(const l of k.layers)l.scaleFactor=e,l.templateHash+="-"+e,"text"===l.type&&"string"===typeof l.text&&-1<l.text.indexOf("[")&&(l.text=B.createLabelOverrideFunction(this._fieldMap,l.text,l.cim.textCase));return this._templates.createTemplateGroup(k,null)});this._groupIdCache.put(b,d,1);return d};f.analyze=async function(a,
b,c,d,e){a=b.getCursor();for(b=[];a.next();)b.push(this._analyzeFeature(a,c,d,e));return u.all(b)};f.match=function(a,b,c,d,e){return null};f._attributeHash=function(a){let b="";for(const c of this._symbolFields){const d=this._fieldMap[c];d&&(b+=a.attributes[d]+"-")}return b};return g}(q);r.DictionaryMatcher=I;r.FeatureMatcher=q;r.IntervalMatcher=G;r.MapMatcher=H;Object.defineProperty(r,"__esModule",{value:!0})});