// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../../../../chunks/_rollupPluginBabelHelpers ../../../../../../core/maybe ../../../../../../core/Logger ../../../../../../core/Error ../../../../../../core/screenUtils ../../definitions ../../../../../../chunks/mat2df32 ../../../../../../chunks/vec2f32 ../../number ../../materialKey/MaterialKey ../../color ../../util/Result ./util ./WGLBaseMarkerTemplate ./WGLDynamicMeshTemplate".split(" "),function(z,A,B,C,g,x,D,E,k,F,t,G,h,H,I){const J=E.create(),K=D.create(),L=B.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate");
return function(y){function m(a){var b=y.call(this,a)||this;b._cimMarkerLayer=a;h.isFunction(a.color)?b._dynamicPropertyMap.set("_fillColor",(d,e,c)=>t.premultiplyAlphaRGBA(a.color(d,e,c))):b._fillColor=t.premultiplyAlphaRGBA(a.color);h.isFunction(a.outlineColor)?b._dynamicPropertyMap.set("_outlineColor",(d,e,c)=>t.premultiplyAlphaRGBA(a.outlineColor(d,e,c))):b._outlineColor=t.premultiplyAlphaRGBA(a.outlineColor);h.isFunction(a.size)?b._dynamicPropertyMap.set("_size",(d,e,c)=>g.pt2px(a.size(d,e,c))):
b._size=g.pt2px(a.size);h.isFunction(a.scaleX)?b._dynamicPropertyMap.set("_scaleX",a.scaleX):b._scaleX=a.scaleX;h.isFunction(a.offsetX)?b._dynamicPropertyMap.set("xOffset",(d,e,c)=>g.pt2px(a.offsetX(d,e,c))):b.xOffset=g.pt2px(a.offsetX);h.isFunction(a.offsetY)?b._dynamicPropertyMap.set("yOffset",(d,e,c)=>g.pt2px(a.offsetY(d,e,c))):b.yOffset=g.pt2px(a.offsetY);h.isFunction(a.outlineWidth)?b._dynamicPropertyMap.set("_outlineWidth",(d,e,c)=>g.pt2px(a.outlineWidth(d,e,c))):b._outlineWidth=g.pt2px(a.outlineWidth);
h.isFunction(a.rotation)?b._dynamicPropertyMap.set("_angle",a.rotation):b._angle=a.rotation;b._scaleFactor=A.unwrapOr(a.scaleFactor,1);b._markerPlacement=a.markerPlacement;b.effects=a.effects;b._bitSet=(1===a.alignment?1:0)|(a.colorLocked?1:0)<<1|(a.scaleSymbolsProportionally?1:0)<<3;b._materialKey=a.materialKey;return b}z._inheritsLoose(m,y);m.fromCIMMarker=function(a){return new m(a)};m.prototype.bindFeature=function(a,b,d){const e=a.readLegacyFeature();this._dynamicPropertyMap.forEach((M,N)=>{this[N]=
M(e,b,d)});a=this._cimMarkerLayer.materialHash;a="function"===typeof a?a(e,b,d):a;if((a=this._materialCache.get(a))&&G.ok(a.spriteMosaicItem)&&a.spriteMosaicItem){a=a.spriteMosaicItem;var c=this._cimMarkerLayer.sizeRatio,f=a.width/a.height*this._scaleX,n=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle,l=this._size,p=l*f,O=this.xOffset,P=this.yOffset;this.xOffset*=this._scaleFactor;this.yOffset*=this._scaleFactor;var q=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?
this._size/g.pt2px(this._cimMarkerLayer.frameHeight):1,u=this._outlineWidth*q,v=g.pt2px(this._cimMarkerLayer.referenceSize),w=q=0,r=this._cimMarkerLayer.anchorPoint;r&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(q=-r.x/(this._size*f),w=r.y/this._size):(q=r.x,w=r.y));this._sizeOutlineWidth=k.i8888to32(Math.round(Math.min(Math.sqrt(128*p),255)),Math.round(Math.min(Math.sqrt(128*l),255)),Math.round(Math.min(Math.sqrt(128*u),255)),Math.round(Math.min(Math.sqrt(128*v),255)));this.angle=n;
this._bitestAndDistRatio=k.i8888to32(0,0,this._bitSet,Math.round(Math.min(64*c,255)));f=a.rect.x+x.SPRITE_PADDING;n=a.rect.y+x.SPRITE_PADDING;u=f+a.width;v=n+a.height;this._texUpperLeft=k.i1616to32(f,n);this._texUpperRight=k.i1616to32(u,n);this._texBottomLeft=k.i1616to32(f,v);this._texBottomRight=k.i1616to32(u,v);f=F.MarkerMaterialKey.load(this._materialKey);f.sdf=a.sdf;f.pattern=!0;f.textureBinding=a.textureBinding;this._materialKey=f.data;this._anchorX=.5-(.5+q)*a.width/a.width;this._anchorY=.5-
(.5+w)*a.height/a.height;p=p*c*this._scaleFactor;l=l*c*this._scaleFactor;p*=a.rect.width/a.width;l*=a.rect.height/a.height;this._computedWidth=p;this._computedHeight=l;this._applyTransformation(K,J);this.xOffset=O;this.yOffset=P}else L.error(new C("mapview-cim","Encountered an error when binding feature"))};return m}(H(I))});