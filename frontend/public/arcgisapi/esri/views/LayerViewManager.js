// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/has ../core/maybe ../core/Logger ../core/accessorSupport/ensureType ../core/accessorSupport/decorators/property ../core/jsonMap ../core/accessorSupport/decorators/subclass ../core/Error ../core/urlUtils ../core/uuid ../portal/support/resourceExtension ../core/promiseUtils ../core/scheduling ../core/CollectionFlattener ../core/watchUtils ./support/WatchUpdatingTracking ../core/HandleOwner ../core/MapUtils".split(" "),function(u,
l,k,v,y,H,p,I,z,t,J,K,L,m,A,B,w,C,D,E){const F=y.getLogger("esri.views.LayerViewManager");let G=function(){function r(d,b,a){this.layer=d;this.view=b;this.layerViewImporter=a;this._controller=m.createAbortController();this._deferred=m.createDeferred();this.done=this._started=!1;m.onAbort(this._controller.signal,()=>{const f=new t("cancelled:layerview-create","layerview creation cancelled",{layer:d});this._deferred.reject(f)})}var q=r.prototype;q.destroy=function(){this._controller.abort();const {layerView:d}=
this;if(d){var {layer:b,view:a}=this;b.emit("layerview-destroy",{view:a,layerView:d});a.emit("layerview-destroy",{layer:b,layerView:d});this.done=!0;this.layerViewImporter=this.view=this.layerView=this.layer=null}};q.start=async function(){if(!this._started){this._started=!0;var {_controller:{signal:d},layer:b,view:a}=this;this._map=a.map;try{var f,g;await b.load({signal:d});"prefetchResources"in b&&await b.prefetchResources({signal:d});let c;if(b.createLayerView)c=await b.createLayerView(a,{signal:d});
else{if(!this.layerViewImporter.hasLayerViewModule(b))throw new t("layer:view-not-supported","No layerview implementation was found");var e=await this.layerViewImporter.importLayerView(b);m.throwIfAborted(d);c="default"in e?new e.default({layer:b,view:a}):new e({layer:b,view:a})}let n;e=()=>{n=v.removeMaybe(n);c.destroy();c.layer=null;c.parent=null;c.view=null;this.done=!0};n=m.onAbort(d,e);m.throwIfAborted(d);try{await c.when()}catch(h){throw e(),h;}(null==(f=this._map)?0:null==(g=f.allLayers)?0:
g.includes(b))?(this.layerView=c,b.emit("layerview-create",{view:a,layerView:c}),a.emit("layerview-create",{layer:b,layerView:c}),this.done=!0,this._deferred.resolve(c)):(e(),this._deferred.reject(new t("view:no-layerview-for-layer","The layer has been removed from the map",{layer:b})))}catch(c){b.emit("layerview-create-error",{view:a,error:c}),a.emit("layerview-create-error",{layer:b,error:c}),this.done=!0,this._deferred.reject(new t("layerview:create-error","layerview creation failed",{layer:b,
error:c}))}}};u._createClass(r,[{key:"promise",get:function(){return this._deferred.promise}}]);return r}();k=function(r){function q(b){var a=r.call(this,b)||this;a._layerLayerViewInfoMap=new Map;a._watchUpdatingTracking=new C.WatchUpdatingTracking;a.supportsGround=!0;a._preloadLayerViewModules=()=>{var f;const g=null==(f=a.view.map)?void 0:f.allLayers;if(g)for(const e of g)a.layerViewImporter.hasLayerViewModule(e)&&a.layerViewImporter.importLayerView(e)};a._reschedule=()=>{v.isNone(a._workPromise)&&
(a._workPromise=m.createDeferred());a.handles.remove("reschedule");a.handles.add(A.schedule(a._doWork),"reschedule");return a._workPromise.promise};a._doWork=()=>{var f,g,e,c=a.view.map;a._map!==c&&(a.clear(),a._map=c);if(v.isNone(a._workPromise))a.notifyChange("updating");else{a.handles.remove("reschedule");a.handles.remove("collection-change");var n=new B({root:u._assertThisInitialized(a),rootCollectionNames:a._rootCollectionNames,getChildrenFunction:h=>h.layers});for(const h of n)a._createLayerView(h);
a._refreshCollections();for(const [h,x]of a._layerLayerViewInfoMap)n.includes(h)||(a._layerLayerViewInfoMap.delete(x.layer),x.destroy());n=n.filter(h=>"group"===h.type).map(h=>h.layers);c=[null==c?void 0:null==(f=c.ground)?void 0:f.layers,null==c?void 0:null==(g=c.basemap)?void 0:g.baseLayers,null==c?void 0:null==(e=c.basemap)?void 0:e.referenceLayers,null==c?void 0:c.layers,...n].filter(h=>!!h);a.handles.add(c.map(h=>a._watchUpdatingTracking.addOnCollectionChange(h,a._reschedule)),"collection-change");
a._workPromise.resolve();a._workPromise=null}};return a}u._inheritsLoose(q,r);var d=q.prototype;d.initialize=function(){this.handles.add([w.on(this,"view.map.allLayers","change",this._preloadLayerViewModules,this._preloadLayerViewModules),w.init(this.view,["map.basemap","map.ground","map.layers","ready"],this._reschedule,!0)]);this._preloadLayerViewModules();this._reschedule()};d.destroy=function(){this.clear();this._watchUpdatingTracking.destroy();this._map=null};d.clear=function(){if(!this.destroyed){for(const b of this._layerLayerViewInfoMap.values())b.destroy();
this._layerLayerViewInfoMap.clear();this._refreshCollections()}};d.whenLayerView=async function(b){await this._reschedule();return this._layerLayerViewInfoMap.has(b)?this._layerLayerViewInfoMap.get(b).promise:m.reject(new t("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:b}))};d._refreshCollections=function(){for(const [b,a]of this._layersToLayerViews)this._populateLayerViewsOwners(this.get(b),this.get(a),this.view);this.notifyChange("updating")};d._populateLayerViewsOwners=
function(b,a,f){if(b&&a){var g=0;for(const e of b)(b=this._layerLayerViewInfoMap.get(e))&&b.layerView&&(b=b.layerView,b.layer=e,b.parent=f,a.getItemAt(g)!==b&&a.splice(g,0,b),e.layers&&this._populateLayerViewsOwners(e.layers,b.layerViews,b),g+=1);g<a.length&&a.splice(g,a.length)}else a&&a.removeAll()};d._createLayerView=function(b){if(this._layerLayerViewInfoMap.has(b))this.view.ready&&this._layerLayerViewInfoMap.get(b).start();else{b.load().catch(()=>{});this.layerViewImporter.hasLayerViewModule(b)&&
this.layerViewImporter.importLayerView(b);var a=new G(b,this.view,this.layerViewImporter);a.promise.then(()=>this._refreshCollections(),f=>{if(!f||!m.isAbortError(f)&&"cancelled:layerview-create"!==f.name){var g,e;F.error(`Failed to create layerview for layer title:'${null!=(g=b.title)?g:"no title"}', id:'${null!=(e=b.id)?e:"no id"}' of type '${b.type}'.`,{layer:b,error:f})}this._refreshCollections()});this._layerLayerViewInfoMap.set(b,a);this.view.ready&&a.start()}this.notifyChange("updating")};
u._createClass(q,[{key:"_layersToLayerViews",get:function(){const b=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];this.supportsGround&&b.push(["view.map.ground.layers","view.groundView.layerViews"]);return new Map(b)}},{key:"_rootCollectionNames",get:function(){return Array.from(this._layersToLayerViews.keys())}},{key:"updating",get:function(){return v.isSome(this._workPromise)||
this._watchUpdatingTracking.updating?!0:E.someMap(this._layerLayerViewInfoMap,b=>!b.done)}}]);return q}(D.HandleOwner);l.__decorate([p.property()],k.prototype,"_workPromise",void 0);l.__decorate([p.property({readOnly:!0})],k.prototype,"_watchUpdatingTracking",void 0);l.__decorate([p.property({dependsOn:["supportsGround"],readOnly:!0})],k.prototype,"_layersToLayerViews",null);l.__decorate([p.property({dependsOn:["_layersToLayerViews"],readOnly:!0})],k.prototype,"_rootCollectionNames",null);l.__decorate([p.property()],
k.prototype,"layerViewImporter",void 0);l.__decorate([p.property()],k.prototype,"supportsGround",void 0);l.__decorate([p.property({readOnly:!0,dependsOn:["_workPromise","_watchUpdatingTracking.updating"]})],k.prototype,"updating",null);l.__decorate([p.property({constructOnly:!0})],k.prototype,"view",void 0);return k=l.__decorate([z.subclass("esri.views.LayerViewManager")],k)});