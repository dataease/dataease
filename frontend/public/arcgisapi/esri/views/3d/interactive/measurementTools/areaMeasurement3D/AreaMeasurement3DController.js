// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../../../core/maybe ../../../../../core/Handles ../../../../support/screenUtils ../../../../../layers/graphics/hydratedFeatures ../../../../interactive/dragEventPipeline ../../editingTools/dragEventPipeline3D ./AreaMeasurement3DView".split(" "),function(h,u,l,m,v,w,x){return function(){function n(a,c,g){this._manipulators=g;this._handles=new u;this._tempPickRequest=new x.PickRequest;this.model=a;this.view=c;this.model.reset();this._setupManipulators()}var d=n.prototype;d.destroy=function(){this._handles.destroy();
this._handles=null};d.handleInputEvent=function(a){switch(a.type){case "immediate-click":this._handleImmediateClick(a);break;case "pointer-move":this._handlePointerMove(a);break;case "drag":this._handleDrag(a);break;case "key-down":this._handleKeyDown(a)}};d._setupManipulators=function(){let a=0;const c=b=>e=>{"start"===e.action&&(a++,this.model.lastDraggedVertex=h.unwrap(this.view.manipulatorIdToVertexId(b)),"measured"===this.model.state&&(this.model.state="editing"));return e},g=()=>b=>"end"===
b.action?(a--,0===a&&"editing"===this.model.state&&(this.model.state="measured"),null):b,t=(b,e)=>{this._handles.add([v.createManipulatorDragEventPipeline(e,(f,y,z)=>{const p=w.hideManipulatorWhileDragging(f),k=h.unwrap(this.view.manipulatorIdToVertexId(b));y.next(c(b)).next(p).next(g()).next(this.view.screenToMap3D()).next(q=>{f.location=q.mapEnd;this.model.path.update(k,m.clonePoint(q.mapEnd))});const r=m.clonePoint(this.model.path.vertex(k));z.next(p).next(()=>{this.model.path.update(k,r);f.location=
r})}),e.events.on("double-click",f=>{if("mouse"!==f.pointerType||0===f.button)"drawing"===this.model.state&&this.model.finishMeasurement(),f.stopPropagation()})],`manipulator-${b}`)},A=b=>{this._handles.remove(`manipulator-${b}`)};this._manipulators.forEach(({id:b,manipulator:e})=>{t(b,e)});this._handles.add([this._manipulators.on("after-add",({item:{id:b,manipulator:e}})=>{t(b,e)}),this._manipulators.on("after-remove",({item:{id:b}})=>{A(b)})])};d._handleDrag=function(a){"editing"===this.model.state&&
a.stopPropagation()};d._handleImmediateClick=function(a){if("mouse"!==a.pointerType||0===a.button){var c=l.createScreenPointFromEvent(a);if(this.model.active)switch(this.model.state){case "initial":this._addVertexAt(c)&&(this.model.state="drawing",a.stopPropagation());break;case "drawing":{const g=this.view.vertexHandleAt(c,a.pointerType);if(h.isNone(g)){if(this._addVertexAt(c))return}else 0===g&&(this.model.finishMeasurement(),a.stopPropagation())}}"mouse"===a.pointerType&&this._hoverAt(c)}};d._handlePointerMove=
function(a){"mouse"===a.pointerType&&(a=l.createScreenPointFromEvent(a),this._hoverAt(a))};d._handleKeyDown=function(a){"Enter"===a.key&&"drawing"===this.model.state&&(this.model.finishMeasurement(),a.stopPropagation())};d._hoverAt=function(a){this.view.requiresCursorPoint?(a=this._pick(a),a.mapPoint&&(this.model.cursorPoint=a.mapPoint)):this.model.cursorPoint=null};d._addVertexAt=function(a){a=this._pick(a);return a.mapPoint?(this.model.path.add(a.mapPoint),!0):!1};d._pick=function(a){const c=this._tempPickRequest;
c.screenPoint=a;return this.view.pick(c)};return n}()});