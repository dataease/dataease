// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/Accessor ../../../../core/Evented ../../../../core/mathUtils ../../../support/Scheduler ../../../../core/MapUtils ../../../webgl/Texture ./Texture".split(" "),
function(h,u,m,E,n,F,G,r,H,y,I,J,K,z,A,B,v,w,C,D){var t;h.TextTextureAtlas=t=function(x){function p(a){a=x.call(this,a)||this;a.events=new A;a.glTexture=null;a.needsClear=!1;a.elementsToAddOrUpdate=new Map;a.elementsToRemove=new Map;a.elementsToRender=new Map;a.elements=new Map;a.stageObjects=new Map;a.updating=!1;return a}u._inheritsLoose(p,x);var d=p.prototype;d.initialize=function(){this.id=D.idGen.gen(this.idHint);this.stage=this.view._stage;this.canvas=this.create2DCanvas();this.ctx=this.canvas.getContext("2d");
this.stage.add(4,this);const a=this.computeAtlasResolution(this.view.width,this.view.height);this.createAtlasRegion(a);this.update2DCanvasSize();this.resetAtlasCursor()};d.unload=function(){n.isSome(this.glTexture)&&(this.glTexture.dispose(),this.glTexture=null);this.events.emit("unloaded")};d.createDescriptor=function(a){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:a.parameters.maxMaxAnisotropy}};d.load=
function(a){if(n.isSome(this.glTexture))return this.glTexture;this.glTexture=new C(a,this.createDescriptor(a),this.canvas);this.frameWorker=this.view.resourceController.scheduler.registerTask(v.Task.TEXT_TEXTURE_ATLAS,c=>this.run(c,!0),()=>this.updating);this.setDirty();return this.glTexture};d.dispose=function(){this.elementsToRender=this.elementsToRemove=this.elementsToAddOrUpdate=this.elements=null;this.frameWorker&&(this.frameWorker.remove(),this.frameWorker=null);this.glTexture&&(this.stage.remove(4,
this.id),this.glTexture=null);this.canvas.width=0;this.canvas.height=0;this.ctx=this.canvas=null};d.create2DCanvas=function(){const a=document.createElement("canvas");a.setAttribute("id","canvas2d");a.setAttribute("style","display:none");a.setAttribute("width",(512).toString());a.setAttribute("height",(512).toString());return a};d.update2DCanvasSize=function(){this.canvas.setAttribute("width",this.atlas.size.width.toString());this.canvas.setAttribute("height",this.atlas.size.height.toString())};d.createAtlasRegion=
function(a=512){this.atlas={size:{width:a,height:a},cursor:{x:0,y:0},lineHeight:0}};d.computeAtlasResolution=function(a,c){a=Math.max(a,c);a=B.nextHighestPowerOfTwo(a+256);return a=Math.min(a,4096)};d.resizeAtlas=function(a,c){c=c||a;const b=this.atlas;b.size.width=a;b.size.height=c;n.isSome(this.glTexture)&&this.glTexture.resize(a,c);this.update2DCanvasSize()};d.resetAtlasCursor=function(){const a=this.atlas;a.cursor.x=2;a.cursor.y=4;a.lineHeight=0;this.needsClear=!0};d.getAtlasUsage=function(){const a=
this.atlas;return(a.cursor.x+a.cursor.y*a.size.width)/(a.size.width*a.size.height)};d.getExpectedAtlasUsage=function(){const a=this.elementsToRemove.size,c=this.elementsToAddOrUpdate.size,b=this.elements.size;return this.getAtlasUsage()/b*(b+c-a)};d.addAtlasElement=function(a,c,b,f){const e=this.atlas,{renderedWidth:g,renderedHeight:k,displayWidth:q,displayHeight:l}=a.textRenderer;a.placement.offset.x=e.cursor.x;a.placement.offset.y=e.cursor.y;a.placement.size.width=g;a.placement.size.height=k;a.placement.size.displayWidth=
q;a.placement.size.displayHeight=l;a.placement.uvMinMax=[a.placement.offset.x/e.size.width,1-(a.placement.offset.y+k)/e.size.height,(a.placement.offset.x+g)/e.size.width,1-a.placement.offset.y/e.size.height];e.cursor.x+=b;e.lineHeight=Math.max(e.lineHeight,f);this.elements.set(c,a)};d.removeAtlasElement=function(a){if(a&&this.elements.has(a.textId)){const c=a.placement.offset,b=a.placement.size;this.ctx.clearRect(c.x,c.y,b.width,b.height);this.elements.delete(a.textId)}};d.ensureStageObjects=function(a){var c=
this.stageObjects.get(a);if(c)return c;c=new Set;this.stageObjects.set(a,c);return c};d.addStageObject=function(a,c){this.ensureStageObjects(a).add(c)};d.removeStageObject=function(a,c){(a=this.stageObjects.get(a))&&a.delete(c)&&(c.geometries[0].data.vertexAttributes.size.data=new Float32Array([0,0]),c.geometryVertexAttrsUpdated(0))};d._processAddition=function(a,c){const b=this.atlas;var f=a.textId;const e=a.textRenderer.renderedWidth+2,g=a.textRenderer.renderedHeight+2+2;if(b.cursor.x+e<b.size.width&&
b.cursor.y+g<b.size.height)this.addAtlasElement(a,f,e,g),this.elementsToRender.set(f,a),this.elementsToAddOrUpdate.delete(f);else if(b.cursor.y+g+b.lineHeight<b.size.height)b.cursor.x=2,b.cursor.y+=b.lineHeight,b.lineHeight=0,this.addAtlasElement(a,f,e,g),this.elementsToRender.set(f,a),this.elementsToAddOrUpdate.delete(f);else{a=this.getExpectedAtlasUsage();(f=.85<a&&4096>b.size.width)&&this.resizeAtlas(2*b.size.width,2*b.size.height);if(!c||!f&&.95<a&&4096===b.size.width)return this.processRemovals(),
0;this.repack();return 1}return 0};d.processRemovals=function(){this.elementsToRemove.forEach((a,c)=>{const b=this.stageObjects.get(c);b&&0!==b.size||this.removeAtlasElement(a);b&&0===b.size&&this.stageObjects.delete(c)});this.elementsToRemove.clear()};d.repack=function(){this.processRemovals();this.elements.forEach((a,c)=>{a.rendered=!1;this.elementsToAddOrUpdate.set(c,a)});this.elements.clear();this.resetAtlasCursor();this.elementsToRender.clear()};d.processRenderingRequest=function(a){this.ctx.clearRect(a.placement.offset.x,
a.placement.offset.y,a.placement.size.width,a.placement.size.height);a.textRenderer.render(this.ctx,a.placement.offset.x,a.placement.offset.y);const c=this.stageObjects.get(a.textId);c&&c.forEach(b=>{b.geometries[0].data.vertexAttributes.uv0.data=new Float32Array(a.placement.uvMinMax);b.geometries[0].data.vertexAttributes.size.data=new Float32Array([a.placement.size.displayWidth,a.placement.size.displayHeight]);b.geometryVertexAttrsUpdated(0)});a.rendered=!0};d.run=function(a,c){if(this.glTexture){var b=
!1;w.someMap(this.elementsToAddOrUpdate,(e,g)=>(e=this.elements.get(g))&&e.rendered?((e=this.stageObjects.get(g))&&e.forEach(k=>{const q=k.geometries[0].data.vertexAttributes,l=this.elements.get(g);q.uv0.data=new Float32Array(l.placement.uvMinMax);q.size.data=new Float32Array([l.placement.size.displayWidth,l.placement.size.displayHeight]);k.geometryVertexAttrsUpdated(0)}),this.elementsToAddOrUpdate.delete(g),!1):1===this._processAddition(this.elementsToAddOrUpdate.get(g),c)?b=!0:!1);if(b)this.run(v.noBudget,
!1);else{var f=!1;0<this.elementsToRender.size&&this.needsClear&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.needsClear=!1);w.someMap(this.elementsToRender,(e,g)=>{this.processRenderingRequest(e);this.elementsToRender.delete(g);f=!0;a.madeProgress();return a.done});f&&n.isSome(this.glTexture)&&this.glTexture.setData(this.canvas);this.updating=0<this.elementsToRender.size;!this.updating&&t.test.orderedRepackingEnabled&&this.repackOrdered()}}};d.addTextTexture=function(a,c){const b=
a.key;this.elementsToAddOrUpdate.has(b)||this.elementsToAddOrUpdate.set(b,{textId:b,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:a,rendered:!1});this.addStageObject(b,c);this.elementsToRemove.delete(b);this.setDirty()};d.removeTextTexture=function(a,c){a=a.key;this.elementsToRemove.set(a,this.elements.get(a));this.removeStageObject(a,c)};d.setDirty=function(){this.updating=!0};d.repackOrdered=function(){if(0!==this.elements.size){var a=
[];this.elements.forEach((b,f)=>a.push({element:b,key:f}));var c=!0;for(let b=0;b<a.length-1;b++)if(0<a[b].key.localeCompare(a[b+1].key)){c=!1;break}if(!c||this.elementsToRemove.size){a.sort((b,f)=>b.key.localeCompare(f.key));this.elements.clear();for(const {element:b,key:f}of a)this.elements.set(f,b);this.repack();this.setDirty()}}};u._createClass(p,[{key:"width",get:function(){return this.atlas.size.width}},{key:"height",get:function(){return this.atlas.size.height}},{key:"requiresFrameUpdates",
get:function(){return!1}},{key:"textureId",get:function(){return this.id}},{key:"test",get:function(){const {elements:a,stageObjects:c,elementsToRemove:b,atlas:f}=this,e=this;return{elements:a,stageObjects:c,elementsToRemove:b,atlas:f,resizeAtlas:(g,k)=>e.resizeAtlas(g,k),run:(g,k)=>e.run(g,k)}}}]);return p}(z);h.TextTextureAtlas.test={orderedRepackingEnabled:!1};m.__decorate([r.property({constructOnly:!0})],h.TextTextureAtlas.prototype,"idHint",void 0);m.__decorate([r.property({constructOnly:!0})],
h.TextTextureAtlas.prototype,"view",void 0);m.__decorate([r.property({type:Boolean})],h.TextTextureAtlas.prototype,"updating",void 0);h.TextTextureAtlas=t=m.__decorate([y.subclass("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],h.TextTextureAtlas);h.default=h.TextTextureAtlas;Object.defineProperty(h,"__esModule",{value:!0})});