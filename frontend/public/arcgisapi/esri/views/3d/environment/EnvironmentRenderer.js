// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/Accessor ../../../geometry/support/spatialReferenceUtils ../../../core/Handles ../../../core/watchUtils ./PanoramicAtmosphere ./RealisticAtmosphere ./SimpleAtmosphere ./Stars".split(" "),
function(m,f,e,c,A,B,g,C,t,D,E,F,u,n,v,l,w,p,x,y){const z=[14,15];e=function(q){function h(){var a=q.apply(this,arguments)||this;a._handles=new v;a._initContext=null;a._pendingAtmosphere=null;a._atmosphere=null;a._stars=null;return a}m._inheritsLoose(h,q);var d=h.prototype;d.initialize=function(){this.view._stage.addRenderPlugin(z,this)};d.destroy=function(){this._pendingAtmosphere=c.destroyMaybe(this._pendingAtmosphere);this._atmosphere=c.destroyMaybe(this._atmosphere);this._stars=c.destroyMaybe(this._stars);
this._handles=c.destroyMaybe(this._handles);this.view&&(this.view._stage.removeRenderPlugin(this),this._set("view",null))};d.initializeRenderContext=function(a){this._initContext=a;this._techniqueRepository=this._initContext.shaderTechniqueRep;this.setup()};d.setup=function(){this._handles.add(l.when(this.view,"basemapTerrain",()=>this._updateBasemapTerrain(),!0));this._handles.add([l.init(this.view,["viewingMode","environment.atmosphereEnabled","environment.atmosphere.quality"],()=>this._updateAtmosphere(),
!0),l.init(this.view,"environment.starsEnabled",()=>this._updateStars(),!0)])};d.uninitializeRenderContext=function(){c.isSome(this._stars)&&(this._stars.uninitializeRenderContext(),this._stars.destroy(),this._stars=null);c.isSome(this._atmosphere)&&(this._atmosphere.uninitializeRenderContext(),this._atmosphere.destroy(),this._atmosphere=null)};d.render=function(a){let b=!0;c.isSome(this._stars)&&this._stars.canRender&&(b=this._stars.render(a)&&b);c.isSome(this._atmosphere)&&this._atmosphere.canRender&&
(b=this._atmosphere.render(a)&&b);return b};d._setNeedsRender=function(){this._initContext&&this._initContext.requestRender()};d._updateStars=function(){var a,b,k;const r=null!=(a=null==(b=this.view)?void 0:null==(k=b.environment)?void 0:k.starsEnabled)?a:!1;r&&c.isNone(this._stars)?(this._stars=new y.Stars({view:this.view}),this._stars.initializeRenderContext(this._initContext),this._setNeedsRender()):!r&&c.isSome(this._stars)&&(this._stars.destroy(),this._stars=null,this._setNeedsRender())};d._updateAtmosphere=
function(){var a=this._getAtmosphereType();if(this.atmosphereType!==a)if(this.atmosphereType=a,c.isSome(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null),a=this._getAtmosphereClass()){var b=new a(this.view,this._techniqueRepository);b.initializeRenderContext(this._initContext);c.isNone(this._atmosphere)&&(this._atmosphere=b,this._setNeedsRender());this._pendingAtmosphere=b;b.when().then(()=>{c.isSome(this._atmosphere)&&
this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere);this._pendingAtmosphere=null;this._setNeedsRender();this._updateBasemapTerrain()}).catch(()=>{this._pendingAtmosphere===b&&(this._pendingAtmosphere=null)})}else c.isSome(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),this._updateBasemapTerrain()};d._getAtmosphereClass=function(){const a=this._getAtmosphereType();if(this.atmosphereClassFromType)return this.atmosphereClassFromType(a);
switch(a){case "none":return null;case "realistic":return p.RealisticAtmosphere;case "panoramic":return w;case "simple":return x}};d._getAtmosphereType=function(){const a=this.view.get("environment.atmosphereEnabled"),b=this.view.get("environment.atmosphere.quality"),k=this.view.viewingMode;return!a||null==b||n.isMoon(this.view.spatialReference)?"none":"local"===k?"panoramic":"high"===b&&p.RealisticAtmosphere.isSupported(this._initContext)&&!n.isMars(this.view.spatialReference)?"realistic":"simple"};
d._updateBasemapTerrain=function(){const a=this.view.basemapTerrain;a&&(a.velvetOverground=null!=this._atmosphere&&"simple"===this.atmosphereType)};m._createClass(h,[{key:"canRender",get:function(){return!(!this.view.basemapTerrain||!this.view.basemapTerrain.renderer.canRender)||"global"!==this.view.viewingMode}},{key:"updating",get:function(){return c.isSome(this._pendingAtmosphere)||c.isSome(this._stars)&&this._stars.updating}},{key:"test",get:function(){return{atmosphere:this._atmosphere}}}]);
return h}(u);f.__decorate([g.property({constructOnly:!0})],e.prototype,"view",void 0);f.__decorate([g.property({constructOnly:!0})],e.prototype,"atmosphereClassFromType",void 0);f.__decorate([g.property({dependsOn:["_pendingAtmosphere","_stars.updating"]})],e.prototype,"updating",null);f.__decorate([g.property()],e.prototype,"_pendingAtmosphere",void 0);f.__decorate([g.property()],e.prototype,"_stars",void 0);return e=f.__decorate([t.subclass("esri.views.3d.environment.EnvironmentRenderer")],e)});