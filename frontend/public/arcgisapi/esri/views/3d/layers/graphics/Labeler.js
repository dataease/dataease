// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/promiseUtils ../../../../core/Accessor ../../../../symbols/callouts/calloutUtils ../../../../core/asyncUtils ../../../../core/Handles ../../../support/Scheduler ../../../../core/MapUtils ../../../../layers/support/layerUtils ../../support/debugFlags ../../../../layers/graphics/hydratedFeatures ../../../../layers/support/labelFormatUtils ./Graphics3DCalloutSymbolLayerFactory ./Graphics3DGraphicCreationContext ../../webgl-engine/lib/Layer ../../webgl-engine/lib/TextRenderParameters ../../webgl-engine/lib/TextRenderer ./graphicSymbolUtils ./labelPlacement ../../webgl-engine/lib/MaterialCollection ../../webgl-engine/lib/TextTextureAtlas".split(" "),
function(q,C,u,aa,n,I,ba,v,ca,J,da,ea,fa,r,K,L,D,M,N,O,z,P,Q,R,S,T,U,V,W,X,Y,E,Z){const F=I.getLogger("esri.views.3d.layers.graphics.Labeler");q.Labeler=function(G){function w(){var a=G.apply(this,arguments)||this;a.idHint="__labeler";a._dirty=!1;a.labels=new Map;a.labelsToAdd=new Map;a.labelsToRemove=new Map;a.labelingContexts=[];return a}C._inheritsLoose(w,G);var d=w.prototype;d.setup=function(){if(n.isNone(this.handles)){const a=this.view.resourceController.scheduler;this.handles=new M;this.handles.add([this.view.watch("state.camera",
()=>this.setDirty()),this.view.watch("pixelRatio",()=>this.resetAllLabels()),a.registerTask(N.Task.LABELER,b=>this.update(b),()=>this.needsUpdate())])}n.isNone(this.textTextureAtlas)&&(this.textTextureAtlas=new Z["default"]({idHint:this.idHint+"_atlas",view:this.view}),this.hudMaterialCollection=new E(this.view._stage),this.calloutMaterialCollection=new E(this.view._stage))};d.dispose=function(){this.handles=n.destroyMaybe(this.handles);this.textTextureAtlas=n.disposeMaybe(this.textTextureAtlas);
this.hudMaterialCollection=n.disposeMaybe(this.hudMaterialCollection);this.calloutMaterialCollection=n.disposeMaybe(this.calloutMaterialCollection);this.labelingContexts=[];this.labels.clear();this.labelsToAdd.clear();this.labelsToRemove.clear()};d.isActiveLabelingContext=function(a){return a.active&&z.areLabelsVisible(a.layer)};d.activateLabelingContext=function(a){a.labels.forEach((b,c)=>{this.labels.set(c,b);b.graphics3DGraphic.setVisibilityFlag(0,!0,1)});a.active=!0};d.deactivateLabelingContext=
function(a){a.labels.forEach((b,c)=>{b.graphics3DGraphic.setVisibilityFlag(0,!1,1);this.setLabelGraphicVisibility(b.graphics3DGraphic,!1);this.labels.delete(c)});a.active=!1};d.addLabelTextureToAtlas=function(a){for(const b of a.graphics3DGraphic.labelGraphics){if(!b._labelClass)continue;const c=a.textRenderers[b._labelIndex];c&&this.textTextureAtlas.addTextTexture(c,b.stageObject)}a.rendered=!0};d.removeLabelTextureFromAtlas=function(a){for(const b of a.graphics3DGraphic.labelGraphics){if(!b._labelClass)continue;
const c=a.textRenderers[b._labelIndex];c&&this.textTextureAtlas.removeTextTexture(c,b.stageObject)}a.rendered=!1};d.needsUpdate=function(){return this.view.ready&&this.isDirty};d.update=function(a){this._updateLabels(a);!this._dirty&&this.deconflictor.needsUpdate()&&this.deconflictor.update(a)};d._updateLabels=function(a){if(this._dirty){this._dirty=!1;for(const b of this.labelingContexts)if(this.isActiveLabelingContext(b)){if(!this.hasValidLabelClassContext(b)){if(this.hasInvalidLabelClassContext(b)){this.deactivateLabelingContext(b);
continue}this.createLabelClassContext(b);if(this.hasPendingLabelClassContext(b)){this._dirty=!0;continue}if(!this.hasValidLabelClassContext(b))continue}O.someMap(b.labelsToInitialize,(c,e)=>{this.ensureGraphics3DResources(c)&&(this.labels.set(e,c),this.deconflictor.setDirty(),a.madeProgress());if(c.visible&&c.hasTextTextureResources||!c.visible&&c.hasGraphics3DResources)b.labelsToInitialize.delete(e),a.madeProgress();return a.done})&&(this._dirty=!0)}this.labelsToRemove.forEach(b=>this.removeLabelTextureFromAtlas(b));
this.labelsToRemove.clear();this.labelsToAdd.forEach(b=>this.addLabelTextureToAtlas(b));this.labelsToAdd.clear();this._dirty||this.notifyChange("updating")}};d.hasPendingLabelClassContext=function(a){return a.labelClassPromise&&!!a.labelClassAbortController};d.hasValidLabelClassContext=function(a){return a.labelClassContexts&&a.labelClassContexts.length};d.hasInvalidLabelClassContext=function(a){return null===a.labelClassContexts};d.createLabelClassContextAsync=async function(a){const b=a.labelClassAbortController.signal;
await a.layer.when();r.throwIfAborted(b);a.scaleVisibility&&a.scaleVisibility.updateScaleRangeActive();const c=a.graphics3DCore;var e=c.layer;if((e=e.labelingInfo&&e.labelingInfo.filter(g=>!!g.symbol))&&0!==e.length){var f=Array(e.length),k=!1;await D.forEach(e,async(g,h)=>{var l=g.symbol;const m=X.getGraphics3DSymbol(c.getOrCreateGraphics3DSymbol(l));if(n.isNone(m))F.error("Failed to create Graphics3DSymbol for label");else{await m.load();r.throwIfAborted(b);var p=null;L.isCalloutSupport(l)&&l.hasVisibleCallout()&&
(p=S.make(l,c.symbolCreationContext),await p.load(),r.throwIfAborted(b));l=await D.result(R.createLabelFunction(g,a.layer.fields.map(x=>x.toJSON()),this.view.spatialReference));r.throwIfAborted(b);!0===l.ok?f[h]={labelClass:g,labelFunction:l.value,graphics3DSymbol:m,graphics3DCalloutSymbolLayer:p,calloutSymbolLayerIndex:0,textRenderParameters:this.createTextRenderParameters(m.symbol)}:(F.error(`Label expression failed to evaluate: ${l.error}`),k=!0)}});r.throwIfAborted(b);k||(a.labelClassContexts=
f)}};d.createLabelClassContext=async function(a){a.labelClassPromise||(a.labelClassPromise=this.createLabelClassContextAsync(a).catch(b=>{if(r.isAbortError(b))throw b;a.labelClassContexts=null}).then(()=>{a.labelClassAbortController=null;this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating"));return a.labelClassPromise};d.createTextRenderParameters=function(a){return(a=a.symbolLayers.getItemAt(0))&&"text"===a.type?V.TextRenderParameters.fromSymbol(a,this.view.pixelRatio):null};
d.destroyLabelClassContext=function(a){for(var b of a.labelClassContexts)--b.graphics3DSymbol.referenced,b.graphics3DSymbol=null;b=a.labelClassAbortController;a.labelClassAbortController=r.createAbortController();b&&b.abort();a.labelClassContexts=[];a.labelClassPromise=null;this.notifyChange("updating")};d.createTextSymbolGraphic=function(a,b,c,e,f){a={text:a.text,centerOffset:c.centerOffset,translation:c.translation,elevationOffset:c.elevationOffset,screenOffset:c.screenOffset,anchor:c.anchor,centerOffsetUnits:c.centerOffsetUnits,
verticalOffset:c.verticalOffset,debugDrawBorder:P.LABELS_SHOW_BORDER,displayWidth:a.displayWidth,displayHeight:a.displayHeight};t.graphic=b;t.renderingInfo=null;t.layer=e;return f.createLabel(t,a,this.hudMaterialCollection,this.textTextureAtlas)};d.createLineCalloutGraphic=function(a,b,c,e,f){b={symbol:b,translation:e.translation,elevationOffset:e.elevationOffset,screenOffset:e.screenOffset,centerOffset:e.centerOffset,centerOffsetUnits:e.centerOffsetUnits,materialCollection:this.calloutMaterialCollection};
t.graphic=a;t.renderingInfo=b;t.layer=f;return c.createGraphics3DGraphic(t)};d.ensureGraphics3DResources=function(a){if(a.hasGraphics3DResources)return!1;const b=a.graphics3DGraphic;if(b.destroyed)return!1;this.ensureTextTextureResources(a);const c=a.labelingContext,e=c.labelClassContexts;if(!e||0===e.length||!c.emptySymbolLabelSupported&&0===b._graphics.length)return!1;var f=!1,k=b.graphic;const g=c.layer;var h=z.areLabelsVisible(c.layer);const l=this.view._stage;for(let p=0;p<e.length;p++){const x=
a.textRenderers[p];if(!x)continue;const y=e[p];var m=y.graphics3DSymbol;let A=null;m.symbol&&"label-3d"===m.symbol.type&&(A=m.symbol);const B=m.symbolLayers[0];if(!B)continue;const H=y.labelClass;m=Y.get({graphics3DGraphic:b,labelSymbol:A,labelClass:H,disablePlacement:c.disablePlacement});if(!n.isNone(m)){B.setElevationInfoOverride(c.elevationInfoOverride);f=this.createTextSymbolGraphic(x,k,m,g,B);if(!f)return!1;f._labelClass=H;f._labelIndex=p;b.addLabelGraphic(f,l,c.stageLayer);b.setVisibilityFlag(0,
h,1);b.clearVisibilityFlag(1,1);b.setVisibilityFlag(3,!1,1);f=!0;(h=y.graphics3DCalloutSymbolLayer)&&m.hasLabelVerticalOffset&&(h.setElevationInfoOverride(c.elevationInfoOverride),k=this.createLineCalloutGraphic(k,A,h,m,g))&&(y.calloutSymbolLayerIndex=b.labelGraphics.length,b.addLabelGraphic(k,l,c.stageLayer));break}}c.scaleVisibility&&f&&c.scaleVisibility.updateGraphicLabelScaleVisibility(b);return a.hasGraphics3DResources=!0};d.destroyGraphics3DResources=function(a){const b=a.labelingContext.labelClassContexts;
for(const c of a.graphics3DGraphic.labelGraphics){if(null==c._labelClass)continue;const e=b[c._labelIndex].graphics3DSymbol.symbolLayers[0];if(null!=e)e.onRemoveGraphic(c)}a.graphics3DGraphic.clearLabelGraphics();a.hasGraphics3DResources=!1};d.ensureTextTextureResources=function(a){if(!a.hasTextTextureResources){var b=a.labelingContext,c=b.labelClassContexts;if(c&&0!==c.length){var e=a.graphics3DGraphic.graphic;for(let f=0;f<c.length;f++){const k=c[f];a.textRenderers[f]=null;if(!k.textRenderParameters)continue;
const g=k.labelFunction;let h;if("arcade"===g.type)try{const l=g.needsHydrationToEvaluate()?Q.hydrateGraphic(e,b.layer):e;h=g.evaluate(l)}catch(l){h=null}else h=g.evaluate(e);n.isNone(h)||""===h||/^\s+$/.test(h)||(a.textRenderers[f]=new W.TextRenderer(h,k.textRenderParameters))}a.hasTextTextureResources=!0}}};d.destroyTextTextureResources=function(a){a.textRenderers=[];a.hasTextTextureResources=!1};d.addGraphic=function(a,b){const c={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,
rendered:!1,labelingContext:a,graphics3DGraphic:b,textRenderers:[]};b=b.graphic.uid;a.labels.set(b,c);a.labelsToInitialize.set(b,c);this.setDirty();this.deconflictor.setDirty()};d.removeGraphic=function(a,b){b=b.graphic.uid;const c=a.labels.get(b);c&&(this.destroyGraphic(c,b),a.labels.delete(b),a.labelsToInitialize.delete(b),this.setDirty(),this.deconflictor.setDirty())};d.destroyGraphic=function(a,b){this.labels.has(b)&&(this.labels.delete(b),this.labelsToAdd.delete(b),this.labelsToRemove.delete(b));
a.hasTextTextureResources&&(this.removeLabelTextureFromAtlas(a),this.destroyTextTextureResources(a));a.hasGraphics3DResources&&this.destroyGraphics3DResources(a)};d.labelingInfoChange=async function(a,b){if(b)for(const c of b){if(b=a.labels.get(c))this.removeGraphic(a,b.graphics3DGraphic),this.addGraphic(a,b.graphics3DGraphic)}else return this.visibilityInfoChange(a),this.resetLabels(a),this.createLabelClassContext(a)};d.globalPropertyChanged=function(a,b){for(const c of b.labelClassContexts){const e=
new Map;b.labels.forEach(f=>{f=f.graphics3DGraphic;e.set(f.graphic.uid,f)});n.unwrap(c.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(a,e,f=>f.labelGraphics[0]);c.graphics3DCalloutSymbolLayer&&c.graphics3DCalloutSymbolLayer.globalPropertyChanged(a,e,f=>f.labelGraphics[c.calloutSymbolLayerIndex])}};d.visibilityInfoChange=function(a){const b=a.layer.labelsVisible;b&&!a.active&&this.activateLabelingContext(a);!b&&a.active&&this.deactivateLabelingContext(a);this.setDirty()};d.resetAllLabels=
function(){for(const a of this.labelingContexts)this.resetLabels(a)};d.resetLabels=function(a){a.labels.forEach((b,c)=>{this.destroyGraphic(b,c);b.visible=!1;b.rendered=!1;a.labelsToInitialize.set(c,b)});this.destroyLabelClassContext(a);this.setDirty();this.deconflictor.setDirty()};d.findLabelingContext=function(a){for(const b of this.labelingContexts)if(b.graphics3DCore===a)return b;return null};d.addGraphicsOwner=function(a,b,c){const e=c&&c.emptySymbolLabelSupported||!1,f=c&&c.elevationInfoOverride||
null;c=c&&c.disablePlacement||null;if(!this.findLabelingContext(a)){var k=a.layer,g={graphics3DCore:a,layer:k,scaleVisibility:b,emptySymbolLabelSupported:e,elevationInfoOverride:f,disablePlacement:c,active:k.labelsVisible,labelClassPromise:null,labelClassAbortController:r.createAbortController(),labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new U(`${this.idHint}_${k.uid}`,{isPickable:!0},k.uid)};this.view._stage.add(0,g.stageLayer);this.view._stage.addToViewContent([g.stageLayer.id]);
this.labelingContexts.push(g);this.setDirty();return{addGraphic:h=>this.addGraphic(g,h),removeGraphic:h=>this.removeGraphic(g,h),featureReductionChange:()=>{},layerLabelsEnabled:()=>z.areLabelsVisible(g.layer),labelingInfoChange:h=>this.labelingInfoChange(g,h),elevationInfoChange:()=>this.globalPropertyChanged("elevationInfo",g),slicePlaneEnabledChange:()=>this.globalPropertyChanged("slicePlaneEnabled",g),visibilityInfoChange:()=>this.visibilityInfoChange(g),reset:()=>this.resetLabels(g),clear:()=>
{},processStageDirty:()=>this.view._stage.processDirtyLayer(g.stageLayer.id)}}};d.removeGraphicsOwner=function(a){const b=this.findLabelingContext(a);b&&(a=this.labelingContexts.indexOf(b),this.labelingContexts.splice(a,1),b.labels.forEach(c=>this.removeGraphic(b,c.graphics3DGraphic)),a=b.stageLayer.id,this.view._stage.removeFromViewContent([a]),this.view._stage.remove(0,a),b.stageLayer=null,this.setDirty())};d.setLabelGraphicVisibility=function(a,b){a=a.graphic.uid;const c=this.labels.get(a);c&&
c.visible!==b&&(b&&!c.rendered?(this.labelsToAdd.set(a,c),this.labelsToRemove.delete(a),c.hasTextTextureResources||c.labelingContext.labelsToInitialize.set(a,c)):!b&&c.rendered&&(this.labelsToRemove.set(a,c),this.labelsToAdd.delete(a)),c.visible=b,this.setDirty())};d.setDirty=function(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))};C._createClass(w,[{key:"isDirty",get:function(){return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.updating||this.deconflictor.needsUpdate()}},
{key:"updating",get:function(){return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.updating||this.deconflictor.updating||this.labelingContexts.some(a=>this.hasPendingLabelClassContext(a))}},{key:"updatingProgress",get:function(){if(!this.updating||!this.textTextureAtlas)return 1;const a=0<this.labelingContexts.length?this.labelingContexts.reduce((b,c)=>b+(this.hasPendingLabelClassContext(c)?0:1),0)/this.labelingContexts.length:1;return(this._dirty?0:.3)+(this.textTextureAtlas.updating?
0:.1)+.1*a+.5*this.deconflictor.updatingProgress}},{key:"test",get:function(){return{textTextureAtlas:this.textTextureAtlas,resetAllLabels:()=>this.resetAllLabels()}}}]);return w}(K);u.__decorate([v.property({constructOnly:!0})],q.Labeler.prototype,"view",void 0);u.__decorate([v.property({constructOnly:!0})],q.Labeler.prototype,"deconflictor",void 0);u.__decorate([v.property()],q.Labeler.prototype,"textTextureAtlas",void 0);u.__decorate([v.property({type:Boolean,readOnly:!0,dependsOn:["textTextureAtlas.updating",
"deconflictor.updating"]})],q.Labeler.prototype,"updating",null);q.Labeler=u.__decorate([J.subclass("esri.views.3d.layers.graphics.Labeler")],q.Labeler);const t=new T(null,null,null);Object.defineProperty(q,"__esModule",{value:!0})});