// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../../core/ObjectPool ../../../../core/mathUtils ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../geometry/projectionEllipsoid ../../support/geometryUtils ./FeatureTileDescriptor3D ../../state/Frustum ../../support/FrustumExtentIntersection".split(" "),function(u,v,w,k,x,h,n,m,y){let z=function(){function d(a){this.surfaceElevation=0;this.cache=new Map;({renderCoordsHelper:a}=a);this.frustum=new m.Frustum({renderCoordsHelper:a});this.extendedFrustum=new m.Frustum({renderCoordsHelper:a});
this.intersector=new y.FrustumExtentIntersection({renderCoordsHelper:a});this.renderCoordsHelper=a}var f=d.prototype;f.begin=function(a,b){this.surfaceElevation=b;this.aboveGround=this.renderCoordsHelper.getAltitude(a.eye)>b;this.frustum.update(a);this.shortenFrustumFarPlane(this.frustum);this.updateExtendedFrustum(a)};f.end=function(){this.cache.clear()};f.calculate=function(a){if(this.allTilesInvisible)return 0;const b=1===this.renderCoordsHelper.viewingMode&&2<=a.lij[0]&&6>a.lij[0],c=this.getOrCalculateSingleTileVisibility(a,
!b);return 0!==c&&b?this.calculateAggregatedChildrenVisibility(a):c};f.shortenFrustumFarPlane=function(a){var b=m.Frustum.nearFarLineIndices;const c=a.mutablePoints;for(const l of b){const [g,p]=l;b=c[g];k.subtract(e,c[p],b);k.scale(e,e,.95);k.add(c[p],b,e)}a.updatePoints(c)};f.calculateAggregatedChildrenVisibility=function(a){let b=0;var c=this.cache.get(a.id);if(null!=c)return c;c=q.acquire();a.getChildren(c);for(const l of c){const g=this.calculate(l);if(0!==g&&(b=g,2===g))break}q.release(c);this.cache.set(a.id,
b);return b};f.getOrCalculateSingleTileVisibility=function(a,b){var c=this.cache.get(a.id);if(null!=c)return c;c=this.calculateSingleTileVisibility(a);b&&this.cache.set(a.id,c);return c};f.calculateSingleTileVisibility=function(a){if(!this.aboveGround&&1===this.renderCoordsHelper.viewingMode&&12>a.lij[0]){if(0===this.calculateSingleTileVisibilitySided(a,!1))return this.calculateSingleTileVisibilitySided(a,!0)}else return this.calculateSingleTileVisibilitySided(a,this.aboveGround)};f.calculateSingleTileVisibilitySided=
function(a,b){this.intersector.update(a.extent,a.tilingScheme.spatialReference,this.surfaceElevation,b);a=x.getReferenceEllipsoid(a.tilingScheme.spatialReference).radius;return this.intersector.isVisibleInFrustum(this.extendedFrustum,a)?this.intersector.isVisibleInFrustum(this.frustum,a,!0)?2:1:0};f.updateExtendedFrustum=function(a){this.extendedFrustum.update(a);this.shortenFrustumFarPlane(this.extendedFrustum);var b=this.renderCoordsHelper.worldUpAtPosition(a.eye,e);this.aboveGround||k.negate(b,
b);b=v.acosClamped(-k.dot(b,a.viewForward));this.allTilesInvisible=b>(Math.PI+a.fovY)/2;if(!this.allTilesInvisible&&(this.hasExtendedFrustum=b>a.fovY/2)){a=this.extendedFrustumParameters();b=this.extendedFrustum.mutablePoints;for(let c=0;4>c;c++){const l=a.pointIndices[c],g=b[l],p=this.renderCoordsHelper.getAltitude(g);if(a.needsAltitudeAdjustment(p)){this.renderCoordsHelper.worldUpAtPosition(g,e);switch(l){case 4:case 7:case 0:case 3:h.plane.projectVector(this.extendedFrustum.planes[0],e,e);break;
case 5:case 6:case 1:case 2:h.plane.projectVector(this.extendedFrustum.planes[1],e,e)}k.scale(e,e,a.direction);this.renderCoordsHelper.intersectInfiniteManifold(h.ray.wrap(g,e),a.zWithMargin,g)}}this.extendedFrustum.updatePoints(b);h.plane.fromPoints(b[0],b[1],b[2],r);h.plane.fromPoints(b[1],b[2],b[3],t);0>k.dot(h.plane.normal(r),h.plane.normal(t))&&(a=this.extendedFrustum.mutablePoints,this.aboveGround?[a[0],a[1]]=[a[1],a[0]]:[a[3],a[2]]=[a[2],a[3]],this.extendedFrustum.updatePoints(a))}};f.extendedFrustumParameters=
function(){return this.aboveGround?this.extendedFrustumParametersAboveSurface():this.extendedFrustumParametersBelowSurface()};f.extendedFrustumParametersAboveSurface=function(){const a=this.surfaceElevation-1;return{zWithMargin:a,pointIndices:m.Frustum.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment(b){return b>a}}};f.extendedFrustumParametersBelowSurface=function(){const a=this.surfaceElevation+1;return{zWithMargin:a,pointIndices:m.Frustum.planePointIndices.top,direction:1,needsAltitudeAdjustment(b){return b<
a}}};return d}();const e=w.create(),r=h.plane.create(),t=h.plane.create(),q=new u(Array,d=>{4!==d.length&&(d[0]=new n.FeatureTileDescriptor3D,d[1]=new n.FeatureTileDescriptor3D,d[2]=new n.FeatureTileDescriptor3D,d[3]=new n.FeatureTileDescriptor3D)},d=>{d[0].release();d[1].release();d[2].release();d[3].release()});return z});