// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/PooledArray ../../../../core/Accessor ../../../../core/Collection ../../../../core/Handles ../../../../core/watchUtils ../../../../geometry/support/aaBoundingRect ../../../support/Scheduler ./FeatureTileDescriptor3D ./FeatureTileMeasurements3D ../../support/extentUtils".split(" "),
function(c,q,d,F,k,t,G,e,H,u,I,J,K,v,w,x,y,z,h,l,A,B,C){const D=t.getLogger("esri.views.3d.layers.support.FeatureTileTree3D");c.FeatureTileTree3D=function(r){function m(a){a=r.call(this,a)||this;a.tiles=new x;a.tileSize=512;a._idToTile=new Map;a._handles=new y;a._clients=new Set;a._dirty=!1;a._newTiles=new v;return a}q._inheritsLoose(m,r);var f=m.prototype;f.initialize=function(){this._handles.add(this.watch(["tilingScheme","tileSize"],()=>this._reset(),!0));this._handles.add(z.init(this,["tileSize",
"cameraOnSurface.location","tilingScheme","viewState.camera","focus.location"],()=>this._setDirty(),!0));this.scheduler&&(this._frameWorker=this.scheduler.registerTask(l.Task.FEATURE_TILE_TREE,a=>this._update(a),()=>this.updating))};f.destroy=function(){this._frameWorker=k.removeMaybe(this._frameWorker);this._handles=k.destroyMaybe(this._handles)};f.addClient=function(){const a=E++;this._clients.add(a);1===this._clients.size&&this._setDirty();return{remove:()=>this._removeClient(a)}};f._removeClient=
function(a){this._clients.delete(a);this._hasClients||this._clear()};f._setDirty=function(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this._update(l.noBudget))};f._clear=function(){this.tiles.removeAll();this._idToTile.clear();this._reset();this._dirty=!1;this.notifyChange("updating")};f._update=function(a){this._dirty=!1;this._pendingTiles||(this._startUpdate(),k.isSome(this._frameWorker)&&(this._frameWorker.task=l.Task.FEATURE_TILE_TREE_ACTIVE));
this._subdivideTilesForView(a);!this._pendingTiles&&k.isSome(this._frameWorker)&&(this._frameWorker.task=l.Task.FEATURE_TILE_TREE);this.notifyChange("updating")};f._startUpdate=function(){this.suspended||(this.tilingScheme?(this._tileMeasurements||(this._tileMeasurements=new B.FeatureTileMeasurements3D({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize,maxVerticalScreenSize:10})),this._tileMeasurements.begin(this.viewState.camera,this.focus.location,
this.cameraOnSurface.location.z),this._pendingTiles=this._getRootTiles()):this._clear())};f._reset=function(){this._newTiles.clear();this._pendingTiles=this._tileMeasurements=null;this._setDirty()};f._getRootTiles=function(){return this.rootTileIds.map(a=>new A.FeatureTileDescriptor3D(a[0],a[1],a[2],this.tilingScheme))};f._purgeHorizonTiles=function(a){a.sort((b,g)=>{b=b.measures.screenRect;g=g.measures.screenRect;return b[1]+b[3]-(g[1]+g[3])});h.empty(p);for(let b=0;b<a.length;b++)if(h.expand(p,
a.data[b].measures.screenRect),10<h.height(p))return a.data.slice(b,a.length);return[]};f._subdivideTilesForView=function(a){if(this._pendingTiles){for(;0<this._pendingTiles.length&&!a.done;){const b=this._pendingTiles.pop();a.madeProgress();if(!this.filterExtentRect||h.intersects(this.filterExtentRect,b.extent))this._tileMeasurements.updateTile(b),0!==b.measures.visibility&&(b.measures.shouldSplit?(this.tilingScheme.ensureMaxLod(b.lij[0]+1),this._pendingTiles.push(...b.getChildren())):this._newTiles.push(b))}0===
this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}};f._updateTiles=function(a){for(var b of this.tiles.items)b.used=!1;a=a.filter(g=>{const n=this._idToTile.get(g.id);n?(n.copyMeasurementsFrom(g),n.used=!0):this._idToTile.set(g.id,g);return!n});b=this.tiles.items.filter(g=>g.used?!1:(this._idToTile.delete(g.id),!0));this.tiles.removeMany(b);this.tiles.addMany(a);this.sortTiles()};f.sortTiles=
function(){this.tiles.sort((a,b)=>a.measures.visibility!==b.measures.visibility?2===a.measures.visibility?-1:1:a.measures.distance-b.measures.distance);this.tiles.forEach((a,b)=>a.loadPriority=b)};q._createClass(m,[{key:"tilingScheme",get:function(){const a=this.tilingSchemeOwner.tilingScheme;return a?a.clone():null}},{key:"filterExtent",set:function(a){if(a&&!a.spatialReference.equals(this.viewState.spatialReference))D.error("#extent","extent spatial reference needs to be in the same spatial reference as the view");
else{var b=this._get("filterExtent");b===a||b&&a&&b.equals(a)||(a=a?a.clone():null,this._set("filterExtent",a),this._setDirty())}}},{key:"filterExtentRect",get:function(){if(!this.filterExtent||!this.tilingScheme)return null;const a=h.create();C.toBoundingRect(this.filterExtent,a,this.tilingScheme.spatialReference);return a}},{key:"rootTileIds",get:function(){return this.filterExtentRect?this.tilingScheme.rootTilesInExtent(this.filterExtentRect):[[0,0,0]]}},{key:"suspended",set:function(a){a!==this._get("suspended")&&
(this._set("suspended",a),this._setDirty())}},{key:"updating",get:function(){return this._dirty||!!this._pendingTiles}},{key:"_hasClients",get:function(){return 0<this._clients.size}}]);return m}(w);d.__decorate([e.property({constructOnly:!0})],c.FeatureTileTree3D.prototype,"scheduler",void 0);d.__decorate([e.property({constructOnly:!0})],c.FeatureTileTree3D.prototype,"renderCoordsHelper",void 0);d.__decorate([e.property({constructOnly:!0})],c.FeatureTileTree3D.prototype,"tilingSchemeOwner",void 0);
d.__decorate([e.property({constructOnly:!0})],c.FeatureTileTree3D.prototype,"cameraOnSurface",void 0);d.__decorate([e.property({constructOnly:!0})],c.FeatureTileTree3D.prototype,"focus",void 0);d.__decorate([e.property({constructOnly:!0})],c.FeatureTileTree3D.prototype,"viewState",void 0);d.__decorate([e.property()],c.FeatureTileTree3D.prototype,"tiles",void 0);d.__decorate([e.property()],c.FeatureTileTree3D.prototype,"tileSize",void 0);d.__decorate([e.property({readOnly:!0,dependsOn:["tilingSchemeOwner.tilingScheme"]})],
c.FeatureTileTree3D.prototype,"tilingScheme",null);d.__decorate([e.property()],c.FeatureTileTree3D.prototype,"filterExtent",null);d.__decorate([e.property({readOnly:!0,dependsOn:["filterExtent","tilingScheme"]})],c.FeatureTileTree3D.prototype,"filterExtentRect",null);d.__decorate([e.property({readOnly:!0,dependsOn:["filterExtentRect"]})],c.FeatureTileTree3D.prototype,"rootTileIds",null);d.__decorate([e.property({value:!1})],c.FeatureTileTree3D.prototype,"suspended",null);d.__decorate([e.property({readOnly:!0})],
c.FeatureTileTree3D.prototype,"updating",null);c.FeatureTileTree3D=d.__decorate([u.subclass("esri.views.3d.layers.support.FeatureTileTree3D")],c.FeatureTileTree3D);let E=0;const p=h.create();c.default=c.FeatureTileTree3D;Object.defineProperty(c,"__esModule",{value:!0})});