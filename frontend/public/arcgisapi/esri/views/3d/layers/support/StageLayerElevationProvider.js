// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/Accessor ../../../../core/Evented ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../core/unitUtils ../../../../geometry/support/aaBoundingRect ../../../../symbols/support/unitConversionUtils ../../../../geometry/support/aaBoundingBox ../../webgl-engine/lib/Intersector".split(" "),
function(f,y,k,J,z,A,K,m,L,B,M,N,O,C,D,p,n,E,F,G,l,H){const I=A.getLogger("esri.views.3d.layers.support.StageLayerElevationProvider");f.StageLayerElevationProvider=function(w){function q(a){a=w.call(this,a)||this;a.elevationOffset=0;a.layerDirtyNotificationHandle=null;return a}y._inheritsLoose(q,w);var g=q.prototype;g.initialize=function(){this.renderCoordsHelper=this.view.renderCoordsHelper;this.intersectLayers=[this.stageLayer];this.intersector=new H.Intersector(this.view.state.mode);this.intersector.options.store=
0;const a=this.computeLayerExtent(this.stageLayer);this.zmin=a[2];this.zmax=a[5];this.layerDirtyNotificationHandle=this.stageLayer.on("dirty",b=>this.stageLayerChanged(b.origin,b.dirtyType,b.subObject))};g.dispose=function(){this.layerDirtyNotificationHandle.remove()};g.elevationInfoChanged=function(){const a=null!=this.layer?this.layer.elevationInfo:null;if(null!=a&&"on-the-ground"!==a.mode){const b=E.getMetersPerVerticalUnitForSR(this.layer.spatialReference),d=G.getMetersPerUnit(a.unit);this.elevationOffset=
z.unwrapOr(a.offset,0)*d/b}else this.elevationOffset=0};g.getElevation=function(a,b,d,h){c[0]=a;c[1]=b;c[2]=d;if(!this.renderCoordsHelper.toRenderCoords(c,h,c))return I.error("could not project point for elevation alignment"),null;b=this.elevationOffset;a=this.zmin+b;b=this.zmax+b;n.copy(r,c);n.copy(t,c);this.renderCoordsHelper.setAltitude(b,r);this.renderCoordsHelper.setAltitude(a,t);this.intersector.reset(r,t);this.intersector.intersect(this.intersectLayers,null,null,1,null,x=>x.metadata&&x.metadata.isElevationSource);
return this.intersector.results.min.getIntersectionPoint(c)?this.renderCoordsHelper.getAltitude(c):null};g.stageLayerChanged=function(a,b,d){switch(b){case "layerObjectAdded":case "layerObjectRemoved":case "objGeometryAdded":d.metadata&&d.metadata.isElevationSource&&this.objectChanged(d);break;case "objGeometryRemoved":case "vertexAttrsUpdated":case "objTransformation":a.metadata&&a.metadata.isElevationSource&&this.objectChanged(a)}};g.objectChanged=function(a){if(this.spatialReference){l.empty(e);
a.metadata.lastValidElevationBB.isEmpty()||this.expandExtent(a.metadata.lastValidElevationBB.bbMin,a.metadata.lastValidElevationBB.bbMax,e);const b=a.getBBMin(!1),d=a.getBBMax(!1);this.expandExtent(b,d,e);l.toRect(e,u);this.zmin=Math.min(this.zmin,e[2]);this.zmax=Math.max(this.zmax,e[5]);v.extent=u;v.spatialReference=this.spatialReference;this.emit("elevation-change",v);n.copy(a.metadata.lastValidElevationBB.bbMin,b);n.copy(a.metadata.lastValidElevationBB.bbMax,d)}};g.computeLayerExtent=function(a){l.empty(e);
for(const b of a.getObjects())this.expandExtent(b.getBBMin(!1),b.getBBMax(!1),e);return e};g.expandExtent=function(a,b,d){for(let h=0;8>h;++h)c[0]=h&1?a[0]:b[0],c[1]=h&2?a[1]:b[1],c[2]=h&4?a[2]:b[2],this.renderCoordsHelper.fromRenderCoords(c,c,this.spatialReference),l.expandWithVec3(d,c);return d};return q}(D.EventedMixin(C));k.__decorate([m.property({constructOnly:!0})],f.StageLayerElevationProvider.prototype,"layer",void 0);k.__decorate([m.property({constructOnly:!0})],f.StageLayerElevationProvider.prototype,
"stageLayer",void 0);k.__decorate([m.property({constructOnly:!0})],f.StageLayerElevationProvider.prototype,"view",void 0);k.__decorate([m.property({readOnly:!0,aliasOf:"view.spatialReference"})],f.StageLayerElevationProvider.prototype,"spatialReference",void 0);f.StageLayerElevationProvider=k.__decorate([B.subclass("esri.views.3d.layers.support.StageLayerElevationProvider")],f.StageLayerElevationProvider);const e=l.empty(),u=F.empty(),v={spatialReference:null,extent:u,context:"scene"},c=p.create(),
r=p.create(),t=p.create();Object.defineProperty(f,"__esModule",{value:!0})});