// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/promiseUtils ../../../geometry/Extent ../../../core/asyncUtils ../../../core/watchUtils ../../../geometry/support/aaBoundingRect ../../layers/RefreshableLayerView ../support/debugFlags ../webgl-engine/lib/RenderGeometry ../webgl-engine/lib/Texture ./LayerView3D ../../layers/LayerView ../webgl-engine/materials/ImageMaterial ./support/overlayImageUtils ./support/projectExtentUtils".split(" "),
function(A,q,n,B,Q,r,R,C,S,T,U,l,z,D,E,k,F,G,H,I,J,K,L,u,M){const v=B.getLogger("esri.views.3d.layers.DynamicLayerView3D");n=function(w){function x(){var a=w.apply(this,arguments)||this;a.drapeSourceType=0;a.fullExtentInLocalViewSpatialReference=null;a.maximumDataResolution=null;a._images=[];a._extents=[];a._overlayExtents=[];a.updateWhenStationary=!0;return a}A._inheritsLoose(x,w);var e=x.prototype;e.initialize=function(){this.addResolvingPromise(M.toViewIfLocal(this).then(a=>this._set("fullExtentInLocalViewSpatialReference",
a)));this.updatingHandles.add(this,"suspended",()=>this._suspendedChangeHandler());this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks(()=>{this._isScaleRangeActive()&&this.notifyChange("suspended")},()=>{}));this._isScaleRangeLayer()&&this.updatingHandles.add(this.layer,"scaleRangeId",()=>this.notifyChange("suspended"));"local"===this.view.viewingMode&&this.updatingHandles.add(this.view.basemapTerrain,"extent",()=>this._overlayExtents.forEach((a,c)=>this._updateImageExtent(c)))};
e.destroy=function(){this.clear()};e.setDrapingExtent=function(a,c,d,b,g,h){this._overlayExtents[a]={extent:k.create(c),spatialReference:d,resolution:b,renderLocalOrigin:g,pixelRatio:h};this._updateImageExtent(a)};e._updateImageExtent=function(a){const c=this._overlayExtents[a],d=this._clippedExtent(c.extent,N),b=u.computeImageExportSize(c.extent,d,c.resolution);let g=c.pixelRatio*this.view.pixelRatio;if("imageMaxWidth"in this.layer||"imageMaxHeight"in this.layer){var h=this.layer.imageMaxWidth,f=
this.layer.imageMaxHeight;if(b.width>h){const m=h/b.width;b.height=Math.floor(b.height*m);b.width=h;g*=m}b.height>f&&(h=f/b.height,b.width=Math.floor(b.width*h),b.height=f,g*=h)}f=this._extents[a];f&&k.equals(f.extent,d)&&!this._imageSizeDiffers(d,f.imageSize,b)||(this._extents[a]={extent:k.create(d),spatialReference:c.spatialReference,imageSize:b,pixelRatio:g},this.suspended||this._fetch(a).catch(m=>{l.isAbortError(m)||v.error(m)}))};e.clear=function(){for(let a=0;a<this._images.length;a++)this._clearImage(a)};
e.doRefresh=async function(a){if(!this.suspended){var c=[];for(let d=0;d<this._extents.length;d++)this._extents[d]&&c.push(this._fetch(d,a));await l.eachAlways(c)}};e.canResume=function(){if(!w.prototype.canResume.call(this))return!1;if(this._isScaleRangeLayer()){const {minScale:a,maxScale:c}=this.layer;if(0<a||0<c){const d=this.view.scale;if(d<c||0<a&&d>a)return!1}}return!0};e.isUpdating=function(){return this._images.some(a=>!!a.loadingPromise)};e.processResult=async function(a,c,d){if(c instanceof
HTMLImageElement||c instanceof HTMLCanvasElement)a.image=c};e.findExtentInfoAt=function(a){for(const c of this._extents){const d=c.extent;if((new z(d[0],d[1],d[2],d[3],c.spatialReference)).contains(a))return c}return null};e.getFetchOptions=function(){};e.redraw=async function(a,c){await D.forEach(this._images,async(d,b)=>{d&&(await a(d,c),this._createStageObjects(b,d.image))})};e._imageSizeDiffers=function(a,c,d){if(!this.maximumDataResolution||G.TESTS_DISABLE_UPDATE_THRESHOLDS)return!0;const b=
k.width(a)/this.maximumDataResolution.x;a=k.height(a)/this.maximumDataResolution.y;a=Math.abs(a/c.height-a/d.height);return 1.5<Math.abs(b/c.width-b/d.width)||1.5<a?!0:!1};e._fetch=async function(a,c){if(!this.suspended){var d=this._overlayExtents[a],b=this._extents[a],g=b.extent,h=new z(g[0],g[1],g[2],g[3],b.spatialReference);this._images[a]||(this._images[a]={texture:null,material:null,rendergeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:k.create(g)});
var f=this._images[a];f.loadingAbortController&&(f.loadingAbortController.abort(),f.loadingAbortController=null);if(0===h.width||0===h.height)this._clearImage(a);else{var m=l.createAbortController();f.loadingAbortController=m;l.onAbort(c,()=>m.abort());var y=m.signal,t=this._waitFetchReady(y).then(()=>{const p={requestAsImageElement:!0,pixelRatio:d.pixelRatio,...this.getFetchOptions(),signal:y},{height:O,width:P}=b.imageSize;return this.layer.fetchImage(h,P,O,p)}).then(p=>{if(l.isAborted(y))throw v.warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),
l.createAbortError();return this.processResult(f,p)});f.loadingPromise=t;l.always(t,()=>{t===f.loadingPromise&&(f.loadingPromise=null,f.loadingAbortController=null)});c=t.then(()=>{k.set(f.renderExtent,g);this._createStageObjects(a,f.image);this.notifyChange("updating")}).catch(p=>{p&&!l.isAbortError(p)&&v.error(p);this.notifyChange("updating");throw p;});this.notifyChange("updating");await c}}};e._clearImage=function(a){a=this._images[a];const c=this.view._stage;a&&(a.rendergeometry&&(this.view.basemapTerrain.overlayManager.renderer.removeGeometries([a.rendergeometry],
this,2),a.rendergeometry=null),a.texture&&(c.remove(4,a.texture.id),a.texture=null),a.material&&(c.remove(3,a.material.id),a.material=null),a.loadingAbortController&&(a.loadingAbortController.abort(),a.loadingAbortController=null),a.loadingPromise=null,a.image=null,a.pixelData=null)};e._createStageObjects=function(a,c){var d=this.view._stage;const b=this._images[a];b.texture&&(d.remove(4,b.texture.id),b.texture=null);c?(b.texture=new I(c,"dynamicLayer",{width:c.width,height:c.height,preMultiplyAlpha:!0,
wrap:{s:33071,t:33071}}),d.add(4,b.texture)):b.material&&(d.remove(3,b.material.id),b.material=null);!b.material&&b.texture?(b.material=new L.ImageMaterial({transparent:!0,textureId:b.texture.id},"dynamicLayer"),d.add(3,b.material)):b.material&&c&&b.material.setParameterValues({textureId:b.texture.id});c=this.view.basemapTerrain.overlayManager.renderer;if(b.material){d=this._overlayExtents[a].renderLocalOrigin;if(0===a)a=u.createGeometryForExtent(b.renderExtent,-1);else if(1===a){a=this._images[0].renderExtent;
if(!a)return;a=u.createOuterImageGeometry(a,b.renderExtent,-1)}else{console.error("DynamicLayerView3D._createStageObjects: Invalid extent idx");return}a=new H(a);a.material=b.material;a.origin=d;c.addGeometries([a],this,2);b.rendergeometry&&c.removeGeometries([b.rendergeometry],this,2);b.rendergeometry=a}else b.rendergeometry&&(c.removeGeometries([b.rendergeometry],this,2),b.rendergeometry=null)};e._isScaleRangeLayer=function(){return"minScale"in this.layer&&"maxScale"in this.layer};e._isScaleRangeActive=
function(){return this._isScaleRangeLayer()?0<this.layer.minScale||0<this.layer.maxScale:!1};e._clippedExtent=function(a,c){if("local"!==this.view.viewingMode)return k.set(c,a);const d=this.view.basemapTerrain,b=d.extent;return d.ready&&b?k.intersection(a,b,c):k.set(c,a)};e._suspendedChangeHandler=function(){this.suspended?this.clear():this.refresh()};e._waitFetchReady=async function(a){this.updateWhenStationary&&await E.whenOnce(this.view,"stationary",a);l.throwIfAborted(a)};return x}(F.RefreshableLayerView(J.LayerView3D(K)));
q.__decorate([r.property()],n.prototype,"layer",void 0);q.__decorate([r.property({dependsOn:["view.scale","layer.minScale","layer.maxScale"]})],n.prototype,"suspended",void 0);q.__decorate([r.property({readOnly:!0})],n.prototype,"fullExtentInLocalViewSpatialReference",void 0);q.__decorate([r.property()],n.prototype,"updating",void 0);n=q.__decorate([C.subclass("esri.views.3d.layers.DynamicLayerView3D")],n);const N=k.create();return n});