// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ../../../core/Logger ../../../core/Evented ../../../core/MemCache ../layers/support/MemoryManagedLayerView".split(" "),function(k,m,n,p,q,l,r){const t=p.getLogger("esri.views.3d.support.MemoryController");let u=function(){function e(a){this._view=a;this.events=new q;this.minQuality=.1;this._maxMemory=500;this._additionalCacheMemory=100;this._quality=1;this._downscaleMemoryUsed=this._stableQuality=0;this._canFastRecover=
!1;this._memoryPredicted=this._memoryUsed=0;this._cacheStorage=new l.MemCacheStorage;this._numQualityChanges=0;this._updating=!1}var b=e.prototype;b.destroy=function(){this.events=null};b.getMemCache=function(a,f){return new l.MemCache(a,this._cacheStorage,f)};b.disableMemCache=function(){this._additionalCacheMemory=-4096};b.resetStableQuality=function(){this._stableQuality=0};b.update=function(){this._updateMemory();if(!(0>=this._memoryPredicted)||this._updating){var a=this._layersUpdating();if(.6>
this._memoryPredicted&&this._canFastRecover)this._stableQuality=this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._updateQuality(1);else if(a){if(1.1<this._memoryPredicted||1<this._memoryUsed)0<this._stableQuality?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1)}else this._downscaleMemoryUsed=
0,1<this._memoryUsed?(this._stableQuality=0,this._canFastRecover=!1,a=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted):this._stableQuality!==this._quality&&(.75>this._memoryUsed&&1>this._quality?(this._stableQuality=this._quality,a=this._updateQuality(this._quality+.05)):1>this._quality&&(this._canFastRecover=!0));this.updating!==a&&(this._updating=a,this.events.emit("updating-changed",this.updating))}};b._updateQuality=function(a){a=Math.min(Math.max(a,this.minQuality),
1);if(a===this._quality)return!1;this._quality=a;this.events.emit("quality-changed",this._quality);++this._numQualityChanges;return!0};b._layersUpdating=function(){return this._view.allLayerViews.some(a=>!!a.updating)};b._updateMemory=function(){let a=0,f=0;this._view.basemapTerrain&&this._view.basemapTerrain.getUsedMemory&&(a+=this._view.basemapTerrain.getUsedMemory());var c=this._view._stage&&this._view._stage.renderView&&this._view._stage.renderView.edgeView;n.isSome(c)&&(a+=c.getUsedMemory());
this._view.allLayerViews&&this._view.allLayerViews.forEach(d=>{if(r.isMemoryManagedLayerView(d)){const h=d.ignoresMemoryFactor()?this._quality:1;a+=d.getUsedMemory()*h;f+=d.getUnloadedMemory()*h}});var g=null==this._warnMemoryUsage||Math.round(10*a)!==Math.round(10*this._warnMemoryUsage);c=1048576*this._maxMemory;if(a>c&&g){this._warnMemoryUsage=a;g=h=>(h/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB";const d=Math.round(100*this._quality);t.warn(`Memory Limit exceeded! Limit: ${g(c)} Current: ${g(a)} Projected: ${g(a+
f)} Quality: ${d}%`)}this._memoryUsed=a/c;this._memoryPredicted=(a+f)/c;this._cacheStorage.maxSize=Math.max(0,c-a+1048576*this._additionalCacheMemory);this.events.emit("memory-used",this._memoryUsed)};m._createClass(e,[{key:"maxMemory",set:function(a){null!=a&&0<a&&(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<a&&this._updateQuality(1),this._maxMemory=a)},get:function(){return this._maxMemory}},{key:"additionalCacheMemory",set:function(a){null!=a&&0<=a&&(this._additionalCacheMemory=
a)}},{key:"memoryFactor",get:function(){return this._quality}},{key:"updating",get:function(){return this._updating}},{key:"usedMemory",get:function(){return this._memoryUsed}},{key:"test",get:function(){return{cacheStorage:this._cacheStorage,numQualityChanges:this._numQualityChanges}}}]);return e}();k.newMemoryController=function(e){return new u(e)};Object.defineProperty(k,"__esModule",{value:!0})});