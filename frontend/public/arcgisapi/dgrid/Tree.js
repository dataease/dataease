//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/aspect dojo/Deferred dojo/dom-construct dojo/dom-class dojo/on dojo/promise/all dojo/query dojo/when ./util/has-css3 ./Grid dojo/has!touch?./util/touch".split(" "),function(G,z,H,K,I,v,r,A,J,w,y,B,L,C){return G(null,{collapseOnRefresh:!1,enableTreeTransitions:!0,treeIndentWidth:9,constructor:function(){this._treeColumnListeners=[]},shouldExpand:function(a,b,c){return c},expand:function(a,b,c,d){function g(){h||f._processScroll&&f._processScroll()}
if(!this._treeColumn)return y();var f=this,e=a.element?a:this.row(a),m=!!this._expanded[e.id],n=B("transitionend");a=e.element;a=-1<a.className.indexOf("dgrid-expando-icon")?a:w(".dgrid-expando-icon",a)[0];c=c||!this.enableTreeTransitions;if(a&&a.mayHaveChildren&&(c||b!==m)){var h=void 0===b?!this._expanded[e.id]:b,x=this.getScrollPosition();this._resetExpanded(e.id,h);r.replace(a,"ui-icon-triangle-1-"+(h?"se":"e"),"ui-icon-triangle-1-"+(h?"e":"se"));r.toggle(e.element,"dgrid-row-expanded",h);b=e.element;
var k=b.connected,l={};if(!k){k=l.container=b.connected=v.create("div",{className:"dgrid-tree-container"},b,"after");var t=function(p){var q=f._renderedCollection.getChildren(e.data);f.sort&&0<f.sort.length&&(q=q.sort(f.sort));q.track&&f.shouldTrackCollection&&(k._rows=p.rows=[],q=q.track(),k._handles=[q.tracking,f._observeCollection(q,k,p)]);t.collection=q;return"start"in p?q.fetchRange({start:p.start,end:p.start+p.count}):q.fetch()};"level"in a&&(k.level=t.level=a.level+1);if(this.renderQuery)var D=
d?f._renderedCollection.getChildren(e.data).fetchRange({start:0,end:1}).totalLength.then(function(p){l.start=p-f.minRowsPerPage;l.end=p-1;l.count=f.minRowsPerPage;f._previousScrollPosition=x;return f.renderQuery(t,l)}):this.renderQuery(t,l);else{var E=v.create("div",null,k);D=this._trackError(function(){return f.renderQueryResults(t(l),E,z.mixin({rows:l.rows},"level"in t?{queryLevel:t.level}:null)).then(function(p){v.destroy(E);return p})})}n&&A(k,n,this._onTreeTransitionEnd)}k.hidden=!h;var u=k.style;
if(!n||c)u.display=h?"block":"none",u.height="",g();else{A.once(k,n,g);if(h){u.display="block";var F=k.scrollHeight;u.height="0px"}else r.add(k,"dgrid-tree-resetting"),u.height=k.scrollHeight+"px";setTimeout(function(){r.remove(k,"dgrid-tree-resetting");u.height=h?F?F+"px":"auto":"0px"},0)}}return y(D)},_configColumns:function(){var a=this.inherited(arguments);this._resetExpanded();for(var b=0,c=a.length;b<c;b++)if(a[b].renderExpando){this._configureTreeColumn(a[b]);break}return a},insertRow:function(a,
b,c,d,g){g=g||{};var f=g.queryLevel="queryLevel"in g?g.queryLevel:"level"in b?b.level:0,e=this.inherited(arguments),m=this.row(e);(f=this.shouldExpand(m,f,this._expanded[m.id]))&&this._expandWhenInDom(e,g);(f||!this.collection.mayHaveChildren||this.collection.mayHaveChildren(a))&&r.add(e,"dgrid-row-expandable");return e},_expandWhenInDom:function(a,b,c){a.offsetHeight?(a=this.expand(a,!0,!0,b.scrollingUp),c&&a.then(function(){c.resolve()})):a.parentNode&&this.domNode.offsetHeight&&(this._expandPromises&&
!c&&(c=new I,this._expandPromises.push(c.promise)),setTimeout(this._expandWhenInDom.bind(this,a,b,c),0))},_queueNodeForDeletion:function(a){this.inherited(arguments);var b=a.connected;b&&this._deleteQueue.push(b)},_pruneRow:function(a,b){var c=a.connected,d;if(c){var g=this.row(a).id;this._expanded[g]&&(d=w("\x3e.dgrid-preload",c)[b?1:0])&&(d=this._findPreload(d),d=b?d.next:d.previous,d.expandedContent||(d.expandedContent={}),d.expandedContent[g]=c.offsetHeight)}this.inherited(arguments,[a,b,{treePrune:!0,
removeBelow:b}])},refresh:function(a){this._expandPromises=[];var b=(this.keepScrollPosition||a&&a.keepScrollPosition)&&Object.keys(this._expanded).length?this.inherited(arguments,z.mixin(a||{},{keepScrollPosition:!1})):this.inherited(arguments);return y(b).then(function(){var c=this._expandPromises;delete this._expandPromises;return J(c)}.bind(this))},removeRow:function(a,b,c){var d=a.connected,g={};if(d){d._handles&&(H.forEach(d._handles,function(h){h.remove()}),delete d._handles);d._rows&&(g.rows=
d._rows);var f=w("\x3e.dgrid-row",d);var e=w("\x3e.dgrid-preload",d);if(f&&f.length){if(this._releaseRange){var m=f[0].rowIndex;var n=f[f.length-1].rowIndex;this._releaseRange(this._findPreload(e[0]),!1,m,n)}f.forEach(function(h){c&&c.treePrune?this._pruneRow(h,c.removeBelow):this.removeRow(h,!0,g)},this)}this._removePreloads&&this._removePreloads(e);d._rows&&(d._rows.length=0,delete d._rows);b?this._queueNodeForDeletion(d):v.destroy(d)}this.inherited(arguments)},_refreshCellFromItem:function(a,b){if(!a.column.renderExpando)return this.inherited(arguments);
this.inherited(arguments,[a,b,{queryLevel:w(".dgrid-expando-icon",a.element)[0].level}])},cleanup:function(){this.inherited(arguments);this.collapseOnRefresh&&this._resetExpanded()},_destroyColumns:function(){this.inherited(arguments);for(var a=this._treeColumnListeners,b=a.length;b--;)a[b].remove();this._treeColumnListeners=[];this._treeColumn=null},_calcRowHeight:function(a){var b=a.connected;return this.inherited(arguments)+(b?b.offsetHeight:0)},_configureTreeColumn:function(a){var b=this,c=".dgrid-content .dgrid-column-"+
a.id,d;this._treeColumn=a;if(!a._isConfiguredTreeColumn){var g=a.renderCell||this._defaultRenderCell;a._isConfiguredTreeColumn=!0;a.renderCell=function(e,m,n,h){var x=h&&"queryLevel"in h?h.queryLevel:0,k=!b.collection.mayHaveChildren||b.collection.mayHaveChildren(e);var l=a.renderExpando(x,k,b._expanded[b.collection.getIdentity(e)],e);l.level=x;l.mayHaveChildren=k;(e=g.call(a,e,m,n,h))&&e.nodeType?(n.appendChild(l),n.appendChild(e)):n.insertBefore(l,n.firstChild)};"function"!==typeof a.renderExpando&&
(a.renderExpando=this._defaultRenderExpando)}var f=this._treeColumnListeners;0===f.length&&(f.push(this.on(a.expandOn||".dgrid-expando-icon:click,"+c+":dblclick,"+c+":keydown",function(e){var m=b.row(e);b.collection.mayHaveChildren&&!b.collection.mayHaveChildren(m.data)||"keydown"===e.type&&32!==e.keyCode||"dblclick"===e.type&&d&&1<d.count&&m.id===d.id&&-1<e.target.className.indexOf("dgrid-expando-icon")||b.expand(m);-1<e.target.className.indexOf("dgrid-expando-icon")&&(d&&d.id===b.row(e).id?d.count++:
d={id:b.row(e).id,count:1})})),B("touch")&&f.push(this.on(C.selector(c,C.dbltap),function(){b.expand(this)})))},_defaultRenderExpando:function(a,b,c){var d=this.grid.isRTL?"right":"left",g="dgrid-expando-icon";b&&(g+=" ui-icon ui-icon-triangle-1-"+(c?"se":"e"));return v.create("div",{className:g,innerHTML:"\x26nbsp;",style:"margin-"+d+": "+a*this.grid.treeIndentWidth+"px; float: "+d+";"})},_onNotification:function(a,b){"delete"===b.type&&this._resetExpanded(b.id);this.inherited(arguments)},_onTreeTransitionEnd:function(a){var b=
this,c=this.style.height;c&&(this.style.display="0px"===c?"none":"block");a&&(r.add(this,"dgrid-tree-resetting"),setTimeout(function(){r.remove(b,"dgrid-tree-resetting")},0));this.style.height=""},_resetPlaceHolder:function(a){var b=this._getHeadPreload&&this._getHeadPreload();if(b)if(null!=a)a:for(;b;){var c=b.expandedContent;if(c&&c[a]){delete c[a];this._adjustPreloadHeight(b);break a}b=b.next}else for(a=b;a;)a.expandedContent&&(delete a.expandedContent,this._adjustPreloadHeight(a)),a=a.next},_resetExpanded:function(a,
b){this._resetPlaceHolder(a);null==a?this._expanded={}:b?this._expanded[a]=!0:delete this._expanded[a]},_calculatePreloadHeight:function(a){var b=this.inherited(arguments),c=a.expandedContent;c&&Object.keys(c).forEach(function(d){b+=c[d]});return b},_getRenderedCollection:function(a){return a.level?a.query.collection:this.inherited(arguments)}})});