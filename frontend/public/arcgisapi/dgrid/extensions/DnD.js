//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/aspect dojo/dom-class dojo/topic dojo/touch dojo/has dojo/when dojo/dnd/Source dojo/dnd/Manager dojo/_base/NodeList ../Selection dojo/has!touch?../util/touch".split(" "),function(l,r,t,A,u,B,C,v,m,w,x,D,E,y){var q=l(w,{grid:null,getObject:function(a){var b=this.grid;return b._trackError(function(){return b.collection.get(a.id.slice(b.id.length+5))})},_legalMouseDown:function(a){return this.inherited(arguments)&&a.target!==this.grid.bodyNode},
onDrop:function(a,b,e){var f=this,d=this._targetAnchor=this.targetAnchor,c=this.grid,g=c.collection;!this.before&&d&&(d=d.nextSibling);d=d&&c.row(d);m(d&&g.get(d.id),function(h){if(f!==a)f.onDropExternal(a,b,e,h);else f.onDropInternal(b,e,h)})},onDropInternal:function(a,b,e){var f=this.grid,d=f.collection,c=this,g=c._targetAnchor,h;g&&(h=this.before?g.previousSibling:g.nextSibling);g=f.row(a[0]);(b||h!==a[0]&&(e||!g||f.down(g).element!==a[0]))&&a.forEach(function(p){m(c.getObject(p),function(k){var n=
d.getIdentity(k);f._trackError(function(){var F=d.getIdentity(k),z=e?d.getIdentity(e):null;return(F===z?c._getNextItem(e).then(function(G){e=G}):d[b&&d.copy?"copy":"put"](k,{beforeId:z})).then(function(){c._selectedNodes[n]&&(c._selectedNodes[n]=f.row(n).element)})})})})},_getNextItem:function(a){var b=this.grid;return a&&(a=b.row(a),a.element&&(a=b.down(a),a.element))?m(a.data):m(null)},onDropExternal:function(a,b,e,f){var d=this.grid,c=this.grid.collection,g=a.grid;b.forEach(function(h,p){m(a.getObject(h),
function(k){d._trackError(function(){return c[c.copy?"copy":"put"](k,{beforeId:f?c.getIdentity(f):null}).then(function(){if(!e){if(g){var n=g.collection.getIdentity(k);!p&&a.selectNone();a.delItem(h.id);return g.collection.remove(n)}a.deleteSelectedNodes()}})})})})},onDndStart:function(a){this.inherited(arguments);a===this&&(x.manager().avatar.node.style.width=this.grid.domNode.offsetWidth/2+"px")},onMouseDown:function(a){v("touch")&&this.isDragging&&1<y.countCurrentTouches(a,this.grid.touchNode)?
(B.publish("/dnd/cancel"),x.manager().stopDrag()):this.inherited(arguments)},onMouseMove:function(a){(!v("touch")||1>=y.countCurrentTouches(a,this.grid.touchNode))&&this.inherited(arguments)},checkAcceptance:function(a){return a.getObject&&w.prototype.checkAcceptance.apply(this,arguments)},getSelectedNodes:function(){if(!this.grid.selection)return this.inherited(arguments);var a=new D,b;for(b in this.grid.selection)a.push(this._selectedNodes[b]);return a}});l=l(E,{dndSourceType:"dgrid-row",dndParams:null,
dndConstructor:q,postMixInProperties:function(){this.inherited(arguments);this.dndParams=r.mixin({accept:[this.dndSourceType]},this.dndParams);this.mouseDownEventType=C.press},postCreate:function(){function a(c){d[c.id]=c.element}function b(c){delete d[c.id];u.remove(c.element,"dojoDndItemSelected dojoDndItemAnchor")}this.inherited(arguments);var e=this.dndConstructor||q,f=r.mixin(this.dndParams,{grid:this,dropParent:this.contentNode});"function"===typeof this.expand&&(f.allowNested=!0);this.dndSource=
new e(this.bodyNode,f);var d=this.dndSource._selectedNodes={};this.on("dgrid-select",function(c){t.forEach(c.rows,a)});this.on("dgrid-deselect",function(c){t.forEach(c.rows,b)});this._listeners.push(A.after(this,"destroy",function(){delete this.dndSource._selectedNodes;d=null;this.dndSource.destroy()},!0))},insertRow:function(a){var b=this.inherited(arguments),e="function"===typeof this.getObjectDndType?this.getObjectDndType(a):[this.dndSourceType];u.add(b,"dojoDndItem");this.dndSource.setItem(b.id,
{data:a,type:e instanceof Array?e:[e]});this.selection&&(e=this.collection.getIdentity(a),e in this.selection&&(this.dndSource._selectedNodes[e]=b));return b},removeRow:function(a){var b=this.row(a);this.selection&&b.id in this.selection&&delete this.dndSource._selectedNodes[b.id];this.dndSource.delItem(b.element.id);this.inherited(arguments)}});l.GridSource=q;return l});