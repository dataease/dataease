//>>built
define("./List ./_StoreMixin dojo/_base/declare dojo/_base/lang dojo/dom-construct dojo/on dojo/when dojo/query ./util/misc".split(" "),function(W,X,Y,Z,t,aa,ba,da,P){function Q(a){return a&&(0<=a.className.indexOf("dgrid-row")||0<=a.className.indexOf("dgrid-loading"))}function H(a){return a&&0<=a.className.indexOf("dgrid-preload")}var R=0;return Y([W,X],{minRowsPerPage:25,maxRowsPerPage:250,maxEmptySpace:Infinity,bufferRows:10,farOffRemoval:2E3,queryRowsOverlap:0,pagingMethod:"debounce",pagingDelay:P.defaultDelay,
keepScrollPosition:!1,rowHeight:0,_deleteQueue:[],postCreate:function(){this.inherited(arguments);var a=this;aa(this.bodyNode,"scroll",P[this.pagingMethod](function(b){a._processScroll(b)},null,this.pagingDelay))},renderQuery:function(a,b){var d=this,f=b&&b.container||this.contentNode,c,k=0,e=b&&b.start||0;"level"in a&&(k=c=a.level);var u={query:a,count:0,level:k,top:!1};var q={node:t.create("div",{className:"dgrid-preload",style:{height:"0"}},f),count:0,query:a,next:u,level:k,top:!0};var z=q.node;
z.rowIndex=0;u.previous=q;var x=u.node=t.create("div",{className:"dgrid-preload",style:{height:"0"}},f);q.id=R++;z.setAttribute("data-preloadid",q.id);u.id=R++;x.setAttribute("data-preloadid",u.id);x.rowIndex=this.minRowsPerPage;d._insertPreload(q);var D=t.create("div",{className:"dgrid-loading"},x,"before");t.create("div",{className:"dgrid-below"},D).innerHTML=this.loadingMessage;b=Z.mixin({start:0,count:this.minRowsPerPage},b);null!=c&&(b.queryLevel=c);return this._trackError(function(){var E=a(b);
return d.renderQueryResults(E,x,b).then(function(F){return E.totalLength.then(function(h){var l=F.length,p=x.parentNode;!d._rows||"queryLevel"in b||(d._rows.min=0,d._rows.max=l===h?Infinity:l-1);t.destroy(D);"queryLevel"in b||(d._total=h);0===h&&p&&(d.noDataNode&&t.destroy(d.noDataNode),d._insertNoDataNode(p));q.count=e;u.count=h-l-e;x.rowIndex=e+l;h?d._updatePreloadRowHeights(q):(x.style.display="none",z.style.display="none");d._previousScrollPosition&&p&&p.offsetHeight&&(d.scrollTo(d._previousScrollPosition),
delete d._previousScrollPosition);return ba(d._processScroll()).then(function(){return F})})}).otherwise(function(F){t.destroy(D);throw F;})})},_insertPreload:function(a){var b=this.preload;if(b){for(;b.node.compareDocumentPosition(a.node)&Node.DOCUMENT_POSITION_PRECEDING;)if(b=b.previous,null==b)return;for(;b.node.compareDocumentPosition(a.node)&Node.DOCUMENT_POSITION_FOLLOWING&&b.next;)b=b.next;b.previous.next=a;a.previous=b.previous;a=a.next;a.next=b;b.previous=a}else this.preload=a},refresh:function(a){var b=
this,d=a&&a.keepScrollPosition,f;"undefined"===typeof d&&(d=this.keepScrollPosition);d&&(this._previousScrollPosition=this.getScrollPosition());this.inherited(arguments);if(this._renderedCollection)return this.renderQuery(function(c){c=b._renderedCollection.fetchRange({start:c.start,end:c.start+c.count});c.then(function(k){f=k});return c}).then(function(){b._emitRefreshComplete();return f})},resize:function(){this.inherited(arguments);this._processScroll()},cleanup:function(){this.inherited(arguments);
this.preload=null},renderQueryResults:function(a){var b=this.inherited(arguments),d=this._getRenderedCollection(this.preload);d&&d.releaseRange&&b.then(function(f){f[0]&&!f[0].parentNode.tagName&&a.totalLength.then(function(){d.releaseRange(f[0].rowIndex,f[f.length-1].rowIndex+1)})});return b},_getFirstRowSibling:function(a){return a.lastChild},_calcRowHeight:function(a){var b=a.nextSibling;return b&&!/\bdgrid-preload\b/.test(b.className)?b.offsetTop-a.offsetTop:a.offsetHeight},_calcAverageRowHeight:function(a){for(var b=
a.length,d=0,f=0;f<b;f++)d+=this._calcRowHeight(a[f]);return b&&d?d/b:0},_updatePreloadRowHeights:function(){var a=this.preload,b=0;if(a){for(;a.previous;)a=a.previous;for(;a;)a.rowHeight||(a.rowHeight=this._calcAverageRowHeight(a.node.parentNode.querySelectorAll(".dgrid-row")),this._adjustPreloadHeight(a)),b=a?a.rowHeight:b,a=a.next;this.rowHeight=b}},lastScrollTop:0,_processScroll:function(a){function b(g,n){n=n?"next":"previous";for(var A;A=g[n];)g=A;return g}function d(g,n){function A(){a:{var m=
!n;for(var B=g;B=B[n?"previous":"next"];)if(m===B.top){m=B;break a}m=void 0}if(m&&v!==m&&!H(m.top?m.node.nextSibling:m.node.previousSibling))return r(),g=m,I=g.node,G=n?g.node.offsetTop-z:q-(g.node.offsetTop+g.node.offsetHeight),S=(m=C(I))&&m.rowIndex,K=void 0,m}function C(m){var B=H(m);(m=m[ca])&&!Q(m)&&(m=B&&H(m)?null:(B=A())?B:C(m));return m}function r(){g.count+=L;n&&(I.rowIndex-=L);e._adjustPreloadHeight(g);L=0;e._releaseRange(g,n,S,K)}var v=g;g=b(g,n);var G=n?g.node.offsetTop-z:q-(g.node.offsetTop+
g.node.offsetHeight),T=e.farOffRemoval,I=g.node,ca=n?"previousSibling":"nextSibling",L=0,U=0,K;if(G>2*T){var w;var S=(w=C(I))&&w.rowIndex;for(K=void 0;w&&v!==g;){var V=e._calcRowHeight(w);U+V+T>G||!Q(w)?w=A():(U+=V,L+=w.count||1,e._pruneRow(w,n),"rowIndex"in w&&(K=w.rowIndex),w=C(w))}r();e._deleteNodeQueue()}}function f(g,n){do g=n?g.next:g.previous;while(g&&!g.node.offsetWidth);return g}var c=this.preload,k;this._updatePreloadRowHeights();if(k=c&&c.rowHeight){var e=this,u=e.bodyNode,q=a&&a.scrollTop||
this.getScrollPosition().y,z=u.offsetHeight+q;a=e.lastScrollTop;u=e.bufferRows*k;var x=u-k,D,E=!0;for(e.lastScrollTop=q;c&&!c.node.offsetWidth;)c=c.previous;for(;c&&c!==F;){var F=e.preload;e.preload=c;k=c.node;var h=k.offsetTop;if(z+1+x<h)c=f(c,E=!1);else if(q-1-x>h+k.offsetHeight)c=f(c,E=!0);else{h=((k.top?q-u:z)-h)/c.rowHeight;var l=(z-q+2*u)/c.rowHeight;l+=Math.min(Math.abs(Math.max(Math.min((q-a)*c.rowHeight,e.maxRowsPerPage/2),e.maxRowsPerPage/-2)),10);k.top&&(h-=l);h=Math.max(h,0);10>h&&0<h&&
l+h<e.maxRowsPerPage&&(l+=Math.max(0,h),h=0);l=Math.min(Math.max(l,e.minRowsPerPage),e.maxRowsPerPage,c.count);if(0===l)c=f(c,E);else{l=Math.ceil(l);h=Math.min(Math.floor(h),c.count-l);var p={};c.count-=l;var y=k,J=e.queryRowsOverlap,M=!c.top&&c;if(M)c.previous&&(d(c),0<h&&H(k.previousSibling)?(h=Math.min(c.count,h),c.previous.count+=h,e._adjustPreloadHeight(c.previous,!0),k.rowIndex+=h,J=0):l+=h,c.count-=h),p.start=k.rowIndex-J,p.count=Math.min(l+J,e.maxRowsPerPage),k.rowIndex=p.start+p.count;else{if(c.next)if(y=
k.nextSibling,d(c,!0),H(k.nextSibling))c.next.count+=c.count-h,c.next.node.rowIndex=h+l,e._adjustPreloadHeight(c.next),c.count=h,J=0,y=c.next.node;else var N=!0;p.start=c.count;p.count=Math.min(l+J,e.maxRowsPerPage);p.scrollingUp=!0}N&&y&&y.offsetWidth&&(N=y.offsetTop);e._adjustPreloadHeight(c);"level"in c.query&&(p.queryLevel=c.query.level);if("queryLevel"in p||!(p.start>e._total||0>p.count)){var O=t.create("div",{className:"dgrid-loading",style:{height:l*c.rowHeight+"px"}},y,"before");t.create("div",
{className:"dgrid-"+(M?"below":"above"),innerHTML:e.loadingMessage},O);O.count=l;e._trackError(function(){(function(g,n,A){var C=c.query(p);D=e.renderQueryResults(C,g,p).then(function(r){var v=e._rows;!v||"queryLevel"in p||!r.length||(n?(v.max<=v.min&&(v.min=r[0].rowIndex),v.max=r[r.length-1].rowIndex):(v.max<=v.min&&(v.max=r[r.length-1].rowIndex),v.min=r[0].rowIndex));y=g.nextSibling;t.destroy(g);A&&y&&y.offsetWidth&&e.scrollTo({y:e.bodyNode.scrollTop+y.offsetTop-A});C.totalLength.then(function(G){"queryLevel"in
p||(e._total=G,e._rows&&e._rows.max>=e._total-1&&(e._rows.max=Infinity));n&&(n.count=G-n.node.rowIndex,e._adjustPreloadHeight(n))});e._processScroll();return r},function(r){t.destroy(g);throw r;})})(O,M,N)});c=c.previous}}}}return D}},_adjustPreloadHeight:function(a,b){a.node.style.height=this._calculatePreloadHeight(a,b)+"px"},_calculatePreloadHeight:function(a,b){return Math.min(a.count*a.rowHeight,b?Infinity:this.maxEmptySpace)},_pruneRow:function(a,b,d){this.removeRow(a,!0,d);this._queueNodeForDeletion(a)},
_queueNodeForDeletion:function(a){this._deleteQueue.push(a)},_deleteNodeQueue:function(){for(var a=document.createElement("div"),b=this._deleteQueue,d=b.length;d--;)a.appendChild(b[d]);this._deleteQueue=[];setTimeout(function(){t.destroy(a)},1)},_removePreloads:function(a){if(a&&a.length){var b=this,d=this._getHeadPreload();a.forEach(function(f){if(f=b._findPreload(f,d))f.previous&&(f.previous.next=f.next),f.next&&(f.next.previous=f.previous)})}},_getHeadPreload:function(){var a=this.preload;if(a)for(;a.previous;)a=
a.previous;return a},_findPreload:function(a,b){for(b||(b=this._getHeadPreload());b;){if(b.node===a)return b;b=b.next}},_getRenderedCollection:function(){return this._renderedCollection},_releaseRange:function(a,b,d,f){if(a){var c=a.level;a=this._getRenderedCollection(a);null!=f&&a.releaseRange&&"number"===typeof d&&"number"===typeof f&&(b?a.releaseRange(f,d+1):a.releaseRange(d,f+1),this._rows&&!c&&(this._rows[b?"max":"min"]=f,this._rows.max>=this._total-1&&(this._rows.max=Infinity)))}}})});