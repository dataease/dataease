//>>built
define("dojo/_base/declare dojo/aspect dojo/dom-class dojo/on dojo/_base/lang dojo/has ./util/misc dojo/_base/sniff".split(" "),function(v,r,w,t,x,z,I){function A(a){a.preventDefault()}var J={checkbox:1,radio:1,button:1},B=/\bdgrid-cell\b/,C=/\bdgrid-row\b/,h=v(null,{pageSkip:10,tabIndex:0,keyMap:null,headerKeyMap:null,mouseDownEventType:"mousedown",postMixInProperties:function(){this.inherited(arguments);this.keyMap||(this.keyMap=x.mixin({},h.defaultKeyMap));this.headerKeyMap||(this.headerKeyMap=
x.mixin({},h.defaultHeaderKeyMap))},postCreate:function(){function a(d){var e=d.target;return e.type&&(!J[e.type]||32===d.keyCode)}function c(d){function e(){b._focusedHeaderNode&&(b._focusedHeaderNode.tabIndex=-1);if(b.showHeader){if(k)for(var f=b.headerNode.getElementsByTagName("th"),m=0,q;q=f[m];++m){if(p.test(q.className)){b._focusedHeaderNode=l=q;break}}else b._focusedHeaderNode=l=b.headerNode;l&&(l.tabIndex=b.tabIndex)}}function g(){var f=b._focusedNode||l;if(!p.test(f.className)||!d.contains(f)){for(var m=
d.getElementsByTagName("*"),q=0,y;y=m[q];++q)if(p.test(y.className)){f=b._focusedNode=y;break}l.tabIndex=-1;f.tabIndex=b.tabIndex}}var k=b.cellNavigation,p=k?B:C,n=d===b.headerNode,l=d;n?(e(),b._listeners.push(r.after(b,"renderHeader",e,!0))):b._listeners.push(r.after(b,"renderArray",g,!0),r.after(b,"_onNotification",function(f,m){0===m.totalLength?d.tabIndex=0:1===m.totalLength&&"add"===m.type&&g()},!0));b._listeners.push(t(d,b.mouseDownEventType,function(f){a(f)||b._focusOnNode(f.target,n,f)}));
b._listeners.push(t(d,"keydown",function(f){if(!f.metaKey&&!f.altKey){var m=b[n?"headerKeyMap":"keyMap"][f.keyCode];m&&!a(f)&&m.call(b,f)}}))}this.inherited(arguments);var b=this;this.tabableHeader&&(c(this.headerNode),t(this.headerNode,"dgrid-cellfocusin",function(){b.scrollTo({x:this.scrollLeft})}));c(this.contentNode);this._debouncedEnsureScroll=I.debounce(this._ensureScroll,this)},_pruneRow:function(){var a=this._focusedNode;this._focusedNode=null;this.inherited(arguments);this._focusedNode=a},
removeRow:function(a){if(!this._focusedNode)return this.inherited(arguments);var c=this,b=document.activeElement===this._focusedNode,d=this[this.cellNavigation?"cell":"row"](this._focusedNode),e=d.row||d,g;a=a.element||a;a===e.element&&((g=this.down(e,1,!0))&&g.element!==a||(g=this.up(e,1,!0)),this._removedFocus={active:b,rowId:e.id,columnId:d.column&&d.column.id,siblingId:g&&g.element!==a?g.id:void 0},setTimeout(function(){c._removedFocus&&c._restoreFocus(e.id)},0),this._focusedNode=null);this.inherited(arguments)},
insertRow:function(){var a=this.inherited(arguments);this._removedFocus&&!this._removedFocus.wait&&this._restoreFocus(a);return a},_restoreFocus:function(a){var c=this._removedFocus,b;if((a=(a=a&&this.row(a))&&a.element&&a.id===c.rowId?a:"undefined"!==typeof c.siblingId&&this.row(c.siblingId))&&a.element){if(!a.element.parentNode.parentNode){c.wait=!0;return}"undefined"!==typeof c.columnId&&(b=this.cell(a,c.columnId))&&b.element&&(a=b);c.active&&0!==a.element.offsetHeight?this._focusOnNode(a,!1,null):
(w.add(a.element,"dgrid-focus"),a.element.tabIndex=this.tabIndex,this._focusedNode=a.element)}delete this._removedFocus},addKeyHandler:function(a,c,b){a=r.after(this[b?"headerKeyMap":"keyMap"],a,c,!0);this._listeners.push(a);return a},_ensureRowScroll:function(a){var c=this.getScrollPosition().y;c>a.offsetTop?this.scrollTo({y:a.offsetTop}):c+this.contentNode.offsetHeight<a.offsetTop+a.offsetHeight&&this.scrollTo({y:a.offsetTop-this.contentNode.offsetHeight+a.offsetHeight})},_ensureColumnScroll:function(a){var c=
this.getScrollPosition().x,b=a.offsetLeft;if(c>b)this.scrollTo({x:b});else{var d=this.bodyNode.clientWidth;a=a.offsetWidth;var e=b+a;c+d<e&&this.scrollTo({x:d>a?e-d:b})}},_ensureScroll:function(a,c){!a.column&&!a.row&&a.data&&a.element?this._ensureRowScroll(a.element):(this.cellNavigation&&(this.columnSets||1<this.subRows.length)&&!c&&this._ensureRowScroll(a.row.element),this.bodyNode.clientWidth<this.contentNode.offsetWidth&&this._ensureColumnScroll(a.element))},_focusOnNode:function(a,c,b){var d=
"_focused"+(c?"Header":"")+"Node",e=this[d],g=this.cellNavigation?"cell":"row",k=this[g](a),p;if(a=k&&k.element){if(this.cellNavigation){var n=a.getElementsByTagName("input");var l=0;for(p=n.length;l<p;l++){var f=n[l];if((-1!==f.tabIndex||"_dgridLastValue"in f)&&!f.disabled){f.focus();var m=!0;break}}}null!==b&&(b=x.mixin({grid:this},b),b.type&&(b.parentType=b.type),b.bubbles||(b.bubbles=!0));e&&(w.remove(e,"dgrid-focus"),e.removeAttribute("tabindex"),b&&(b[g]=this[g](e),t.emit(e,"dgrid-cellfocusout",
b)));e=this[d]=a;b&&(b[g]=k);d=this.cellNavigation?B:C;!m&&d.test(a.className)&&(a.tabIndex=this.tabIndex,a.focus());w.add(a,"dgrid-focus");b&&t.emit(e,"dgrid-cellfocusin",b);this._debouncedEnsureScroll(k,c)}},focusHeader:function(a){this._focusOnNode(a||this._focusedHeaderNode,!0)},focus:function(a){(a=a||this._focusedNode)?this._focusOnNode(a,!1):(this._removedFocus&&(this._removedFocus.active=!0),this.contentNode.focus())}}),u=h.moveFocusVertical=function(a,c){if(this._focusedNode&&a.target!==
this.contentNode){var b=this.cellNavigation,d=this[b?"cell":"row"](a);d=b&&d.column.id;c=this.down(this._focusedNode,c,!0);b&&(c=this.cell(c,d));this._focusOnNode(c,!1,a);a.preventDefault()}};v=h.moveFocusUp=function(a){u.call(this,a,-1)};z=h.moveFocusDown=function(a){u.call(this,a,1)};var K=h.moveFocusPageUp=function(a){u.call(this,a,-this.pageSkip)},L=h.moveFocusPageDown=function(a){u.call(this,a,this.pageSkip)},D=h.moveFocusHorizontal=function(a,c){if(this.cellNavigation&&a.target!==this.contentNode){var b=
!this.row(a);this._focusOnNode(this.right(this["_focused"+(b?"Header":"")+"Node"],c),b,a);a.preventDefault()}},E=h.moveFocusLeft=function(a){D.call(this,a,-1)},F=h.moveFocusRight=function(a){D.call(this,a,1)},G=h.moveHeaderFocusEnd=function(a,c){if(this.cellNavigation){var b=this.headerNode.getElementsByTagName("th");this._focusOnNode(b[c?0:b.length-1],!0,a)}a.preventDefault()},M=h.moveHeaderFocusHome=function(a){G.call(this,a,!0)},H=h.moveFocusEnd=function(a,c){var b=this.cellNavigation,d=this.contentNode,
e=d.scrollTop+(c?0:d.scrollHeight);d=d[c?"firstChild":"lastChild"];var g=-1<d.className.indexOf("dgrid-preload"),k=g?d[(c?"next":"previous")+"Sibling"]:d;a.preventDefault();this.scrollTo({y:e});if(g){for(;k&&0>k.className.indexOf("dgrid-row");)k=k[(c?"next":"previous")+"Sibling"];if(!k)return}if(!g||1>d.offsetHeight)b&&(k=this.cell(k,this.cell(a).column.id)),this._focusOnNode(k,!1,a);else{var p=r.after(this,"renderArray",function(n){var l=n[c?0:n.length-1];b&&(l=this.cell(l,this.cell(a).column.id));
this._focusOnNode(l,!1,a);p.remove();return n});this._listeners.push(p)}},N=h.moveFocusHome=function(a){H.call(this,a,!0)};h.defaultKeyMap={32:A,33:K,34:L,35:H,36:N,37:E,38:v,39:F,40:z};h.defaultHeaderKeyMap={32:A,35:G,36:M,37:E,39:F};return h});