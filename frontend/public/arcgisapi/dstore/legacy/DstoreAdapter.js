//>>built
define(["dojo/_base/declare","dojo/_base/array","dojo/store/util/QueryResults"],function(t,q,u){function m(b){return b}var r={store:null,constructor:function(b){this.store=b;if(b._getQuerierFactory("filter")||b._getQuerierFactory("sort"))this.queryEngine=function(a,c){c=c||{};var k=b._getQuerierFactory("filter"),n=k?k(a):m;a=b._getQuerierFactory("sort");var f=m;a&&(f=a(q.map(c.sort,function(h){return{property:h.attribute,descending:h.descending}})));var l=m;isNaN(c.start)&&isNaN(c.count)||(l=function(h){var g=
c.start||0;g=h.slice(g,g+(c.count||Infinity));g.total=h.length;return g});return function(h){return l(f(n(h)))}};var d=this;b.on("add,update,delete",function(a){var c=a.type,k=a.target;d.notify("add"===c||"update"===c?k:void 0,"delete"===c||"update"===c?"id"in a?a.id:b.getIdentity(k):void 0)})},query:function(b,d){d=d||{};var a=this.store.filter(b),c=d.sort;if(c)if("[object Array]"===Object.prototype.toString.call(c))for(b=c.length-1;0<=b;b--){var k=c[b];a=a.sort(k.attribute,k.descending)}else a=
a.sort(c);if(a.track&&!a.tracking){a=a.track();var n=!0}if("start"in d){var f=d.start||0;f=a[a.fetchRangeSync?"fetchRangeSync":"fetchRange"]({start:f,end:d.count?f+d.count:Infinity})}f=f||a[a.fetchSync?"fetchSync":"fetch"]();d=f.totalLength;f=new u(f);f.total=d;f.observe=function(l,h){function g(e){return void 0===e&&n?-1:e}var v=a.on("add",function(e){l(e.target,-1,g(e.index))}),w=a.on("update",function(e){!h&&e.previousIndex===e.index&&isFinite(e.index)||l(e.target,g(e.previousIndex),g(e.index))}),
x=a.on("delete",function(e){l(e.target,g(e.previousIndex),-1)}),p={remove:function(){v.remove();w.remove();x.remove()}};p.cancel=p.remove;return p};return f},notify:function(){}};q.forEach(["get","put","add","remove","getIdentity"],function(b){r[b]=function(){var d=this.store;return(d[b+"Sync"]||d[b]).apply(d,arguments)}});return t(null,r)});