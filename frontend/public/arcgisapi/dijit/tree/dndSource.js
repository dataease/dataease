//>>built
define("dojo/_base/array dojo/_base/declare dojo/dnd/common dojo/dom-class dojo/dom-geometry dojo/_base/lang dojo/mouse dojo/on dojo/touch dojo/topic dojo/dnd/Manager ./_dndSelector".split(" "),function(n,y,z,x,A,m,B,E,F,p,l,C){return y("dijit.tree.dndSource",C,{isSource:!0,accept:["text","treeNode"],copyOnly:!1,dragThreshold:5,betweenThreshold:0,generateText:!0,constructor:function(a,b){b||(b={});m.mixin(this,b);a=b.accept instanceof Array?b.accept:["text","treeNode"];this.accept=null;if(a.length)for(this.accept=
{},b=0;b<a.length;++b)this.accept[a[b]]=1;this.mouseDown=this.isDragging=!1;this.targetBox=this.targetAnchor=null;this.dropPosition="";this._lastY=this._lastX=0;this.sourceState="";this.isSource&&x.add(this.node,"dojoDndSource");this.targetState="";this.accept&&x.add(this.node,"dojoDndTarget");this.topics=[p.subscribe("/dnd/source/over",m.hitch(this,"onDndSourceOver")),p.subscribe("/dnd/start",m.hitch(this,"onDndStart")),p.subscribe("/dnd/drop",m.hitch(this,"onDndDrop")),p.subscribe("/dnd/cancel",
m.hitch(this,"onDndCancel"))]},checkAcceptance:function(){return!0},copyState:function(a){return this.copyOnly||a},destroy:function(){this.inherited(arguments);for(var a;a=this.topics.pop();)a.remove();this.targetAnchor=null},_onDragMouse:function(a,b){var c=l.manager(),h=this.targetAnchor,d=this.current,e=this.dropPosition,f="Over";d&&0<this.betweenThreshold&&(this.targetBox&&h==d||(this.targetBox=A.position(d.rowNode,!0)),a.pageY-this.targetBox.y<=this.betweenThreshold?f="Before":a.pageY-this.targetBox.y>=
this.targetBox.h-this.betweenThreshold&&(f="After"));if(b||d!=h||f!=e){h&&this._removeItemClass(h.rowNode,e);d&&this._addItemClass(d.rowNode,f);if(d)if(d==this.tree.rootNode&&"Over"!=f)c.canDrop(!1);else{b=a=!1;if(c.source==this){b="Over"===f;for(var g in this.selection){h=this.selection[g];if(h.item===d.item){a=!0;break}h.getParent().id!==d.id&&(b=!1)}}c.canDrop(!a&&!b&&!this._isParentChildDrop(c.source,d.rowNode)&&this.checkItemAcceptance(d.rowNode,c.source,f.toLowerCase()))}else c.canDrop(!1);
this.targetAnchor=d;this.dropPosition=f}},onMouseMove:function(a){if(!this.isDragging||"Disabled"!=this.targetState){this.inherited(arguments);var b=l.manager();if(this.isDragging)this._onDragMouse(a);else if(this.mouseDown&&this.isSource&&(Math.abs(a.pageX-this._lastX)>=this.dragThreshold||Math.abs(a.pageY-this._lastY)>=this.dragThreshold)){var c=this.getSelectedTreeNodes();if(c.length){if(1<c.length){var h=this.selection,d=0,e=[],f,g;a:for(;f=c[d++];){for(g=f.getParent();g&&g!==this.tree;g=g.getParent())if(h[g.id])continue a;
e.push(f)}c=e}c=n.map(c,function(k){return k.domNode});b.startDrag(this,c,this.copyState(z.getCopyKeyState(a)));this._onDragMouse(a,!0)}}}},onMouseDown:function(a){if("touchstart"==a.type||B.isLeft(a))this.mouseDown=!0,this.mouseButton=a.button,this._lastX=a.pageX,this._lastY=a.pageY;this.inherited(arguments)},onMouseUp:function(a){this.mouseDown&&(this.mouseDown=!1,this.inherited(arguments))},onMouseOut:function(){this.inherited(arguments);this._unmarkTargetAnchor()},checkItemAcceptance:function(){return!0},
onDndSourceOver:function(a){this!=a?(this.mouseDown=!1,this._unmarkTargetAnchor()):this.isDragging&&l.manager().canDrop(!1)},onDndStart:function(a,b,c){this.isSource&&this._changeState("Source",this==a?c?"Copied":"Moved":"");b=this.checkAcceptance(a,b);this._changeState("Target",b?"":"Disabled");this==a&&l.manager().overSource(this);this.isDragging=!0},itemCreator:function(a){return n.map(a,function(b){return{id:b.id,name:b.textContent||b.innerText||""}})},onDndDrop:function(a,b,c){if("Over"==this.containerState){var h=
this.tree,d=h.model,e=this.targetAnchor,f=!1;this.isDragging=!1;var g=e&&e.item||h.item;if("Before"==this.dropPosition||"After"==this.dropPosition){g=e.getParent()&&e.getParent().item||h.item;var k=e.getIndexInParent();if("After"==this.dropPosition){k=e.getIndexInParent()+1;var q=e.getNextSibling()&&e.getNextSibling().item}else q=e.item}else g=e&&e.item||h.item,f=!0;var t;n.forEach(b,function(r,D){r=a.getItem(r.id);if(-1!=n.indexOf(r.type,"treeNode"))var u=r.data,v=u.item,w=u.getParent().item;a==
this?("number"==typeof k&&g==w&&u.getIndexInParent()<k&&--k,d.pasteItem(v,w,g,c,k,q)):d.isItem(v)?d.pasteItem(v,w,g,c,k,q):(t||(t=this.itemCreator(b,e.rowNode,a)),d.newItem(t[D],g,k,q))},this);f&&this.tree._expandNode(e)}this.onDndCancel()},onDndCancel:function(){this._unmarkTargetAnchor();this.mouseDown=this.isDragging=!1;delete this.mouseButton;this._changeState("Source","");this._changeState("Target","")},onOverEvent:function(){this.inherited(arguments);l.manager().overSource(this)},onOutEvent:function(){this._unmarkTargetAnchor();
var a=l.manager();this.isDragging&&a.canDrop(!1);a.outSource(this);this.inherited(arguments)},_isParentChildDrop:function(a,b){if(!a.tree||a.tree!=this.tree)return!1;var c=a.tree.domNode;a=a.selection;for(b=b.parentNode;b!=c&&!a[b.id];)b=b.parentNode;return b.id&&a[b.id]},_unmarkTargetAnchor:function(){this.targetAnchor&&(this._removeItemClass(this.targetAnchor.rowNode,this.dropPosition),this.dropPosition=this.targetBox=this.targetAnchor=null)},_markDndStatus:function(a){this._changeState("Source",
a?"Copied":"Moved")}})});