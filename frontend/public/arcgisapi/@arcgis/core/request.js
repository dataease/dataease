/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{h as e,a as r}from"./chunks/object.js";import{clone as t,mixin as s}from"./core/lang.js";import o from"./config.js";import{i as n,u as a}from"./chunks/Logger.js";import"./chunks/string.js";import{create as i,isAborted as l,createAbortController as c,onAbort as u,isAbortError as d,createAbortError as p}from"./core/promiseUtils.js";import"./chunks/Message.js";import m from"./core/Error.js";import{isDataProtocol as h,isBlobProtocol as f,normalize as w,getInterceptor as y,isTrustedServer as g,getOrigin as b,toHTTPS as q,addQueryParameter as k,objectToQuery as O,getProxyRule as v,getProxyUrl as x,addQueryParameters as T,addProxyRule as E,removeFile as S,urlToObject as L}from"./core/urlUtils.js";import{id as C}from"./kernel.js";function j(r,t,s=!1,o){return i(((a,i)=>{if(l(o))return void i(U());let c=()=>{p(),i(new Error(`Unable to load ${t}`))},u=()=>{const e=r;p(),a(e)},d=()=>{if(!r)return;const e=r;p(),e.src="",i(U())};const p=()=>{e("esri-image-decode")||(r.removeEventListener("error",c),r.removeEventListener("load",u)),c=null,u=null,r=null,n(o)&&o.removeEventListener("abort",d),d=null,s&&URL.revokeObjectURL(t)};n(o)&&o.addEventListener("abort",d),e("esri-image-decode")?r.decode().then(u,c):(r.addEventListener("error",c),r.addEventListener("load",u))}))}function U(){try{return new DOMException("Aborted","AbortError")}catch{const e=new Error;return e.name="AbortError",e}}async function _(t,s){const n=h(t),i=f(t);i||n||(t=w(t));const d={url:t,requestOptions:{...a(s)}};let p=y(t);if(p){const e=await async function(e,r){if(null!=e.responseData)return e.responseData;e.headers&&(r.requestOptions.headers={...r.requestOptions.headers,...e.headers});e.query&&(r.requestOptions.query={...r.requestOptions.query,...e.query});if(e.before){let t,s;try{s=await e.before(r)}catch(e){t=H("request:interceptor",e,r)}if((s instanceof Error||s instanceof m)&&(t=H("request:interceptor",s,r)),t)throw e.error&&e.error(t),t;return s}}(p,d);if(null!=e)return{data:e,getHeader:A,requestOptions:d.requestOptions,url:d.url};p.after||p.error||(p=null)}if(t=d.url,"image"===(s=d.requestOptions).responseType){if(e("host-webworker")||e("host-node"))throw H("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),d)}else if(n)throw H("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+s.responseType),d);if("head"===s.method){if(s.body)throw H("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),d);if(n||i)throw H("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),d)}if(await async function(){e("host-webworker")?P||(P=await import("./chunks/request.js")):_._abortableFetch||(_._abortableFetch=r.fetch.bind(r))}(),P)return P.execute(t,s);const q=c();u(s,(()=>q.abort()));const k={controller:q,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:p,params:d,redoRequest:!1,useIdentity:D.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},O=await async function(e){let t,s;await async function(e){const t=e.params.url,s=e.params.requestOptions,n=e.controller.signal,a=s.body;let i=null,c=null,u=null;M&&"HTMLFormElement"in r&&(a instanceof FormData?i=a:a instanceof HTMLFormElement&&(c=a,i=new FormData(c)));"string"==typeof a&&(u=a);e.fetchOptions={cache:s.cacheBust&&!_._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:s.headers||{},method:"head"===s.method?"HEAD":"GET",mode:"cors",redirect:"follow",signal:n},(i||u)&&(e.fetchOptions.body=i||u);"anonymous"===s.authMode&&(e.useIdentity=!1);e.hasToken=!!(/token=/i.test(t)||s.query&&s.query.token||i&&i.get&&i.get("token")||c&&c.elements.token);const d=b(t,!0);d&&!e.hasToken&&o.apiKey&&d.endsWith(".arcgis.com")&&"elevation3d.arcgis.com"!==d&&"js.arcgis.com"!==d&&"jsdev.arcgis.com"!==d&&"jsqa.arcgis.com"!==d&&(s.query||(s.query={}),s.query.token=o.apiKey,e.hasToken=!0);if(e.useIdentity&&!e.hasToken&&!e.credentialToken&&!N(t)&&!l(n)){let r;"immediate"===s.authMode?(await B(),r=await C.getCredential(t,{signal:n}),e.credential=r):"no-prompt"===s.authMode?(await B(),r=await C.getCredential(t,{prompt:!1,signal:n}).catch((()=>{})),e.credential=r):C&&(r=C.findCredential(t)),r&&(e.credentialToken=r.token,e.useSSL=!!r.ssl)}}(e);try{do{[t,s]=await $(e)}while(!await K(e,t,s))}catch(r){const s=H("request:server",r,e.params,t);throw s.details.ssl=e.useSSL,e.interceptor&&e.interceptor.error&&e.interceptor.error(s),s}const n=e.params.url;if(/\/sharing\/rest\/(accounts|portals)\/self/i.test(n)&&!e.hasToken&&!e.credentialToken&&s&&s.user&&s.user.username&&!g(n)){const e=b(n,!0);e&&D.trustedServers.push(e)}const a=e.credential;if(a&&C){const e=C.findServerInfo(a.server);let r=e&&e.owningSystemUrl;if(r){r=r.replace(/\/?$/,"/sharing");const e=C.findCredential(r,a.userId);e&&-1===C._getIdenticalSvcIdx(r,e)&&e.resources.unshift(r)}}return{data:s,getHeader:t?e=>t.headers.get(e):A,requestOptions:e.params.requestOptions,ssl:e.useSSL,url:e.params.url}}(k);return p&&p.after&&p.after(O),O}let P;const D=o.request,M="FormData"in r,R=[499,498,403,401],F=["COM_0056","COM_0057","SB_0008"],I=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],A=()=>null;function H(e,r,s,o){let n="Error";const a={url:s.url,requestOptions:s.requestOptions,getHeader:A,ssl:!1};if(r instanceof m)return r.details?(r.details=t(r.details),r.details.url=s.url,r.details.requestOptions=s.requestOptions):r.details=a,r;if(r){const e=o&&(e=>o.headers.get(e)),t=o&&o.status,s=r.message;s&&(n=s),e&&(a.getHeader=e),a.httpStatus=(null!=r.httpCode?r.httpCode:r.code)||t||0,a.subCode=r.subcode,a.messageCode=r.messageCode,"string"==typeof r.details?a.messages=[r.details]:a.messages=r.details}return d(r)?p():new m(e,n,a)}async function B(){C||await import("./identity/IdentityManager.js")}function N(e){return I.some((r=>r.test(e)))}async function $(r){let t=r.params.url;const s=r.params.requestOptions,o=r.fetchOptions,n=f(t)||h(t),a=s.responseType||"json",i=n?0:null!=s.timeout?s.timeout:D.timeout;let l=!1;if(!n){r.useSSL&&(t=q(t)),s.cacheBust&&"default"===o.cache&&(t=k(t,"request.preventCache",Date.now()));let n={...s.query};r.credentialToken&&(n.token=r.credentialToken);let a=O(n);e("esri-url-encodes-apostrophe")&&(a=a.replace(/'/g,"%27"));const i=t.length+1+a.length;let c;l="post"===s.method||!!s.body||i>D.maxUrlLength;const u=s.useProxy||!!v(t);if(u){const e=x(t);c=e.path,!l&&c.length+1+i>D.maxUrlLength&&(l=!0),e.query&&(n={...e.query,...n})}if("HEAD"===o.method&&(l||u)){if(l){if(i>D.maxUrlLength)throw H("request:invalid-parameters",new Error("URL exceeds maximum length"),r.params);throw H("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),r.params)}if(u)throw H("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),r.params)}if(l?(o.method="POST",s.body?t=T(t,n):(o.body=O(n),o.headers["Content-Type"]="application/x-www-form-urlencoded")):t=T(t,n),u&&(r.useProxy=!0,t=`${c}?${t}`),n.token&&M&&o.body instanceof FormData){const e=o.body;e.set?e.set("token",n.token):e.append("token",n.token)}if(s.hasOwnProperty("withCredentials"))r.withCredentials=s.withCredentials;else if(g(t))r.withCredentials=!0;else if(C){const e=C.findServerInfo(t);e&&e.webTierAuth&&(r.withCredentials=!0)}r.withCredentials&&(o.credentials="include")}let c,u,d=0,m=!1;i>0&&(d=setTimeout((()=>{m=!0,r.controller.abort()}),i));try{if("image"!==s.responseType||"default"!==o.cache||"GET"!==o.method||l||function(e){if(e)for(const r of Object.getOwnPropertyNames(e))if(e[r])return!0;return!1}(s.headers)||!n&&!r.useProxy&&D.proxyUrl&&!function(e){const r=b(e);return!r||r.endsWith(".arcgis.com")||-1!==_._corsServers.indexOf(r)||g(r)}(t)){if(c=await _._abortableFetch(t,o),r.useProxy||function(e){if(f(e)||h(e))return;const r=b(e);r&&-1===_._corsServers.indexOf(r)&&_._corsServers.push(r)}(t),c.ok&&"HEAD"!==o.method){switch(a){case"array-buffer":u=await c.arrayBuffer();break;case"blob":case"image":u=await c.blob();break;default:u=await c.text()}if(d&&(clearTimeout(d),d=0),"json"===a||"xml"===a||"document"===a)if(u)switch(a){case"json":u=JSON.parse(u);break;case"xml":u=W(u,"application/xml");break;case"document":u=W(u,"text/html")}else u=null;if(u){if("array-buffer"===a||"blob"===a){const e=c.headers.get("Content-Type");if(/application\/json|text\/plain/i.test(e)&&u["blob"===a?"size":"byteLength"]<=750)try{const e=await new Response(u).json();e.error&&(u=e)}catch{}}"image"===a&&u instanceof Blob&&(u=await z(URL.createObjectURL(u),r,!0))}}}else u=await z(t,r)}catch(e){if("AbortError"===e.name){if(m)throw new Error("Timeout exceeded");throw p("Request canceled")}if(!(!c&&e instanceof TypeError&&D.proxyUrl)||s.body||"post"===s.method||"head"===s.method||r.useProxy)throw e;r.redoRequest=!0,E({proxyUrl:D.proxyUrl,urlPrefix:S(L(t).path)})}finally{d&&clearTimeout(d)}return[c,u]}function W(e,r){let t;try{t=(new DOMParser).parseFromString(e,r)}catch{}if(!t||t.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return t}async function K(e,r,t){var o;if(e.redoRequest)return e.redoRequest=!1,!1;if(!r)return!0;if(!r.ok)throw new Error(`Unable to load ${r.url} status: ${r.status}`);let n,a,i,l;t&&t.error&&(n=s(new Error,t.error)),n&&(a=Number(n.code),i=n.hasOwnProperty("subcode")?Number(n.subcode):null,l=n.messageCode,l=l&&l.toUpperCase());const c=e.params.requestOptions.authMode,u=String(null==(o=e.params.requestOptions.query)?void 0:o.token);if(403===a&&(4===i||n.message&&n.message.toLowerCase().indexOf("ssl")>-1&&-1===n.message.toLowerCase().indexOf("permission"))){if(!e.useSSL)return e.useSSL=!0,!1}else if(e.useIdentity&&("no-prompt"!==c||498===a)&&-1!==R.indexOf(a)&&!N(e.params.url)&&!u.startsWith("AAPK")&&(403!==a||-1===F.indexOf(l)&&(null==i||2===i&&e.credentialToken))){await B();try{const r=await C.getCredential(e.params.url,{error:H("request:server",n,e.params),prompt:"no-prompt"!==c,signal:e.controller.signal,token:e.credentialToken});return e.credential=r,e.credentialToken=r.token,e.useSSL=e.useSSL||r.ssl,!1}catch(r){if("no-prompt"===c)return e.credential=null,e.credentialToken=null,!1;n=r}}if(n)throw n;return!0}function z(e,r,t=!1){const s=r.controller.signal,o=new Image;return r.withCredentials?o.crossOrigin="use-credentials":o.crossOrigin="anonymous",o.alt="",o.src=e,j(o,e,t,s)}_._abortableFetch=null,_._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"];var G=Object.freeze({__proto__:null,default:_});export default _;export{j as l,G as r};
