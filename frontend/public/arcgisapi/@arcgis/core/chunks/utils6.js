/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{u as e}from"../core/scheduling.js";import{fetchMessageBundle as n,substitute as t}from"../intl.js";import{numericTypes as i}from"../layers/support/fieldUtils.js";import"../popup/content/Content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/CustomContent.js";import s from"../popup/FieldInfo.js";import o from"../popup/content/FieldsContent.js";import"../popup/content/MediaContent.js";import a from"../popup/content/TextContent.js";import r from"../popup/ExpressionInfo.js";import{viewScaleRE as l}from"./visualVariableUtils.js";import{g as p}from"./utils7.js";let f=0;const m="expression/";function u(e){return"hasVisualVariables"in e&&e.hasVisualVariables()?e.visualVariables.filter((e=>!l.test(e.valueExpression)&&(!("target"in e)||"outline"!==e.target))):[]}function d(e,n){let t=null;"popupTemplate"in e&&e.popupTemplate&&(t=e.popupTemplate.fieldInfos);const o=e.getField(n);let a=null;if(t&&t.some((e=>!(!e||e.fieldName.toLowerCase()!==o.name.toLowerCase())&&(a=e.clone(),!0))),!a){const e=i.indexOf(o.type)>-1,n="integer"===o.type||"small-integer"===o.type;a=new s({fieldName:o.name,isEditable:o.editable,visible:!0,format:e?{places:n?0:2,digitSeparator:!0}:null})}return a.label||(a.label=o.alias),a}function c(e){const{expression:n,title:t,returnType:i}=e;return new r({name:"expr"+f++,expression:n,title:t,returnType:i})}function x(e){const n="number"===e.returnType?{places:2,digitSeparator:!0}:null;return new s({fieldName:`expression/${e.name}`,visible:!0,format:n})}async function b(i){const s=await n("esri/smartMapping/t9n/smartMapping"),{renderer:o,layer:a,normFieldExpressionTemplate:r}=i,l=[],f=[],m=p(o,u);for(const e of m)if("field"===e.type)l.push(d(a,e.field));else if("normalized-field"===e.type){const n=a.getField(e.field),i=a.getField(e.normalizationField),o=c({type:"expression",expression:`\n      $feature["${n.name}"];\n      $feature["${i.name}"];\n      ${"percentage"===r?`($feature["${n.name}"] / $feature["${i.name}"]) * 100;`:`$feature["${n.name}"] / $feature["${i.name}"];`}\n      `,title:t("percentage"===r?s.normFieldLabelAsPercent:s.normFieldLabel,{expression1:n.alias,expression2:i.alias}),returnType:"number"});l.push(x(o),d(a,e.field),d(a,e.normalizationField)),f.push(o)}else if("expression"===e.type){const n=c(e);l.push(x(n)),f.push(n)}return{fieldInfos:e(l,((e,n)=>e.fieldName===n.fieldName)),expressionInfos:e(f,((e,n)=>e.expression===n.expression))}}async function g(e,i){const{fieldInfos:s,expressionInfos:r}=i,l=await n("esri/smartMapping/t9n/smartMapping");if(s.length>2)return[new o({fieldInfos:s})];const p=[];for(const n of s){const i=n.fieldName;let s=n.label;if(!s){const n=e.getField(i);if(n)s=n.alias||i;else if(r){const e=i.split("expression/")[1],n=r[r.findIndex((n=>n.name===e))];n&&(s=n.title||n.name)}}p.push(new a({text:t(l.fieldInfo,{fieldLabel:s,fieldValue:`{${i}}`})}))}return p}function y(e){return!(!("normalizationField"in e)||!e.normalizationField)||"hasVisualVariables"in e&&e.hasVisualVariables()&&e.visualVariables.some((e=>!(!("normalizationField"in e)||!e.normalizationField)))}export{g as a,b,d as c,m as e,u as g,y as h};
