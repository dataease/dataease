//>>built
define("dojo/_base/declare dojo/_base/lang dojo/Deferred dojo/when dojo/promise/all dojo/store/util/SimpleQueryEngine dojo/store/util/QueryResults".split(" "),function(W,X,Y,U,Z,fa,ha){function aa(a){var b=new Y;a.onsuccess=function(e){b.resolve(e.target.result)};a.onerror=function(){a.error.message=a.webkitErrorMessage;b.reject(a.error)};return b.promise}function M(a,b,e){if(A||N.length){a&&(N.push({cursor:a,priority:b,retry:e}),N.sort(function(f,g){return f.priority>g.priority?1:-1}));if(1<=A)return;
var p=N.pop();a=p&&p.cursor}if(a)try{a["continue"](),A++}catch(f){if("TransactionInactiveError"!==f.name&&0!==f.name||!p)throw f;p.retry()}}function ia(){return!0}function ba(a){function b(g,d){p?g&&e.then(function(h){h.forEach(g,d)}):(g&&f.push(g),e||(e=a.filter(function(h){p=!0;for(var k=0,l=f.length;k<l;k++)f[k].call(d,h);return!0})));return e}var e,p,f=[];return{total:a.total,filter:function(g,d){var h;return b(function(k){h||(h=!g.call(d,k))})},forEach:b,map:function(g,d){var h=[];return b(function(k){h.push(g.call(d,
k))}).then(function(){return h})},then:function(g,d){return b().then(g,d)}}}var N=[],A=0,V=/(.*)\*$/,B=window.IDBKeyRange||window.webkitIDBKeyRange;return W(null,{constructor:function(a){W.safeMixin(this,a);var b=this,e=this.dbConfig;this.indices=e.stores[this.storeName];this.cachedCount={};for(var p in b.indices)a=b.indices[p],"number"===typeof a&&(b.indices[p]={preference:a});this.db=this.db||e.db;if(!this.db){var f=e.openRequest;f||(f=e.openRequest=window.indexedDB.open(e.name||"dojo-db",parseInt(e.version,
10)),f.onupgradeneeded=function(){var g=b.db=f.result,d;for(d in e.stores){var h=e.stores[d];if(g.objectStoreNames.contains(d))k=f.transaction.objectStore(d);else{k=h.idProperty||"id";var k=g.createObjectStore(d,{keyPath:k,autoIncrement:h[k]&&h[k].autoIncrement||!1})}for(var l in h)k.indexNames.contains(l)||"autoIncrement"===l||!1===h[l].indexed||k.createIndex(l,l,h[l])}},e.available=aa(f));this.available=e.available.then(function(g){return b.db=g})}},idProperty:"id",storeName:"",indices:{},queryEngine:fa,
transaction:function(){var a=this;this._currentTransaction=null;return{abort:function(){a._currentTransaction.abort()},commit:function(){a._currentTransaction=null}}},_getTransaction:function(){if(!this._currentTransaction){this._currentTransaction=this.db.transaction([this.storeName],"readwrite");var a=this;this._currentTransaction.oncomplete=function(){a._currentTransaction=null};this._currentTransaction.onerror=function(b){console.error(b)}}return this._currentTransaction},_callOnStore:function(a,
b,e,p){var f=this;return U(this.available,function d(){var h=f._currentTransaction;if(h)var k=!0;else h=f._getTransaction();if(k)try{var l=h.objectStore(f.storeName);e&&(l=l.index(e));var D=l[a].apply(l,b)}catch(E){if("TransactionInactiveError"===E.name||"InvalidStateError"===E.name)return f._currentTransaction=null,d();throw E;}else l=h.objectStore(f.storeName),e&&(l=l.index(e)),D=l[a].apply(l,b);return p?D:aa(D)})},get:function(a){return this._callOnStore("get",[a])},getIdentity:function(a){return a[this.idProperty]},
put:function(a,b){b=b||{};this.cachedCount={};return this._callOnStore(!1===b.overwrite?"add":"put",[a])},add:function(a,b){b=b||{};b.overwrite=!1;return this.put(a,b)},remove:function(a){this.cachedCount={};return this._callOnStore("delete",[a])},query:function(a,b){function e(m,c,r){O++;var n=d.indices[m];if(n&&!1!==n.indexed&&(c=c||n.preference*(r||1)||.001,c>ca))return ca=c,C=m,!0;O++}b=b||{};var p=b.start||0,f=b.count||Infinity,g=b.sort,d=this;if(a.forEach){var h={sort:g},k=this.queryEngine({},
h),l=[],D=0,E=0;return ba({total:{then:function(){return Z(l).then(function(m){return m.reduce(function(c,r){return c+r})*D/(E||1)}).then.apply(this,arguments)}},filter:function(m,c){var r=0,n=[],u,x={},y=[];return Z(a.map(function(v,F){function z(w){ja.push(w);for(var G=[],P=[];n.every(function(K){if(0<K.length)return(K=K[0])&&P.push(K),G.push(K)});){if(r>=p+f||0===P.length){u=!0;return}w=k(P)[0];n[G.indexOf(w)].shift();if(r++>=p&&(y.push(w),!m.call(c,w))){u=!0;return}G=[];P=[]}return!0}var ja=n[F]=
[];v=d.query(v,h);l[F]=v.total;return v.filter(function(w){if(!u){var G=d.getIdentity(w);E++;if(G in x)return!0;D++;x[G]=!0;return z(w)}}).then(function(w){z(null);return w})})).then(function(){return y})}})}var Q=JSON.stringify(a)+"-"+JSON.stringify(b.sort),C,ca=0,O=0,R;for(R in a){var q=a[R];var da=!1,H,I=null;if("boolean"!==typeof q){if(q)if(q.from||q.to)da=!0,function(m,c){I={test:function(r){return!m||m<=r&&(!c||c>=r)},keyRange:m?c?B.bound(m,c,q.excludeFrom,q.excludeTo):B.lowerBound(m,q.excludeFrom):
B.upperBound(c,q.excludeTo)}}(q.from,q.to);else if("object"===typeof q&&q.contains)(function(m){var c,r=(c=m[0])&&c.match&&c.match(V);r?(c=r[1],c=B.bound(c,c+"~")):c=B.only(c);I={test:function(n){return m.every(function(u){var x=u&&u.match&&u.match(V);return x?(u=x[1],n&&n.some(function(y){return y.slice(0,u.length)===u})):n&&-1<n.indexOf(u)})},keyRange:c}})(q.contains);else if(H=q.match&&q.match(V))H=H[1],I=new RegExp("^"+H),I.keyRange=B.bound(H,H+"~");I&&(a[R]=I);e(R,null,da?.1:1)}}if(g)if(g=g[0],
g.attribute===C||e(g.attribute,1))var J=g.descending;else{var S=!0;p=0;f=Infinity}if(C){var T=C in a?(q=a[C])&&q.keyRange?q.keyRange:B.only(q):null;var ea=[T,J?"prev":"next"]}else ea=[];var t=d.cachedPosition;if(t&&t.queryId===Q&&t.offset<p&&1<O){var L=t.preFilterOffset+1;d.cachedPosition=t=X.mixin({},t)}else t=d.cachedPosition={offset:-1,preFilterOffset:-1,queryId:Q},2>O&&(t.offset=t.preFilterOffset=(L=p)-1);var ka=this.queryEngine(a);J={total:{then:function(m){function c(n){d.cachedCount[Q]=n;return Math.round((t.offset+
1.01)/(t.preFilterOffset+1.01)*n)}var r=d.cachedCount[Q];return r?m(c(r)):(this.then=(T?d._callOnStore("count",[T],C):d._callOnStore("count")).then(c)).then.apply(this,arguments)}},filter:function(m,c){function r(){U(d._callOnStore("openCursor",ea,C,!0),function(x){A++;x.onsuccess=function(y){A--;var v=y.target.result;if(v){if(L){v.advance(L);A++;L=!1;return}t.preFilterOffset++;try{var F=v.value;b.join&&(F=b.join(F));return U(F,function(z){if(ka.matches(z)&&(t.offset++,t.offset>=p&&(u.push(z),!m.call(c,
z)||t.offset>=p+f-1))){x.lastCursor=v;n.resolve(u);M();return}return M(v,b.priority,function(){L=t.preFilterOffset;r()})})}catch(z){n.reject(z)}}else n.resolve(u);M()};x.onerror=function(y){A--;n.reject(y);M()}})}var n=new Y,u=[];r();return n.promise}};return S?(k=this.queryEngine({},b),S=X.delegate(J.filter(ia).then(function(m){return k(m)})),S.total=J.total,new ha(S)):b.rawResults?J:ba(J)}})});