//>>built
define(["dojo","dijit","dojox","dojo/require!dojox/grid/DataGrid,dojox/charting/Chart2D,dojox/charting/widget/Legend,dojox/charting/action2d/Tooltip,dojox/charting/action2d/Highlight,dojo/colors,dojo/data/ItemFileWriteStore"],function(f,I,z){f.provide("dojox.widget.DataPresentation");f.experimental("dojox.widget.DataPresentation");f.require("dojox.grid.DataGrid");f.require("dojox.charting.Chart2D");f.require("dojox.charting.widget.Legend");f.require("dojox.charting.action2d.Tooltip");f.require("dojox.charting.action2d.Highlight");
f.require("dojo.colors");f.require("dojo.data.ItemFileWriteStore");(function(){var E=function(a,b,c,e){var g=[{value:0,text:""}],h=a.length;if("ClusteredBars"!==c&&"StackedBars"!==c&&(c=e.offsetWidth,e=(""+a[0]).length*a.length*7,1==b))for(var k=1;500>k&&!(e/k<c);++k)++b;for(c=0;c<h;c++)g.push({value:c+1,text:!b||c%b?"":a[c]});g.push({value:h+1,text:""});return g},F=function(a,b){b={vertical:!1,labels:b,min:0,max:b.length-1,majorTickStep:1,minorTickStep:1};if("ClusteredBars"===a||"StackedBars"===
a)b.vertical=!0;if("Lines"===a||"Areas"===a||"StackedAreas"===a)b.min++,b.max--;return b},D=function(a,b,c,e){var g={vertical:!0,fixLower:"major",fixUpper:"major",natural:!0};"secondary"===b&&(g.leftBottom=!1);if("ClusteredBars"===a||"StackedBars"===a)g.vertical=!1;c==e&&(g.min=c-1,g.max=e+1);return g},G=function(a,b,c){b={type:a,hAxis:"independent",vAxis:"dependent-"+b,gap:4,lines:!1,areas:!1,markers:!1};if("ClusteredBars"===a||"StackedBars"===a)b.hAxis=b.vAxis,b.vAxis="independent";if("Lines"===
a||"Hybrid-Lines"===a||"Areas"===a||"StackedAreas"===a)b.lines=!0;if("Areas"===a||"StackedAreas"===a)b.areas=!0;"Lines"===a&&(b.markers=!0);"Hybrid-Lines"===a&&(b.shadows={dx:2,dy:2,dw:2},b.type="Lines");"Hybrid-ClusteredColumns"===a&&(b.type="ClusteredColumns");c&&(b.animate=c);return b},H=function(a,b,c,e,g,h,k,w,m,r,x){b||(a.innerHTML="",b=new z.charting.Chart2D(a));k&&(k._clone=function(){var t=new z.charting.Theme({chart:this.chart,plotarea:this.plotarea,axis:this.axis,series:this.series,marker:this.marker,
antiAlias:this.antiAlias,assignColors:this.assignColors,assignMarkers:this.assigneMarkers,colors:f.delegate(this.colors)});t.markers=this.markers;t._buildMarkerArray();return t},b.setTheme(k));var u=m.series_data[0].slice(0);e&&u.reverse();a=E(u,h,c,a);h={};r=k=null;x={};for(var d in b.runs)x[d]=!0;for(var v=m.series_name.length,l=0;l<v;l++)if(m.series_chart[l]&&0<m.series_data[l].length){var p=c,n=m.series_axis[l];"Hybrid"==p&&(p="line"==m.series_charttype[l]?"Hybrid-Lines":"Hybrid-ClusteredColumns");
h[n]||(h[n]={});if(!h[n][p]){var q=n+"-"+p;b.addPlot(q,G(p,n,g));var y={};"string"==typeof w?y.text=function(t){return f.replace(w,[t.element,t.run.name,u[t.index],"ClusteredBars"===p||"StackedBars"===p?t.x:t.y])}:"function"==typeof w&&(y.text=w);new z.charting.action2d.Tooltip(b,q,y);"Lines"!==p&&"Hybrid-Lines"!==p&&new z.charting.action2d.Highlight(b,q);h[n][p]=!0}q=[];y=m.series_data[l].length;for(var B=0;B<y;B++){var A=m.series_data[l][B];q.push(A);if(null===k||A>k)k=A;if(null===r||A<r)r=A}e&&
q.reverse();n={plot:n+"-"+p};m.series_linestyle[l]&&(n.stroke={style:m.series_linestyle[l]});b.addSeries(m.series_name[l],q,n);delete x[m.series_name[l]]}for(d in x)b.removeSeries(d);b.addAxis("independent",F(c,a));b.addAxis("dependent-primary",D(c,"primary",r,k));b.addAxis("dependent-secondary",D(c,"secondary",r,k));return b},C=function(a,b){if(b){b=b.split(/[.\[\]]+/);for(var c=0,e=b.length;c<e;c++)a&&(a=a[b[c]])}return a};f.declare("dojox.widget.DataPresentation",null,{type:"chart",chartType:"clusteredBars",
reverse:!1,animate:null,labelMod:1,legendHorizontal:!0,constructor:function(a,b){f.mixin(this,b);this.domNode=f.byId(a);this[this.type+"Node"]=this.domNode;"string"==typeof this.theme&&(this.theme=f.getObject(this.theme));this.chartNode=f.byId(this.chartNode);this.legendNode=f.byId(this.legendNode);this.gridNode=f.byId(this.gridNode);this.titleNode=f.byId(this.titleNode);this.footerNode=f.byId(this.footerNode);this.legendVertical&&(this.legendHorizontal=!this.legendVertical);this.url?this.setURL(null,
null,this.refreshInterval):this.data?this.setData(null,this.refreshInterval):this.setStore()},setURL:function(a,b,c){c&&this.cancelRefresh();this.url=a||this.url;this.urlContent=b||this.urlContent;this.refreshInterval=c||this.refreshInterval;var e=this;f.xhrGet({url:this.url,content:this.urlContent,handleAs:"json-comment-optional",load:function(g,h){e.setData(g)},error:function(g,h){e.urlError&&"function"==typeof e.urlError&&e.urlError(g,h)}});c&&0<this.refreshInterval&&(this.refreshIntervalPending=
setInterval(function(){e.setURL()},this.refreshInterval))},setData:function(a,b){b&&this.cancelRefresh();this.data=a||this.data;this.refreshInterval=b||this.refreshInterval;var c="function"==typeof this.series?this.series(this.data):this.series,e=[];a=[];for(var g=[],h=[],k=[],w=[],m=[],r=[],x=[],u=0,d=0;d<c.length;d++)e[d]=C(this.data,c[d].datapoints),e[d]&&e[d].length>u&&(u=e[d].length),a[d]=[],g[d]=c[d].name||(c[d].namefield?C(this.data,c[d].namefield):null)||"series "+d,h[d]=!1!==c[d].chart,k[d]=
c[d].charttype||"bar",w[d]=c[d].linestyle,m[d]=c[d].axis||"primary",r[d]=!1!==c[d].grid,x[d]=c[d].gridformatter;var v,l=[];for(v=0;v<u;v++){var p={index:v};for(d=0;d<c.length;d++)if(e[d]&&e[d].length>v){var n=C(e[d][v],c[d].field);if(h[d]){var q=parseFloat(n);isNaN(q)||(n=q)}p["data."+d]=n;a[d].push(n)}l.push(p)}0>=u&&l.push({index:0});c=new f.data.ItemFileWriteStore({data:{identifier:"index",items:l}});this.data.title&&(c.title=this.data.title);this.data.footer&&(c.footer=this.data.footer);c.series_data=
a;c.series_name=g;c.series_chart=h;c.series_charttype=k;c.series_linestyle=w;c.series_axis=m;c.series_grid=r;c.series_gridformatter=x;this.setPreparedStore(c);if(b&&0<this.refreshInterval){var y=this;this.refreshIntervalPending=setInterval(function(){y.setData()},this.refreshInterval)}},refresh:function(){this.url?this.setURL(this.url,this.urlContent,this.refreshInterval):this.data&&this.setData(this.data,this.refreshInterval)},cancelRefresh:function(){this.refreshIntervalPending&&(clearInterval(this.refreshIntervalPending),
this.refreshIntervalPending=void 0)},setStore:function(a,b,c){this.setPreparedStore(a,b,c)},setPreparedStore:function(a,b,c){this.preparedstore=a||this.store;this.query=b||this.query;this.queryOptions=c||this.queryOptions;if(this.preparedstore){this.chartNode&&(this.chartWidget=H(this.chartNode,this.chartWidget,this.chartType,this.reverse,this.animate,this.labelMod,this.theme,this.tooltip,this.preparedstore,this.query,this.queryOptions),this.renderChartWidget());this.legendNode&&((a=this.legendWidget)?
a.refresh():a=new z.charting.widget.Legend({chart:this.chartWidget,horizontal:this.legendHorizontal},this.legendNode),this.legendWidget=a);if(this.gridNode){a=this.preparedstore;c=this.query;var e=this.queryOptions;b=this.gridWidget||new z.grid.DataGrid({},this.gridNode);b.startup();b.setStore(a,c,e);c=[];for(e=0;e<a.series_name.length;e++)a.series_grid[e]&&0<a.series_data[e].length&&c.push({field:"data."+e,name:a.series_name[e],width:"auto",formatter:a.series_gridformatter[e]});b.setStructure(c);
this.gridWidget=b;this.renderGridWidget()}this.titleNode&&(a=this.preparedstore,a.title&&(this.titleNode.innerHTML=a.title));this.footerNode&&(a=this.preparedstore,a.footer&&(this.footerNode.innerHTML=a.footer))}},renderChartWidget:function(){this.chartWidget&&this.chartWidget.render()},renderGridWidget:function(){this.gridWidget&&this.gridWidget.render()},getChartWidget:function(){return this.chartWidget},getGridWidget:function(){return this.gridWidget},destroy:function(){this.cancelRefresh();this.chartWidget&&
(this.chartWidget.destroy(),delete this.chartWidget);this.legendWidget&&delete this.legendWidget;this.gridWidget&&delete this.gridWidget;this.chartNode&&(this.chartNode.innerHTML="");this.legendNode&&(this.legendNode.innerHTML="");this.gridNode&&(this.gridNode.innerHTML="");this.titleNode&&(this.titleNode.innerHTML="");this.footerNode&&(this.footerNode.innerHTML="")}})})()});