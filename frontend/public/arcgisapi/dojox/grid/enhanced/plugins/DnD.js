//>>built
define("dojo/_base/kernel dojo/_base/declare dojo/_base/connect dojo/_base/array dojo/_base/lang dojo/_base/html dojo/_base/json dojo/_base/window dojo/query dojo/keys dojo/dnd/Source dojo/dnd/Avatar ../_Plugin ../../EnhancedGrid dojo/dnd/Manager ./Selector ./Rearrange".split(" "),function(A,y,D,n,t,h,E,q,B,C,F,G,H,I,J){var K=function(a){a.sort(function(d,g){return d-g});for(var c=[[a[0]]],b=1,e=0;b<a.length;++b)a[b]==a[b-1]+1?c[e].push(a[b]):c[++e]=[a[b]];return c},v=function(a){for(var c=a[0],b=
1;b<a.length;++b)c=c.concat(a[b]);return c},L=y("dojox.grid.enhanced.plugins.GridDnDElement",null,{constructor:function(a){this.plugin=a;this.node=h.create("div");this._items={}},destroy:function(){this.plugin=null;h.destroy(this.node);this._items=this.node=null},createDnDNodes:function(a){this.destroyDnDNodes();var c=["grid/"+a.type+"s"],b=this.plugin.grid.id+"_dndItem";n.forEach(a.selected,function(e,d){d=b+d;this._items[d]={type:c,data:e,dndPlugin:this.plugin};this.node.appendChild(h.create("div",
{id:d}))},this)},getDnDNodes:function(){return n.map(this.node.childNodes,function(a){return a})},destroyDnDNodes:function(){h.empty(this.node);this._items={}},getItem:function(a){return this._items[a]}}),M=y("dojox.grid.enhanced.plugins.GridDnDSource",F,{accept:["grid/cells","grid/rows","grid/cols"],constructor:function(a,c){this.grid=c.grid;this.dndElem=c.dndElem;this.dndPlugin=c.dnd;this.sourcePlugin=null},destroy:function(){this.inherited(arguments);this.sourcePlugin=this.dndPlugin=this.dndElem=
this.grid=null},getItem:function(a){return this.dndElem.getItem(a)},checkAcceptance:function(a,c){if(this!=a&&c[0]){var b=a.getItem(c[0].id);if(b.dndPlugin)for(var e=b.type,d=0;d<e.length;++d){if(e[d]in this.accept){if(this.dndPlugin._canAccept(b.dndPlugin))this.sourcePlugin=b.dndPlugin;else return!1;break}}else if("grid/rows"in this.accept){var g=[];n.forEach(c,function(f){f=a.getItem(f.id);if(f.data&&0<=n.indexOf(f.type,"grid/rows")){var l=f.data;"string"==typeof f.data&&(l=E.fromJson(f.data));
l&&g.push(l)}});if(g.length)this.sourcePlugin={_dndRegion:{type:"row",selected:[g]}};else return!1}}return this.inherited(arguments)},onDraggingOver:function(){this.dndPlugin.onDraggingOver(this.sourcePlugin)},onDraggingOut:function(){this.dndPlugin.onDraggingOut(this.sourcePlugin)},onDndDrop:function(a,c,b,e){this.onDndCancel();if(this!=a&&this==e)this.dndPlugin.onDragIn(this.sourcePlugin,b)}}),N=y("dojox.grid.enhanced.plugins.GridDnDAvatar",G,{construct:function(){this._itemType=this.manager._dndPlugin._dndRegion.type;
this._itemCount=this._getItemCount();this.isA11y=h.hasClass(q.body(),"dijit_a11y");var a=h.create("table",{border:"0",cellspacing:"0","class":"dojoxGridDndAvatar",style:{position:"absolute",zIndex:"1999",margin:"0px"}}),c=this.manager.source,b=h.create("tbody",null,a);b=h.create("tr",null,b);var e=h.create("td",{"class":"dojoxGridDnDIcon"},b);this.isA11y&&h.create("span",{id:"a11yIcon",innerHTML:this.manager.copy?"+":"\x3c"},e);e=h.create("td",{"class":"dojoxGridDnDItemIcon "+this._getGridDnDIconClass()},
b);e=h.create("td",null,b);h.create("span",{"class":"dojoxGridDnDItemCount",innerHTML:c.generateText?this._generateText():""},e);h.style(b,{opacity:.9});this.node=a},_getItemCount:function(){var a=this.manager._dndPlugin._dndRegion.selected,c=0;switch(this._itemType){case "cell":a=a[0];c=this.manager._dndPlugin.grid.layout.cells;var b=a.max.col-a.min.col+1,e=a.max.row-a.min.row+1;if(1<b)for(var d=a.min.col;d<=a.max.col;++d)c[d].hidden&&--b;c=b*e;break;case "row":case "col":c=v(a).length}return c},
_getGridDnDIconClass:function(){return{row:["dojoxGridDnDIconRowSingle","dojoxGridDnDIconRowMulti"],col:["dojoxGridDnDIconColSingle","dojoxGridDnDIconColMulti"],cell:["dojoxGridDnDIconCellSingle","dojoxGridDnDIconCellMulti"]}[this._itemType][1==this._itemCount?0:1]},_generateText:function(){return"("+this._itemCount+")"}});A=y("dojox.grid.enhanced.plugins.DnD",H,{name:"dnd",_targetAnchorBorderWidth:2,_copyOnly:!1,_config:{row:{within:!0,"in":!0,out:!0},col:{within:!0,"in":!0,out:!0},cell:{within:!0,
"in":!0,out:!0}},constructor:function(a,c){this.grid=a;this._config=t.clone(this._config);c=t.isObject(c)?c:{};this.setupConfig(c.dndConfig);this._copyOnly=!!c.copyOnly;this._mixinGrid();this.selector=a.pluginMgr.getPlugin("selector");this.rearranger=a.pluginMgr.getPlugin("rearrange");this.rearranger.setArgs(c);this._clear();this._elem=new L(this);this._source=new M(this._elem.node,{grid:a,dndElem:this._elem,dnd:this});this._container=B(".dojoxGridMasterView",this.grid.domNode)[0];this._initEvents()},
destroy:function(){this.inherited(arguments);this._clear();this._source.destroy();this._elem.destroy();this._config=this.rearranger=this.selector=this.grid=this._container=null},_mixinGrid:function(){this.grid.setupDnDConfig=t.hitch(this,"setupConfig");this.grid.dndCopyOnly=t.hitch(this,"copyOnly")},setupConfig:function(a){if(a&&t.isObject(a)){var c=["row","col","cell"],b=["within","in","out"],e=this._config;n.forEach(c,function(d){if(d in a){var g=a[d];g&&t.isObject(g)?n.forEach(b,function(f){f in
g&&(e[d][f]=!!g[f])}):n.forEach(b,function(f){e[d][f]=!!g})}});n.forEach(b,function(d){if(d in a){var g=a[d];g&&t.isObject(g)?n.forEach(c,function(f){f in g&&(e[f][d]=!!g[f])}):n.forEach(c,function(f){e[f][d]=!!g})}})}},copyOnly:function(a){"undefined"!=typeof a&&(this._copyOnly=!!a);return this._copyOnly},_isOutOfGrid:function(a){var c=h.position(this.grid.domNode),b=a.clientX;a=a.clientY;return a<c.y||a>c.y+c.h||b<c.x||b>c.x+c.w},_onMouseMove:function(a){if(!this._dndRegion||this._dnding||this._externalDnd){this._isMouseDown&&
!this._dndRegion&&(delete this._isMouseDown,this._oldCursor=h.style(q.body(),"cursor"),h.style(q.body(),"cursor","not-allowed"));var c=this._isOutOfGrid(a);!this._alreadyOut&&c?(this._alreadyOut=!0,this._dnding&&this._destroyDnDUI(!0,!1),this._moveEvent=a,this._source.onOutEvent()):this._alreadyOut&&!c&&(this._alreadyOut=!1,this._dnding&&this._createDnDUI(a,!0),this._moveEvent=a,this._source.onOverEvent())}else this._dnding=!0,this._startDnd(a)},_onMouseUp:function(){if(!this._extDnding&&!this._isSource){var a=
this._dnding&&!this._alreadyOut;a&&this._config[this._dndRegion.type].within&&this._rearrange();this._endDnd(a)}h.style(q.body(),"cursor",this._oldCursor||"");delete this._isMouseDown},_initEvents:function(){var a=this.grid,c=this.selector;this.connect(q.doc,"onmousemove","_onMouseMove");this.connect(q.doc,"onmouseup","_onMouseUp");this.connect(a,"onCellMouseOver",function(b){this._dnding||c.isSelecting()||b.ctrlKey||(this._dndReady=c.isSelected("cell",b.rowIndex,b.cell.index),c.selectEnabled(!this._dndReady))});
this.connect(a,"onHeaderCellMouseOver",function(b){this._dndReady&&c.selectEnabled(!0)});this.connect(a,"onRowMouseOver",function(b){this._dndReady&&!b.cell&&c.selectEnabled(!0)});this.connect(a,"onCellMouseDown",function(b){!b.ctrlKey&&this._dndReady&&(this._dndRegion=this._getDnDRegion(b.rowIndex,b.cell.index),this._isMouseDown=!0)});this.connect(a,"onCellMouseUp",function(b){this._dndReady||c.isSelecting()||!b.cell||(this._dndReady=c.isSelected("cell",b.rowIndex,b.cell.index),c.selectEnabled(!this._dndReady))});
this.connect(a,"onCellClick",function(b){!this._dndReady||b.ctrlKey||b.shiftKey||c.select("cell",b.rowIndex,b.cell.index)});this.connect(a,"onEndAutoScroll",function(b,e,d,g,f){this._dnding&&this._markTargetAnchor(f)});this.connect(q.doc,"onkeydown",function(b){b.keyCode==C.ESCAPE?this._endDnd(!1):b.keyCode==C.CTRL&&(c.selectEnabled(!0),this._isCopy=!0)});this.connect(q.doc,"onkeyup",function(b){b.keyCode==C.CTRL&&(c.selectEnabled(!this._dndReady),this._isCopy=!1)})},_clear:function(){this._moveEvent=
this._target=this._dndRegion=null;this._targetAnchor={};this._extDnding=this._alreadyOut=this._isSource=this._externalDnd=this._dnding=!1},_getDnDRegion:function(a,c){var b=this.selector,e=b._selected,d=!!e.cell.length|!!e.row.length<<1|!!e.col.length<<2;switch(d){case 1:var g="cell";if(!this._config[g].within&&!this._config[g].out)break;var f=this.grid.layout.cells;d=function(k){for(var m=0,p=k.min.col;p<=k.max.col;++p)f[p].hidden&&++m;return(k.max.row-k.min.row+1)*(k.max.col-k.min.col+1-m)};var l=
{max:{row:-1,col:-1},min:{row:Infinity,col:Infinity}};n.forEach(e[g],function(k){k.row<l.min.row&&(l.min.row=k.row);k.row>l.max.row&&(l.max.row=k.row);k.col<l.min.col&&(l.min.col=k.col);k.col>l.max.col&&(l.max.col=k.col)});if(n.some(e[g],function(k){return k.row==a&&k.col==c})&&d(l)==e[g].length&&n.every(e[g],function(k){return k.row>=l.min.row&&k.row<=l.max.row&&k.col>=l.min.col&&k.col<=l.max.col}))return{type:g,selected:[l],handle:{row:a,col:c}};break;case 2:case 4:if(g=2==d?"row":"col",this._config[g].within||
this._config[g].out)if(e=b.getSelected(g),e.length)return{type:g,selected:K(e),handle:2==d?a:c}}return null},_startDnd:function(a){this._createDnDUI(a)},_endDnd:function(a){this._destroyDnDUI(!1,a);this._clear()},_createDnDUI:function(a,c){var b=h.position(this.grid.views.views[0].domNode);h.style(this._container,"height",b.h+"px");try{c||this._createSource(a),this._createMoveable(a),this._oldCursor=h.style(q.body(),"cursor"),h.style(q.body(),"cursor","default")}catch(e){console.warn("DnD._createDnDUI() error:",
e)}},_destroyDnDUI:function(a,c){try{c&&this._destroySource(),this._unmarkTargetAnchor(),a||this._destroyMoveable(),h.style(q.body(),"cursor",this._oldCursor)}catch(b){console.warn("DnD._destroyDnDUI() error:",this.grid.id,b)}},_createSource:function(a){this._elem.createDnDNodes(this._dndRegion);var c=J.manager(),b=c.makeAvatar;c._dndPlugin=this;c.makeAvatar=function(){var e=new N(c);delete c._dndPlugin;return e};c.startDrag(this._source,this._elem.getDnDNodes(),a.ctrlKey);c.makeAvatar=b;c.onMouseMove(a)},
_destroySource:function(){D.publish("/dnd/cancel")},_createMoveable:function(a){this._markTagetAnchorHandler||(this._markTagetAnchorHandler=this.connect(q.doc,"onmousemove","_markTargetAnchor"))},_destroyMoveable:function(){this.disconnect(this._markTagetAnchorHandler);delete this._markTagetAnchorHandler},_calcColTargetAnchorPos:function(a,c){var b=a.clientX;var e=this.grid.layout.cells,d=h._isBodyLtr(),g=this._getVisibleHeaders();for(a=0;a<g.length;++a){var f=h.position(g[a].node);if(d?(0===a||b>=
f.x)&&b<f.x+f.w:(0===a||b<f.x+f.w)&&b>=f.x){var l=f.x+(d?0:f.w);break}else if(d?a===g.length-1&&b>=f.x+f.w:a===g.length-1&&b<f.x){++a;l=f.x+(d?f.w:0);break}}if(a<g.length){if(b=g[a].cell.index,this.selector.isSelected("col",b)&&this.selector.isSelected("col",b-1))for(f=this._dndRegion.selected,a=0;a<f.length;++a)if(0<=n.indexOf(f[a],b)){b=f[a][0];f=h.position(e[b].getHeaderNode());l=f.x+(d?0:f.w);break}}else b=e.length;this._target=b;return l-c.x},_calcRowTargetAnchorPos:function(a,c){for(var b=this.grid,
e=0,d=b.layout.cells;d[e].hidden;)++e;var g=b.layout.cells[e];d=b.scroller.firstVisibleRow;e=g.getNode(d);if(!e)return this._target=-1,0;for(var f=h.position(e);f.y+f.h<a.clientY&&!(++d>=b.rowCount);)f=h.position(g.getNode(d));if(d<b.rowCount){if(this.selector.isSelected("row",d)&&this.selector.isSelected("row",d-1))for(a=this._dndRegion.selected,e=0;e<a.length;++e)if(0<=n.indexOf(a[e],d)){d=a[e][0];f=h.position(g.getNode(d));break}a=f.y}else a=f.y+f.h;this._target=d;return a-c.y},_calcCellTargetAnchorPos:function(a,
c,b){var e=this._dndRegion.selected[0],d=this._dndRegion.handle,g=this.grid,f=h._isBodyLtr(),l=g.layout.cells,k;var m=d.col-e.min.col;var p=e.max.col-d.col;if(b.childNodes.length){var z=B(".dojoxGridCellBorderLeftTopDIV",b)[0];b=B(".dojoxGridCellBorderRightBottomDIV",b)[0]}else z=h.create("div",{"class":"dojoxGridCellBorderLeftTopDIV"},b),b=h.create("div",{"class":"dojoxGridCellBorderRightBottomDIV"},b);for(k=e.min.col+1;k<d.col;++k)l[k].hidden&&--m;for(k=d.col+1;k<e.max.col;++k)l[k].hidden&&--p;
var w=this._getVisibleHeaders();for(k=m;k<w.length-p;++k){var r=h.position(w[k].node);if(a.clientX>=r.x&&a.clientX<r.x+r.w||k==m&&(f?a.clientX<r.x:a.clientX>=r.x+r.w)||k==w.length-p-1&&(f?a.clientX>=r.x+r.w:a<r.x)){var u=w[k-m];var x=w[k+p];m=h.position(u.node);p=h.position(x.node);u=u.cell.index;x=x.cell.index;var O=f?m.x:p.x;var P=f?p.x+p.w-m.x:m.x+m.w-p.x;break}}for(k=0;l[k].hidden;)++k;f=l[k];m=g.scroller.firstVisibleRow;for(p=h.position(f.getNode(m));p.y+p.h<a.clientY;)if(++m<g.rowCount)p=h.position(f.getNode(m));
else break;d=m>=d.row-e.min.row?m-d.row+e.min.row:0;a=d+e.max.row-e.min.row;a>=g.rowCount&&(a=g.rowCount-1,d=a-e.max.row+e.min.row);m=h.position(f.getNode(d));p=h.position(f.getNode(a));e=m.y;g=p.y+p.h-m.y;this._target={min:{row:d,col:u},max:{row:a,col:x}};f=(h.marginBox(z).w-h.contentBox(z).w)/2;u=h.position(l[u].getNode(d));h.style(z,{width:u.w-f+"px",height:u.h-f+"px"});l=h.position(l[x].getNode(a));h.style(b,{width:l.w-f+"px",height:l.h-f+"px"});return{h:g,w:P,l:O-c.x,t:e-c.y}},_markTargetAnchor:function(a){try{var c=
this._dndRegion.type;if(!(this._alreadyOut||this._dnding&&!this._config[c].within||this._extDnding&&!this._config[c]["in"])){var b=this._targetAnchor[c],e=h.position(this._container);b||(b=this._targetAnchor[c]=h.create("div",{"class":"cell"==c?"dojoxGridCellBorderDIV":"dojoxGridBorderDIV"}),h.style(b,"display","none"),this._container.appendChild(b));switch(c){case "col":var d=e.h;var g=this._targetAnchorBorderWidth;var f=this._calcColTargetAnchorPos(a,e);var l=0;break;case "row":d=this._targetAnchorBorderWidth;
g=e.w;f=0;l=this._calcRowTargetAnchorPos(a,e);break;case "cell":var k=this._calcCellTargetAnchorPos(a,e,b);d=k.h;g=k.w;f=k.l;l=k.t}"number"==typeof d&&"number"==typeof g&&"number"==typeof f&&"number"==typeof l?(h.style(b,{height:d+"px",width:g+"px",left:f+"px",top:l+"px"}),h.style(b,"display","")):this._target=null}}catch(m){console.warn("DnD._markTargetAnchor() error:",m)}},_unmarkTargetAnchor:function(){this._dndRegion&&this._targetAnchor[this._dndRegion.type]&&h.style(this._targetAnchor[this._dndRegion.type],
"display","none")},_getVisibleHeaders:function(){return n.map(n.filter(this.grid.layout.cells,function(a){return!a.hidden}),function(a){return{node:a.getHeaderNode(),cell:a}})},_rearrange:function(){if(null!==this._target){var a=this._dndRegion.type,c=this._dndRegion.selected;if("cell"===a)this.rearranger[this._isCopy||this._copyOnly?"copyCells":"moveCells"](c[0],-1===this._target?null:this._target);else this.rearranger["col"==a?"moveColumns":"moveRows"](v(c),-1===this._target?null:this._target);
this._target=null}},onDraggingOver:function(a){!this._dnding&&a&&(this._extDnding=a._isSource=!0,this._externalDnd||(this._externalDnd=!0,this._dndRegion=this._mapRegion(a.grid,a._dndRegion)),this._createDnDUI(this._moveEvent,!0),this.grid.pluginMgr.getPlugin("autoScroll").readyForAutoScroll=!0)},_mapRegion:function(a,c){if("cell"===c.type){var b=c.selected[0],e=this.grid.layout.cells;a=a.layout.cells;var d,g=0;for(d=b.min.col;d<=b.max.col;++d)a[d].hidden||++g;for(d=0;0<g;++d)e[d].hidden||--g;var f=
t.clone(c);f.selected[0].min.col=0;f.selected[0].max.col=d-1;for(d=b.min.col;d<=c.handle.col;++d)a[d].hidden||++g;for(d=0;0<g;++d)e[d].hidden||--g;f.handle.col=d}return c},onDraggingOut:function(a){this._externalDnd&&(this._extDnding=!1,this._destroyDnDUI(!0,!1),a&&(a._isSource=!1))},onDragIn:function(a,c){var b=!1;if(null!==this._target){b=a._dndRegion.selected;switch(a._dndRegion.type){case "cell":this.rearranger.changeCells(a.grid,b[0],this._target);break;case "row":b=v(b),this.rearranger.insertRows(a.grid,
b,this._target)}b=!0}this._endDnd(!0);if(a.onDragOut)a.onDragOut(b&&!c)},onDragOut:function(a){if(a&&!this._copyOnly)switch(a=this._dndRegion.selected,this._dndRegion.type){case "cell":this.rearranger.clearCells(a[0]);break;case "row":this.rearranger.removeRows(v(a))}this._endDnd(!0)},_canAccept:function(a){if(!a)return!1;var c=a._dndRegion,b=c.type;if(!this._config[b]["in"]||!a._config[b].out)return!1;var e=this.grid,d=c.selected;c=n.filter(e.layout.cells,function(l){return!l.hidden}).length;var g=
e.rowCount,f=!0;switch(b){case "cell":d=d[0],f=e.store.getFeatures()["dojo.data.api.Write"]&&d.max.row-d.min.row<=g&&n.filter(a.grid.layout.cells,function(l){return l.index>=d.min.col&&l.index<=d.max.col&&!l.hidden}).length<=c;case "row":if(a._allDnDItemsLoaded())return f}return!1},_allDnDItemsLoaded:function(){if(this._dndRegion){var a=this._dndRegion.selected,c=[];switch(this._dndRegion.type){case "cell":var b=a[0].min.row;for(a=a[0].max.row;b<=a;++b)c.push(b);break;case "row":c=v(a);break;default:return!1}var e=
this.grid._by_idx;return n.every(c,function(d){return!!e[d]})}return!1}});I.registerPlugin(A,{dependency:["selector","rearrange"]});return A});