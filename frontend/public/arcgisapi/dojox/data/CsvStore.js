//>>built
define("dojo/_base/lang dojo/_base/declare dojo/_base/xhr dojo/_base/kernel dojo/data/util/filter dojo/data/util/simpleFetch".split(" "),function(u,q,v,z,w,A){q=q("dojox.data.CsvStore",null,{constructor:function(a){this._attributes=[];this._attributeIndexes={};this._dataArray=[];this._arrayOfAllItems=[];this._loadFinished=!1;a.url&&(this.url=a.url);this._csvData=a.data;a.label?this.label=a.label:""===this.label&&(this.label=void 0);this._storeProp="_csvStore";this._idProp="_csvId";this._features=
{"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0};this._loadInProgress=!1;this._queuedFetches=[];this.identifier=a.identifier;""===this.identifier?delete this.identifier:this._idMap={};"separator"in a&&(this.separator=a.separator);"urlPreventCache"in a&&(this.urlPreventCache=a.urlPreventCache?!0:!1)},url:"",label:"",identifier:"",separator:",",urlPreventCache:!1,_assertIsItem:function(a){if(!this.isItem(a))throw Error(this.declaredClass+": a function was passed an item argument that was not an item");
},_getIndex:function(a){a=this.getIdentity(a);this.identifier&&(a=this._idMap[a]);return a},getValue:function(a,b,c){this._assertIsItem(a);var d=c;if("string"===typeof b)b=this._attributeIndexes[b],null!=b&&(d=this._dataArray[this._getIndex(a)][b]||c);else throw Error(this.declaredClass+": a function was passed an attribute argument that was not a string");return d},getValues:function(a,b){return(a=this.getValue(a,b))?[a]:[]},getAttributes:function(a){this._assertIsItem(a);var b=[];a=this._dataArray[this._getIndex(a)];
for(var c=0;c<a.length;c++)""!==a[c]&&b.push(this._attributes[c]);return b},hasAttribute:function(a,b){this._assertIsItem(a);if("string"===typeof b)return b=this._attributeIndexes[b],a=this._dataArray[this._getIndex(a)],"undefined"!==typeof b&&b<a.length&&""!==a[b];throw Error(this.declaredClass+": a function was passed an attribute argument that was not a string");},containsValue:function(a,b,c){var d=void 0;"string"===typeof c&&(d=w.patternToRegExp(c,!1));return this._containsValue(a,b,c,d)},_containsValue:function(a,
b,c,d){a=this.getValues(a,b);for(b=0;b<a.length;++b){var e=a[b];if("string"===typeof e&&d)return null!==e.match(d);if(c===e)return!0}return!1},isItem:function(a){if(a&&a[this._storeProp]===this)if(a=a[this._idProp],this.identifier){if(this._dataArray[this._idMap[a]])return!0}else if(0<=a&&a<this._dataArray.length)return!0;return!1},isItemLoaded:function(a){return this.isItem(a)},loadItem:function(a){},getFeatures:function(){return this._features},getLabel:function(a){if(this.label&&this.isItem(a))return this.getValue(a,
this.label)},getLabelAttributes:function(a){return this.label?[this.label]:null},_fetchItems:function(a,b,c){var d=this,e=function(f,g){var n=null;if(f.query){var m;n=[];var p=f.queryOptions?f.queryOptions.ignoreCase:!1,r={};for(m in f.query){var t=f.query[m];"string"===typeof t&&(r[m]=w.patternToRegExp(t,p))}for(p=0;p<g.length;++p){var x=!0,y=g[p];for(m in f.query)t=f.query[m],d._containsValue(y,m,t,r[m])||(x=!1);x&&n.push(y)}}else n=g.slice(0,g.length);b(n,f)};if(this._loadFinished)e(a,this._arrayOfAllItems);
else if(""!==this.url)if(this._loadInProgress)this._queuedFetches.push({args:a,filter:e});else{this._loadInProgress=!0;var k=v.get({url:d.url,handleAs:"text",preventCache:d.urlPreventCache});k.addCallback(function(f){try{d._processData(f),e(a,d._arrayOfAllItems),d._handleQueuedFetches()}catch(g){c(g,a)}});k.addErrback(function(f){d._loadInProgress=!1;if(c)c(f,a);else throw f;});var h=null;a.abort&&(h=a.abort);a.abort=function(){var f=k;f&&-1===f.fired&&(f.cancel(),f=null);h&&h.call(a)}}else if(this._csvData)try{this._processData(this._csvData),
this._csvData=null,e(a,this._arrayOfAllItems)}catch(f){c(f,a)}else{var l=Error(this.declaredClass+": No CSV source data was provided as either URL or String data input.");if(c)c(l,a);else throw l;}},close:function(a){},_getArrayOfArraysFromCsvFileContents:function(a){if(u.isString(a)){var b=/^\s+/g,c=/\s+$/g,d=/""/g,e=[],k=this._splitLines(a);for(a=0;a<k.length;++a){var h=k[a];if(0<h.length){h=h.split(this.separator);for(var l=0;l<h.length;){var f=h[l].replace(b,""),g=f.replace(c,""),n=g.charAt(0),
m=g.charAt(g.length-1),p=g.charAt(g.length-2),r=g.charAt(g.length-3);if(2===g.length&&'""'==g)h[l]="";else if('"'==n&&('"'!=m||'"'==m&&'"'==p&&'"'!=r)){if(l+1===h.length)return;h[l]=f+this.separator+h[l+1];h.splice(l+1,1)}else'"'==n&&'"'==m&&(g=g.slice(1,g.length-1),g=g.replace(d,'"')),h[l]=g,l+=1}e.push(h)}}this._attributes=e.shift();for(a=0;a<this._attributes.length;a++)this._attributeIndexes[this._attributes[a]]=a;this._dataArray=e}},_splitLines:function(a){var b=[],c,d="",e=!1;for(c=0;c<a.length;c++){var k=
a.charAt(c);switch(k){case '"':e=!e;d+=k;break;case "\r":e?d+=k:(b.push(d),d="",c<a.length-1&&"\n"==a.charAt(c+1)&&c++);break;case "\n":e?d+=k:(b.push(d),d="");break;default:d+=k}}""!==d&&b.push(d);return b},_processData:function(a){this._getArrayOfArraysFromCsvFileContents(a);this._arrayOfAllItems=[];if(this.identifier&&void 0===this._attributeIndexes[this.identifier])throw Error(this.declaredClass+": Identity specified is not a column header in the data set.");for(a=0;a<this._dataArray.length;a++){var b=
a;this.identifier&&(b=this._dataArray[a][this._attributeIndexes[this.identifier]],this._idMap[b]=a);this._arrayOfAllItems.push(this._createItemFromIdentity(b))}this._loadFinished=!0;this._loadInProgress=!1},_createItemFromIdentity:function(a){var b={};b[this._storeProp]=this;b[this._idProp]=a;return b},getIdentity:function(a){return this.isItem(a)?a[this._idProp]:null},fetchItemByIdentity:function(a){var b=a.scope?a.scope:z.global;if(this._loadFinished){var c=this._createItemFromIdentity(a.identity);
this.isItem(c)||(c=null);a.onItem&&a.onItem.call(b,c)}else{var d=this;if(""!==this.url)this._loadInProgress?this._queuedFetches.push({args:a}):(this._loadInProgress=!0,c=v.get({url:d.url,handleAs:"text"}),c.addCallback(function(e){try{d._processData(e);var k=d._createItemFromIdentity(a.identity);d.isItem(k)||(k=null);a.onItem&&a.onItem.call(b,k);d._handleQueuedFetches()}catch(h){a.onError&&a.onError.call(b,h)}}),c.addErrback(function(e){this._loadInProgress=!1;a.onError&&a.onError.call(b,e)}));else if(this._csvData)try{d._processData(d._csvData),
d._csvData=null,c=d._createItemFromIdentity(a.identity),d.isItem(c)||(c=null),a.onItem&&a.onItem.call(b,c)}catch(e){a.onError&&a.onError.call(b,e)}}},getIdentityAttributes:function(a){return this.identifier?[this.identifier]:null},_handleQueuedFetches:function(){if(0<this._queuedFetches.length){for(var a=0;a<this._queuedFetches.length;a++){var b=this._queuedFetches[a],c=b.filter,d=b.args;c?c(d,this._arrayOfAllItems):this.fetchItemByIdentity(b.args)}this._queuedFetches=[]}}});u.extend(q,A);return q});