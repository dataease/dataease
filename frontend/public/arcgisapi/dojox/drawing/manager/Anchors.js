//>>built
define(["dojo","../util/oo","../defaults"],function(f,k,l){var m=k.declare(function(a){this.defaults=l.copy();this.mouse=a.mouse;this.point=a.point;this.pointIdx=a.pointIdx;this.util=a.util;this.id=a.id||this.util.uid("anchor");this.org=f.mixin({},this.point);this.stencil=a.stencil;this.stencil.anchorPositionCheck&&(this.anchorPositionCheck=f.hitch(this.stencil,this.stencil.anchorPositionCheck));this.stencil.anchorConstrain&&(this.anchorConstrain=f.hitch(this.stencil,this.stencil.anchorConstrain));
this._zCon=f.connect(this.mouse,"setZoom",this,"render");this.render();this.connectMouse()},{y_anchor:null,x_anchor:null,render:function(){this.shape&&this.shape.removeShape();var a=this.defaults.anchors,b=this.mouse.zoom,e=a.size*b,c=e/2;b={width:a.width*b,style:a.style,color:a.color,cap:a.cap};this.shape=this.stencil.container.createRect({x:this.point.x-c,y:this.point.y-c,width:e,height:e}).setStroke(b).setFill(a.fill);this.shape.setTransform({dx:0,dy:0});this.util.attr(this,"drawingType","anchor");
this.util.attr(this,"id",this.id)},onRenderStencil:function(a){},onTransformPoint:function(a){},onAnchorDown:function(a){this.selected=a.id==this.id},onAnchorUp:function(a){this.selected=!1;this.stencil.onTransformEnd(this)},onAnchorDrag:function(a){if(this.selected){this.shape.getTransform();var b=this.shape.getParent().getParent().getTransform(),e=this.defaults.anchors.marginZero,c=b.dx+this.org.x,d=b.dy+this.org.y;b=a.x-c;a=a.y-d;var g=this.defaults.anchors.minSize;var h=this.anchorPositionCheck(b,
a,this);if(0>h.x)for(console.warn("X\x3c0 Shift");0>this.anchorPositionCheck(b,a,this).x;)this.shape.getParent().getParent().applyTransform({dx:2,dy:0});if(0>h.y)for(console.warn("Y\x3c0 Shift");0>this.anchorPositionCheck(b,a,this).y;)this.shape.getParent().getParent().applyTransform({dx:0,dy:2});this.y_anchor?this.org.y>this.y_anchor.org.y?(d=this.y_anchor.point.y+g-this.org.y,h=Infinity,a<d&&(a=d)):(d=-d+e,h=this.y_anchor.point.y-g-this.org.y,a<d?a=d:a>h&&(a=h)):(d=-d+e,a<d&&(a=d));this.x_anchor?
this.org.x>this.x_anchor.org.x?(e=this.x_anchor.point.x+g-this.org.x,c=Infinity,b<e&&(b=e)):(e=-c+e,c=this.x_anchor.point.x-g-this.org.x,b<e?b=e:b>c&&(b=c)):(e=-c+e,b<e&&(b=e));e=this.anchorConstrain(b,a);null!=e&&(b=e.x,a=e.y);this.shape.setTransform({dx:b,dy:a});this.linkedAnchor&&this.linkedAnchor.shape.setTransform({dx:b,dy:a});this.onTransformPoint(this)}},anchorConstrain:function(a,b){return null},anchorPositionCheck:function(a,b,e){return{x:1,y:1}},setPoint:function(a){this.shape.applyTransform(a)},
connectMouse:function(){this._mouseHandle=this.mouse.register(this)},disconnectMouse:function(){this.mouse.unregister(this._mouseHandle)},reset:function(a){},destroy:function(){f.disconnect(this._zCon);this.disconnectMouse();this.shape.removeShape()}});return k.declare(function(a){this.mouse=a.mouse;this.undo=a.undo;this.util=a.util;this.drawing=a.drawing;this.items={}},{onAddAnchor:function(a){},onReset:function(a){var b=this.util.byId("drawing").stencils;b.onDeselect(a);b.onSelect(a)},onRenderStencil:function(){for(var a in this.items)f.forEach(this.items[a].anchors,
function(b){b.shape.moveToFront()})},onTransformPoint:function(a){var b=this.items[a.stencil.id].item,e=[];f.forEach(this.items[a.stencil.id].anchors,function(c,d){a.id!=c.id&&"group"==a.stencil.anchorType&&(a.org.y==c.org.y?c.setPoint({dx:0,dy:a.shape.getTransform().dy-c.shape.getTransform().dy}):a.org.x==c.org.x&&c.setPoint({dx:a.shape.getTransform().dx-c.shape.getTransform().dx,dy:0}),c.shape.moveToFront());d=c.shape.getTransform();e.push({x:d.dx+c.org.x,y:d.dy+c.org.y});c.point.t&&(e[e.length-
1].t=c.point.t)},this);b.setPoints(e);b.onTransform(a);this.onRenderStencil()},onAnchorUp:function(a){},onAnchorDown:function(a){},onAnchorDrag:function(a){},onChangeStyle:function(a){for(var b in this.items)f.forEach(this.items[b].anchors,function(e){e.shape.moveToFront()})},add:function(a){this.items[a.id]={item:a,anchors:[]};if("none"!=a.anchorType){var b=a.points;f.forEach(b,function(d,g){d.noAnchor||(0!=g&&g!=a.points.length-1||console.log("ITEM TYPE:",a.type,a.shortType),d=new m({stencil:a,
point:d,pointIdx:g,mouse:this.mouse,util:this.util}),this.items[a.id]._cons=[f.connect(d,"onRenderStencil",this,"onRenderStencil"),f.connect(d,"reset",this,"onReset"),f.connect(d,"onAnchorUp",this,"onAnchorUp"),f.connect(d,"onAnchorDown",this,"onAnchorDown"),f.connect(d,"onAnchorDrag",this,"onAnchorDrag"),f.connect(d,"onTransformPoint",this,"onTransformPoint"),f.connect(a,"onChangeStyle",this,"onChangeStyle")],this.items[a.id].anchors.push(d),this.onAddAnchor(d))},this);if("path"==a.shortType){var e=
b[0];b=b[b.length-1];var c=this.items[a.id].anchors;e.x==b.x&&e.y==b.y&&(console.warn("LINK ANVHROS",c[0],c[c.length-1]),c[0].linkedAnchor=c[c.length-1],c[c.length-1].linkedAnchor=c[0])}"group"==a.anchorType&&f.forEach(this.items[a.id].anchors,function(d){f.forEach(this.items[a.id].anchors,function(g){d.id!=g.id&&(d.org.y==g.org.y?d.x_anchor=g:d.org.x==g.org.x&&(d.y_anchor=g))},this)},this)}},remove:function(a){this.items[a.id]&&(f.forEach(this.items[a.id].anchors,function(b){b.destroy()}),f.forEach(this.items[a.id]._cons,
f.disconnect,f),this.items[a.id].anchors=null,delete this.items[a.id])}})});