// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/DataProviderGE","dojo/_base/declare dojo/_base/lang esri/dijit/geoenrichment/promise/all esri/dijit/geoenrichment/when esri/kernel ./dataProvider/_CommandSupport ./dataProvider/_SerializationSupport ./dataProvider/_ServerSerializationSupport ./dataProvider/supportClasses/areas/AnalysisAreaUtil ./dataProvider/supportClasses/areas/AnalysisAreaJsonUtil ./dataProvider/supportClasses/areas/AreasPreprocessor ./dataProvider/supportClasses/CustomReportsManager ./dataProvider/supportClasses/TemplateJsonLoader ./dataProvider/supportClasses/ReportDataProcessor ./dataProvider/supportClasses/InfographicOptionsProvider ./dataProvider/supportClasses/GEUtil ./dataProvider/supportClasses/attachments/DefaultAttachmentsStore ./dataProvider/supportClasses/attachments/CustomAttachmentsStore ./dataProvider/supportClasses/PortalManager ./dataProvider/supportClasses/data/VariablesUtil ./dataProvider/commands/mapToImage/MapToURLUtil ./core/themes/ThemeLibrary ./core/themes/ReportThemes esri/dijit/geoenrichment/ReportPlayer/countryConfig esri/dijit/geoenrichment/utils/ProjectionUtil esri/dijit/geoenrichment/utils/UrlUtil".split(" "),
function(w,h,l,m,x,y,z,A,q,r,t,g,u,k,B,n,C,D,E,F,G,H,v,p,I,J){return w([y,z,A],{analysisAreasLimit:-1,cacheTemplates:!0,printMapTaskUrl:null,resetReportItemsCache:!0,_infographicOptionsProvider:null,constructor:function(b){h.mixin(this,b);this._infographicOptionsProvider=new B},_getAttachmentsStore:function(b){return(new C(b)).initialize()},getCustomReports:function(b){return g.getCustomReports(b)},_currentContext:null,getReportData:function(b,e){var c=this,f=e&&e.progressCallback||function(){},a=
h.mixin({},b);a.portalUrl=J.getPortalUrl(a.portalUrl);q.parseSites(a);a.hierarchy||a.analysisAreas.some(function(b){if(b.geographies&&b.geographies[0].hierarchy)return a.hierarchy=b.geographies[0].hierarchy,!0});c.resetReportItemsCache&&g.resetCache();c._currentContext=a;a.analysisAreas=r.areasFromJson(a.analysisAreas);a.combinedAreasInfo=a.combinedAreasInfo&&r.combinedAreasInfoFromJson(a.combinedAreasInfo)||{};q.populateCombinedAreasInfo(a.combinedAreasInfo,a.analysisAreas);a.fieldData={runReportTaskIDs:null,
metadata:{},areaData:[],errors:[]};return l([m(g.tryFindReportIdByAlias(a),function(b){a.reportID=b||a.reportID}),this._discoverPortal(a),function(){return a.variables&&m(F.preprocessVariables(a.variables,a.portalUrl),function(b){a.variables=b})}()]).then(function(){return m(t.preprocessAreas(a,{analysisAreasLimit:c.analysisAreasLimit}),function(){f(.25);setTimeout(function(){c._onCreateReportStarted()});var b=a.attachmentsProvider?D(a.attachmentsProvider):c._getAttachmentsStore(a.analysisAreas),
d={initGE:n.initialize(),countryInfo:n.getCountryInfo(a.countryID),infographicOptions:c._infographicOptionsProvider.getInfographicOptions(a),attachmentsStore:b};a.reportID?(d.reportObject=g.getCustomReportByID(a),d.templateJsonInfo=u.getTemplateJsonByID(a,c.cacheTemplates),d.runReportResult=k.runReportAndGetData(a,b)):a.variables&&(d.reportObject=g.getFakeCustomReportByContext(a),d.templateJsonInfo=u.createTemplateJsonFromVariables(a),d.runReportResult=k.runReportFromVariables(a));return l(d).then(function(b){var c=
b.reportObject,d=b.infographicOptions,e=b.attachmentsStore,g=b.templateJsonInfo.templateJson,h=b.templateJsonInfo.templateVariableProvider,l=b.runReportResult;f(.75);if(!g||!c||!a.fieldData)return null;k.applyRunReportAndGetDataResults(l,a);p.setCountry(b.countryInfo.country);p.setHierarchyID(a.hierarchy);p.setGeographiesModel(b.countryInfo.geographiesModels[p.getHierarchyID()]);return m(e&&k.populateReportDataFromAttachmentsStore(a,e),function(){f(1);g.theme||(g.theme=H.getReportThemeById(c.isGraphicReport?
v.GRAPHIC:v.CLASSIC));return{isClassic:!c.isGraphicReport,isMultiFeature:c.isMultiFeature&&1<a.analysisAreas.length,reportType:c.type,reportTitle:a.reportTitle||c.title,templateJson:g,reportObject:c,fieldData:a.fieldData,analysisAreas:a.analysisAreas,combinedAreasInfo:a.combinedAreasInfo,reverseAnalysisAreasOnMap:a.reverseAnalysisAreasOnMap,infographicOptions:d,attachmentsStore:e,geClient:n.getClient(),templateVariableProvider:h,customLogo:a.customLogo,config:{portalUrl:a.portalUrl,geoenrichmentUrl:a.geoenrichmentUrl,
geometryServiceUrl:a.geometryServiceUrl,printMapTaskUrl:a.printMapTaskUrl,countryID:a.countryID,hierarchy:a.hierarchy,reportID:a.reportID,variables:a.variables}}})})})})},_discoverPortal:function(b){var e=this;return E.getPortalInfo(b.portalUrl).then(function(c){b.geoenrichmentUrl=b.geoenrichmentUrl||c.portal.helperServices.geoenrichment.url;var f=x.id.findCredential(b.portalUrl),f=f&&f.token;n.setGeoenrichmentUrl(b.geoenrichmentUrl,f);e._infographicOptionsProvider.setServerUrl(b.geoenrichmentUrl,
f);b.geometryServiceUrl=b.geometryServiceUrl||c.portal.helperServices.geometry.url;I.setGeometryServiceUrl(b.geometryServiceUrl);b.printMapTaskUrl=b.printMapTaskUrl||c.portal.helperServices.printTask.url;G.setPrintMapTaskUrl(b.printMapTaskUrl)})},reportDataToSingleAreaReportData:function(b,e){var c=e.currentFeatureIndex||0,f=h.mixin({},b.fieldData);f.areaData=[f.areaData[c]];var a=[h.mixin({},b.analysisAreas[c])];t.removeGroupInfo(a);var g=b.infographicOptions&&this._infographicOptionsProvider.getInfographicOptionsFromJson(b.infographicOptions.toJsonAt(c)),
d=b.attachmentsStore;return{isClassic:b.isClassic,isMultiFeature:!1,reportType:b.reportType,reportTitle:e.reportTitle,templateJson:e.templateJson,reportObject:b.reportObject,fieldData:f,analysisAreas:a,combinedAreasInfo:null,reverseAnalysisAreasOnMap:!1,infographicOptions:g,attachmentsStore:d&&{getImages:function(){d.supportsMultipleAreas&&d.setCurrentAnalysisAreaIndex(c);return d.getImages()},getAttributes:function(){d.supportsMultipleAreas&&d.setCurrentAnalysisAreaIndex(c);return d.getAttributes()},
getNotes:function(){d.supportsMultipleAreas&&d.setCurrentAnalysisAreaIndex(c);return d.getNotes()}},geClient:b.geClient,templateVariableProvider:b.templateVariableProvider,config:b.config}},_getCurrentContext:function(){return this._currentContext},_onCreateReportStarted:function(){},enrichFieldData:function(b,e){return k.enrichFieldData(b,e)}})});