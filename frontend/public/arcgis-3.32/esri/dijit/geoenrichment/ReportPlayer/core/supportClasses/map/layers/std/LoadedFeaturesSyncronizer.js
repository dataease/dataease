// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/map/layers/std/LoadedFeaturesSyncronizer","dojo/_base/declare dojo/_base/lang esri/dijit/geoenrichment/when esri/dijit/geoenrichment/promise/all esri/graphic esri/layers/GraphicsLayer esri/geometry/jsonUtils esri/renderers/jsonUtils esri/renderers/SimpleRenderer esri/dijit/PopupTemplate ./DefaultSymbolRenderer ./FeatureGeometryLoader ./LabelsLayer esri/dijit/geoenrichment/ReportPlayer/countryConfig ../../../../../dataProvider/supportClasses/areas/AreasInfoTemplateBuilder esri/dijit/geoenrichment/utils/SymbolUtil".split(" "),
function(r,k,m,t,u,v,w,n,p,x,y,f,q,z,A,B){return r(null,{controller:null,layerSorter:null,map:null,countryID:null,hierarchy:null,calculatorFieldName:null,_levelIdToLayerCache:null,_shownFeaturesCache:null,_isDestroyed:!1,_layersPreloaded:!1,constructor:function(a){k.mixin(this,a);this._levelIdToLayerCache={};this._shownFeaturesCache={}},syncWithShownFeatures:function(){if(this._isDestroyed)console.log(Error("Attempt to use syncronizer after destroying."));else{var a=this.controller.getShownFeatureAttributes();
this._preloadAllLayers();var b=this._shownFeaturesCache;this._shownFeaturesCache={};a&&a.forEach(function(a){var c=this._getAttrsKey(a);this._shownFeaturesCache[c]=a;b[c]||this._addFeatureByAttributes(a)},this);for(var c in b)this._shownFeaturesCache[c]||this._removeFeatureByAttributes(b[c])}},_getAttrsKey:function(a){return a.StdGeographyLevel+";"+a.StdGeographyID},loadAllFeatures:function(){var a=this;return t(this.controller.getAllFeatureAttributes().map(function(b){return a._getGeometryJsonByAttributes(b)}))},
_addFeatureByAttributes:function(a){var b=this,c=a.StdGeographyName,e=this._getLayerForLevelId(a.StdGeographyLevel),d=e&&e.graphicsLayer,e=e&&e.labelsLayer;if(d){var h=this.controller.getAttributeFields().map(function(b){return{label:b.label,value:b.formatFunction(a[b.name])}}),c=new x({title:c||"",fieldInfos:[],description:A.buildAttributesTable(null,h)}),g=new u({attributes:a,geometry:null});g.setInfoTemplate(c);var f;if(!d._rendererPromise){var c=this.controller.getRendererJson(this.calculatorFieldName),
l=(c?n.fromJson(k.clone(c)):y.getDefaultStdRenderer()).getSymbol(g);d._rendererPromise=f=B.simpleFillSymbolToPictureFillSymbol(l).then(function(a){d.setRenderer(new p(a||l))});(c=this.controller.getLabelRendererJson(this.calculatorFieldName))?e.setRenderer(new p(n.fromJson(k.clone(c)).getSymbol(g))):e.setVisualSettings({color:l.color.toCss()})}m(this._getGeometryJsonByAttributes(a),function(c){c&&(g.setGeometry(w.fromJson(c)),m(f,function(){b._shownFeaturesCache[b._getAttrsKey(a)]&&d.add(g)}))})}},
_getGeometryJsonByAttributes:function(a){var b=this,c=a.StdGeographyLevel,e=a.StdGeographyID,d="__stdGeometry_"+this.map.spatialReference.wkid,h=a[d]&&JSON.parse(a[d]);return h?h:f.canLoad()&&f.getFeatureGeometry({countryID:this.countryID,hierarchy:this.hierarchy,levelId:c,featureId:e,outSR:{wkid:this.map.spatialReference.wkid}}).then(function(c){if(b._isDestroyed)return null;a[d]=JSON.stringify(c);b.controller.saveGeometryInCalculatorData(a,d);return c})},_removeFeatureByAttributes:function(a){var b=
this._levelIdToLayerCache[a.StdGeographyLevel];if(b=b&&b.graphicsLayer){var c=b.graphics.filter(function(b){return b.attributes.StdGeographyID===a.StdGeographyID})[0];c&&b.remove(c)}},_preloadAllLayers:function(){if(!this._layersPreloaded){var a={};this.controller.getAllFeatureAttributes().forEach(function(b){a[b.StdGeographyLevel]=1});Object.keys(a).forEach(this._getLayerForLevelId.bind(this));this._layersPreloaded=!0}},_getLayerForLevelId:function(a){if(!this._levelIdToLayerCache[a]){if(!this._canShowLayerForLevelId(a))return null;
var b=new v;this._provideNameForLayer(b,a,!0);this.layerSorter.registerLayerInfo({layer:b,type:this.layerSorter.STD_POLYGONS,preferredIndex:this.controller.getLayerIndex(this.calculatorFieldName,a),geometryType:"esriGeometryPolygon"});var c=new q;c.setLabelField("StdGeographyName");c.setSourceGraphicsLayer(b);c.setVisualSettings(q.getDefaultVisualSettings(a));this._provideNameForLayer(c,a,!1);this.layerSorter.registerLayerInfo({layer:c,type:this.layerSorter.STD_POLYGON_LABELS,preferredIndex:this.controller.getLayerIndex(this.calculatorFieldName,
a),geometryType:"esriGeometryPoint"});this._levelIdToLayerCache[a]={graphicsLayer:b,labelsLayer:c};this.onLayerCreated(b,a)}return this._levelIdToLayerCache[a]},_canShowLayerForLevelId:function(a){var b=this.controller.getRendererJson(this.calculatorFieldName);return!b||(b=b.uniqueValueInfos.filter(function(b){return b.value===a})[0],!b||b.symbol.color[3]||b.symbol.outline&&b.symbol.outline.color[3])?!0:!1},_provideNameForLayer:function(a,b,c){a.name=z.getGeographiesModel().getLevelPluralName(b);
c&&a.onVisibilityChange()},onLayerCreated:function(a,b){},destroy:function(){this._isDestroyed=!0;this._levelIdToLayerCache=this.controller=null}})});