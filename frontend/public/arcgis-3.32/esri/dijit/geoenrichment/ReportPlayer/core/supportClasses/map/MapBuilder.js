// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/map/MapBuilder","dojo/_base/declare dojo/_base/lang esri/dijit/geoenrichment/promise/all esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when dojo/dom-construct dojo/dom-geometry esri/graphic esri/arcgis/utils esri/graphicsUtils esri/dijit/HomeButton ./layers/MapContentBuilder ./legend/LegendBuilder ./MapLoadTracker ./StaticMap ./WebMapsUtil ./Popup ./Projector ./mobile/MobilePanUtil ../../../dataProvider/supportClasses/data/AreaDataUtil esri/dijit/geoenrichment/utils/DataUtil esri/dijit/geoenrichment/utils/DeviceUtil esri/dijit/geoenrichment/utils/ImageUtil esri/dijit/geoenrichment/utils/UrlUtil".split(" "),
function(h,q,r,l,f,t,u,v,w,n,x,y,z,A,B,p,C,k,D,E,F,G,H,I){h=h(null,{_mapInfos:null,_mapDivId:0,_mapImageInfos:null,renderMapsFromCalculators:!1,constructor:function(c){q.mixin(this,c);this.reset()},setArcgisUrl:function(c){c&&(w.arcgisUrl=I.combine(c,"/sharing/rest/content/items"))},reset:function(){this._mapInfos={};this._mapImageInfos=null},collectAreaMaps:function(c){var b=[];c=c||0;var a=this._mapInfos[c],d;for(d in a){var g=a[d],m=g.node;if(m.parentNode){var e=u.position(m);b.push({areaIndex:c,
node:m,x:e.x,y:e.y,position:-1,map:g.map,legend:g.legend,itemId:g.itemId})}}b.sort(function(a,b){return a.x-b.x});b.sort(function(a,b){return a.y-b.y});b.forEach(function(a,b){a.position=b});return b},collectAllAreasMaps:function(){var c=[],b;for(b in this._mapInfos)c=c.concat(this.collectAreaMaps(b));return c},setFallbackMapImageInfos:function(c){c?(this._mapImageInfos={},c.forEach(function(b){var a=b.areaIndex||0;(this._mapImageInfos[a]=this._mapImageInfos[a]||{})[b.itemId]=b},this)):this._mapImageInfos=
null},createMap:function(c,b){b.areaIndex=b.areaIndex||0;return f(this._doCreateMap(c,b),function(a){return b.waitForLoad?a&&f(A.waitForLoad(a.map),function(){return a}):a})},_doCreateMap:function(c,b){var a=this;if(this.renderMapsFromCalculators&&b.calculatorFieldName){var d=E.getAreaDataValue({fieldName:b.calculatorFieldName,fieldData:b.fieldData,featureIndex:this.currentFeatureIndex});if(d)return d=-1===d.indexOf("mapOptions")?H.base64DataToDataURL(d):"data:application/json;base64,"+F.base64FromJson(d),
this._createStaticMap({url:d},c,b)}return f(p.getItem(b.webMapId),function(d){if(!d)return(new l).reject(Error("Can't load an item or the item is incorrect."));var g=new l;try{a._createMapFromItem(d,c,b).then(g.resolve,g.reject)}catch(e){g.reject(e),console.log(e)}return g.promise}).otherwise(this._createFallbackStaticMap.bind(this,b,c))},_createMapFromItem:function(c,b,a){var d=this,g=G.isMobileDevice();return p.createMap(c,b,{defaultBasemapId:a.defaultBasemapId,additionalLayerInfos:a.additionalLayerInfos,
mapOptions:{extent:a.extent||n.graphicsExtent(a.features).expand(a.expandFactor||1.5),sliderPosition:!1===a.sliderPosition?"none":a.sliderPosition||"top-right",infoWindow:new C({getPlayerZoomScale:function(){return d.getPlayerZoomScale(b)}},t.create("div")),isMapNavigation:!g}}).then(function(c){var e=c&&c.map;return e?f(d._setInitialExtent(e,a),function(){return f(y.addLayersToMap(e,{features:a.features,featureIndexToAreaIndexMap:a.featureIndexToAreaIndexMap,analysisAreas:a.analysisAreas,locatorPointsControllers:a.locatorPointsControllers,
stdPolygonsControllers:a.stdPolygonsControllers,thisAreasHighlightController:a.thisAreasHighlightController,geClient:a.geClient,countryID:a.countryID,hierarchy:a.hierarchy,additionalLayerInfos:a.additionalLayerInfos,calculatorFieldName:a.calculatorFieldName,pinSymbolJson:a.pinSymbolJson,areaSymbolJsons:a.areaSymbolJsons,areaSymbolRamp:a.areaSymbolRamp,attachmentsStore:a.attachmentsStore}),function(){g&&D.setUpMapPan(e,a.onPanContainer);void 0===b.__mapDivId&&(b.__mapDivId=d._mapDivId++);var c={node:b,
map:e,itemId:a.webMapId,legend:null};z.createLegend(e,b,a.legendController,{onCreated:function(a){c.legend=a},onDestroyed:function(){delete c.legend}});var f=(new x({map:e})).placeAt(b);f.startup();f.own(e.on("before-unload",function(){f.destroy()}));return(d._mapInfos[a.areaIndex]=d._mapInfos[a.areaIndex]||{})[b.__mapDivId]=c})}):(new l).reject(Error("Can't create a map."))})},_setInitialExtent:function(c,b){function a(){return r(b.features.map(function(a){return k.needProject(a.geometry,c)?f(k.projectGeometries(a.geometry,
c),function(a){return new v(a)}):a})).then(function(a){return n.graphicsExtent(a).expand(b.expandFactor||1.5)})}return f(b.extent||a(),function(a){return k.needProject(a,c)?f(k.projectGeometries(a,c),function(a){return c.setExtent(a)}):c.setExtent(a)})},_createFallbackStaticMap:function(c,b){return this._createStaticMap(this._mapImageInfos&&this._mapImageInfos[c.areaIndex]&&this._mapImageInfos[c.areaIndex][c.webMapId],b,c)},_createStaticMap:function(c,b,a){var d=c&&new B(c,b);return d&&d.load().then(function(){return d.loaded?
{node:b,map:d,itemId:a.webMapId,legend:null}:null})},getPlayerZoomScale:function(c){}});h.EXPAND_FACTOR=1.5;return h});