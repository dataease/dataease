// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/vectorTiles/renderers/IconRenderer","require exports ../../../core/libs/gl-matrix/mat4 ../../../core/libs/gl-matrix/vec3 ../../../core/libs/gl-matrix/vec4 ../GeometryUtils ./rendererUtils ./vtShaderSnippets ../../webgl/ShaderVariations ../../webgl/VertexArrayObject".split(" "),function(H,I,n,x,D,B,E,F,G,u){return function(){function d(){this._attributeLocations={a_pos:0,a_vertexOffset:1,a_tex:2,a_levelInfo:3};this._attributeLocationsDD={a_pos:0,a_vertexOffset:1,
a_tex:2,a_levelInfo:3,a_color:4,a_size:5};this._spritesTextureSize=new Float32Array(2);this._initialized=!1;this._viewProjMat=n.create();this._offsetVector=x.create();this._extrudeMat=n.create();this._color=D.create()}d.prototype.dispose=function(){};d.prototype.render=function(e,b,a,v,d,w,p,f,y,k,z,h){var A=this;this._initialized||this._initialize(e);var u=f.hasDataDrivenIconSize?1:f.getLayoutValue("icon-size",a),g=f.hasDataDrivenIconColor?[1,1,1,1]:f.getPaintValue("icon-color",a),t=f.hasDataDrivenIconOpacity?
1:f.getPaintValue("icon-opacity",a);h*=g[3]*t;this._color[0]=h*g[0];this._color[1]=h*g[1];this._color[2]=h*g[2];this._color[3]=h;g=f.getLayoutValue("icon-rotation-alignment",a);2===g&&(g=1===f.getLayoutValue("symbol-placement",a)?0:1);var x=0===g;h=b.isSDF;t=f.hasDataDrivenIcon;v=3===v;var g=B.degToByte(d),q=p.tileTransform.transform,l=f.getPaintValue("icon-translate",a);if(0!==l[0]||0!==l[1]){n.copy(this._viewProjMat,p.tileTransform.transform);var q=l[0],l=l[1],r=0,m=0,m=(1<<p.key.level)/Math.pow(2,
a)*(p.coordRange/512);if(1===f.getPaintValue("icon-translate-anchor",a)){r=-B.C_DEG_TO_RAD*d;d=Math.sin(r);var C=Math.cos(r),r=m*(q*C-l*d),m=m*(q*d+l*C)}else r=m*q,m*=l;this._offsetVector[0]=r;this._offsetVector[1]=m;this._offsetVector[2]=0;n.translate(this._viewProjMat,this._viewProjMat,this._offsetVector);q=this._viewProjMat}x?n.copy(this._extrudeMat,k):n.copy(this._extrudeMat,z);if(k=this._getIconVAO(e,p,t)){e.bindVAO(k);var c=this._shaderVariations.getProgram([h,t,v],void 0,void 0,t?this._attributeLocationsDD:
this._attributeLocations);e.bindProgram(c);h&&(k=f.getPaintValue("icon-halo-color",a),z=f.getPaintValue("icon-halo-width",a),c.setUniform4f("u_outlineColor",k[0],k[1],k[2],k[3]),c.setUniform1f("u_outlineSize",z));c.setUniformMatrix4fv("u_transformMatrix",q);c.setUniformMatrix4fv("u_extrudeMatrix",this._extrudeMat);c.setUniform2fv("u_normalized_origin",p.tileTransform.displayCoord);c.setUniform1f("u_depth",f.z);c.setUniform1f("u_mapRotation",g);c.setUniform1f("u_keepUpright",0);c.setUniform1f("u_level",
10*a);c.setUniform1f("u_fadeSpeed",10*w.fadeSpeed);c.setUniform1f("u_minfadeLevel",10*w.minfadeLevel);c.setUniform1f("u_maxfadeLevel",10*w.maxfadeLevel);c.setUniform1f("u_fadeChange",10*(a+w.fadeChange));c.setUniform1i("u_texture",1);c.setUniform1f("u_size",u);c.setUniform4fv("u_color",this._color);v&&(a=E.int32To4Bytes(b.layerID),c.setUniform4f("u_id",a[0],a[1],a[2],a[3]));b.markerPerPageElementsMap.forEach(function(a,b){A._spritesTextureSize[0]=y.getWidth(b)/4;A._spritesTextureSize[1]=y.getHeight(b)/
4;c.setUniform2fv("u_mosaicSize",A._spritesTextureSize);y.bind(e,9729,b,1);e.drawElements(4,a[1],5125,12*a[0])});e.bindVAO()}};d.prototype._initialize=function(e){if(this._initialized)return!0;e=new G("icon",["iconVS","iconFS"],[],F,e);e.addDefine("SDF","SDF",[!0,!0],"SDF");e.addDefine("DD","DD",[!0,!1],"DD");e.addDefine("ID","ID",[!0,!0],"ID");this._shaderVariations=e;this._vertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:16,normalized:!1,divisor:0},{name:"a_vertexOffset",
count:2,type:5122,offset:4,stride:16,normalized:!1,divisor:0},{name:"a_tex",count:4,type:5121,offset:8,stride:16,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:16,normalized:!1,divisor:0}]};this._vertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:24,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:24,normalized:!1,divisor:0},{name:"a_tex",count:4,type:5121,offset:8,stride:24,normalized:!1,divisor:0},{name:"a_levelInfo",
count:4,type:5121,offset:12,stride:24,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:16,stride:24,normalized:!0,divisor:0},{name:"a_size",count:1,type:5126,offset:20,stride:24,normalized:!1,divisor:0}]};return this._initialized=!0};d.prototype._getIconVAO=function(e,b,a){if(a){if(b.iconDDVertexArrayObject)return b.iconDDVertexArrayObject;a=b.iconDDVertexBuffer;var d=b.iconIndexBuffer;if(!a||!d)return null;b.iconDDVertexArrayObject=new u(e,this._attributeLocationsDD,this._vertexAttributesDD,
{geometry:a},d);return b.iconDDVertexArrayObject}if(b.iconVertexArrayObject)return b.iconVertexArrayObject;a=b.iconVertexBuffer;d=b.iconIndexBuffer;if(!a||!d)return null;b.iconVertexArrayObject=new u(e,this._attributeLocations,this._vertexAttributes,{geometry:a},d);return b.iconVertexArrayObject};return d}()});