// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterLib/function/rasterFunctionHelper",["dojo/_base/declare","dojo/_base/lang","./rasterFunctionRegistry"],function(r,g,q){return{create:function(a,b){if(a){var c=a.renderTexture,e=Object.keys(a);if(a.read&&!b)return a;a.read&&b&&(a=a.toJson());-1<e.indexOf("name")&&e.indexOf(!1)?(a=g.mixin({},a),b=this._parseV2(a,b)):(a="esri.layers.RasterFunction"===a.declaredClass?a.toJson():g.mixin({},a),b=this._parseV1(a,b));b.branchCount=b.updateBranchStructure();b.renderTexture||(b.renderTexture=
!!c);return b}},_parseV1:function(a,b){var c=a.rasterFunction,e=a.rasterFunctionArguments,f=a.renderTexture||a.rasterFunctionArguments.renderTexture||!1,h,k,l,d,m,n,p;(d=e.raster||e.Raster)&&d.rasterFunction&&(h=this._parseV1(d,b));(d=e.raster2||e.Raster2)&&d.rasterFunction&&(k=this._parseV1(d,b));(d=e.rasters||e.Rasters)&&0<d.length&&(l=d.map(g.hitch(this,function(a){return a&&a.rasterFunction?this._parseV1(a,b):a})));(d=e.dem||e.DEM)&&(d.functionName||d.rasterFunction)&&(m=this._parseV1(d,b));(d=
e.fillRaster||e.FillRaster)&&(d.functionName||d.rasterFunction)&&(n=this._parseV1(d,b));d=q.functions[c];if(!d)return console.error("Function is not currently supported: "+c),null;c=new d(e);c.variableName&&(d=e[c.variableName])&&(d.functionName||d.rasterFunction)&&(p=this._parseV1(d,b));a.outputPixelType&&(c.pixelType=a.outputPixelType);"$$"===h?c.functionArguments.raster=b&&b.raster:null!=h?c.functionArguments.raster=h:c.functionArguments.raster||(c.functionArguments.raster=b&&b.raster);null!=k&&
(c.functionArguments.raster2=k);null!=l&&(c.functionArguments.rasters=l.map(function(a){"$$"===a&&(a=b&&b.raster);return a}));null!=m&&(c.functionArguments.dem=m);null!=n&&(c.functionArguments.fillRaster=n);null!=p&&(c.functionArguments[c.variableName]=p);c.renderTexture=f;return c},_parseV2:function(a,b){if(!a)return null;a=g.clone(a);this._bindV2Args(a,b);var c={};this._convertTov1(a,c);return this._parseV1(c,b)},_bindV2Args:function(a,b){(a||b)&&Object.keys(a).forEach(function(c){a[c]["function"]&&
a[c].arguments?this._bindV2Args(a[c].arguments,b):null!=b[a[c].name]&&(a[c].value=b[a[c].name])}.bind(this))},_convertV2Types:function(a){if(!a)return null;"ArgumentArray"===a.type?a.elements&&"RasterStatistics"===a.elements[0].type&&(a=a.elements):a instanceof Array&&0===a.length&&(a=null);return a},_convertTov1:function(a,b){if((a||b)&&a["function"]){var c=a["function"],e=a.arguments;b.rasterFunction=c.type.replace("Function","");b.outputPixelType="UNKNOWN"===c.pixelType?"Unknown":c.pixelType;b.rasterFunctionArguments=
{};var f;Object.keys(e).forEach(function(a){e[a]["function"]&&e[a].arguments?(b.rasterFunctionArguments[a]={},this._convertTov1(e[a],b.rasterFunctionArguments[a])):(f=e[a].value,b.rasterFunctionArguments[a]="object"!==typeof f||f.functionArguments?f:this._convertV2Types(f))}.bind(this))}}}});