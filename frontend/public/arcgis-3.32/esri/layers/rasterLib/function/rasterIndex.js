// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterLib/function/rasterIndex",["dojo/_base/lang"],function(n){return{calculate:function(f,e){if(f&&f.pixels&&f.pixels.length){var h=e&&e.bandIndexes;e=e&&e.method;var d=h.trim().split(" ").map(function(a){return parseInt(a,10)}).filter(function(a){return null!=a});f=this._clonePixelBlock(f);var c=f.pixels,b=f.mask;switch(e){case 1:c=this._calculateNDVI(b,c[d[0]-1],c[d[1]-1]);break;case 2:c=this._calculateSAVI(b,c[d[0]-1],c[d[1]-1],d[2]);break;case 3:c=this._calculateTSAVI(b,
c[d[0]-1],c[d[1]-1],d[2],d[3],d[4]);break;case 4:c=this._calculateMSAVI(b,c[d[0]-1],c[d[1]-1]);break;case 5:c=this._calculateGEMI(b,c[d[0]-1],c[d[1]-1]);break;case 6:c=this._calculatePVI(b,c[d[0]-1],c[d[1]-1],d[2],d[3]);break;case 7:c=this._calculateGVITM(b,c[d[0]-1],c[d[1]-1],c[d[2]-1],c[d[3]-1],c[d[4]-1],c[d[5]-1]);break;case 8:c=this._calculateSultan(b,c[d[0]-1],c[d[1]-1],c[d[2]-1],c[d[3]-1],c[d[4]-1],c[d[5]-1]);break;case 9:c=this._calculateVARI(b,c[d[0]-1],c[d[1]-1],c[d[2]-1]);break;case 0:c=
this._calculateUserDefined(b,c,h)}f.pixels=c;f.pixelType="F32";f.calculateStatistics();return f}},_clonePixelBlock:function(f){return f.clone?f.clone():n.clone(f)},_parseUserDefined:function(f,e){f=f.replace(" ","");0===f.indexOf("-")&&(f="0"+f);0===f.indexOf("+")&&(f=f.slice(1,f.length));f=f.split("");var h=[],d=[],c="+-*/()".split(""),b,a="",g;for(b=0;b<f.length;b++)g=f[b],c.some(function(a){return a===g})?(""!==a&&d.push(parseFloat(a)),h.push(g),a=""):"b"===g.toLowerCase()?(b++,a=g.concat(f[b]),
d.push(e[parseInt(a[1],10)-1]),a=""):(a=a.concat(g),b===f.length-1&&d.push(parseFloat(a)));return{ops:h,nums:d}},_op:function(f,e,h,d){if(h.constructor===Number&&d.constructor===Number)return h+d;var c,b,a;if(h.constructor===Number)for(c=d.length,b=h,h=new Float32Array(c),a=0;a<c;a++)h[a]=b;else if(c=h.length,d.constructor===Number)for(b=d,d=new Float32Array(c),a=0;a<c;a++)d[a]=b;b=new Float32Array(c);if(null==f)if("+"===e)for(a=0;a<c;a++)b[a]=h[a]+d[a];else if("-"===e)for(a=0;a<c;a++)b[a]=h[a]-d[a];
else if("*"===e)for(a=0;a<c;a++)b[a]=h[a]*d[a];else{if("/"===e)for(a=0;a<c;a++)b[a]=h[a]/d[a]}else if("+"===e)for(a=0;a<c;a++)f[a]&&(b[a]=h[a]+d[a]);else if("-"===e)for(a=0;a<c;a++)f[a]&&(b[a]=h[a]-d[a]);else if("*"===e)for(a=0;a<c;a++)f[a]&&(b[a]=h[a]*d[a]);else if("/"===e)for(a=0;a<c;a++)f[a]&&(b[a]=h[a]/d[a]);return b},_shrinkOp:function(f,e){f.splice(e,1);var h=e=0,d=0;do{for(e=d=h=0;e<f.length;e++)if("("===f[e])h=e;else if(")"===f[e]){d=e;break}d===h+1&&f.splice(h,2)}while(d===h+1);return f},
_getPriorityOpIndex:function(f,e){if(1===f.length)return{opIndex:0,numIndex:0};var h=e=0,d=0,c=-1,b=0,a;for(e=0;e<f.length;e++)if("("===f[e])h=e;else if(")"===f[e]){d=e;break}a=0===d?f:f.slice(h+1,d);for(e=0;e<a.length;e++)if("*"===a[e]||"/"===a[e]){c=e;break}if(!(-1<c))for(e=0;e<a.length;e++)if("+"===a[e]||"-"===a[e]){c=e;break}0<d&&(c+=h+1);for(e=0;e<c;e++)"("===f[e]&&b++;return{opIndex:c,numIndex:c-b}},_calculateUserDefined:function(f,e,h){e=this._parseUserDefined(h,e);h=e.ops;for(var d=e.nums,
c,b,a;0<h.length&&(e=this._getPriorityOpIndex(h,d),c=h[e.opIndex],b=d[e.numIndex],a=d[e.numIndex+1],c=this._op(f,c,b,a),1!==h.length);)h=this._shrinkOp(h,e.opIndex),d.splice(e.numIndex,2,c);return[c]},_calculateNDVI:function(f,e,h){var d=h.length,c=new Float32Array(d),b,a,g;if(null==f)for(b=0;b<d;b++)a=h[b],g=e[b],c[b]=(g-a)/(g+a);else for(b=0;b<d;b++)f[b]&&(a=h[b],g=e[b],c[b]=(g-a)/(g+a));return[c]},_calculateSAVI:function(f,e,h,d){var c=h.length,b=new Float32Array(c),a,g,m;if(null==f)for(a=0;a<
c;a++)g=h[a],m=e[a],b[a]=(m-g)/(m+g+d)*(1+d);else for(a=0;a<c;a++)f[a]&&(g=h[a],m=e[a],b[a]=(m-g)/(m+g+d)*(1+d));return[b]},_calculateTSAVI:function(f,e,h,d,c,b){var a=h.length,g=new Float32Array(a),m,k,l=-c*d+b*(1+d*d);if(null==f)for(b=0;b<a;b++)m=h[b],k=e[b],g[b]=d*(k-d*m-c)/(c*k+m+l);else for(b=0;b<a;b++)f[b]&&(m=h[b],k=e[b],g[b]=d*(k-d*m-c)/(c*k+m+l));return[g]},_calculateMSAVI:function(f,e,h){var d=h.length,c=new Float32Array(d),b,a,g;if(null==f)for(b=0;b<d;b++)a=h[b],g=e[b],c[b]=.5*(2*(g+1)-
Math.sqrt(Math.pow(2*g+1,2)-8*(g-a)));else for(b=0;b<d;b++)f[b]&&(c[b]=.5*(2*(g+1)-Math.sqrt(Math.pow(2*g+1,2)-8*(g-a))));return[c]},_calculateGEMI:function(f,e,h){var d=h.length,c=new Float32Array(d),b,a,g;if(null==f)for(b=0;b<d;b++)a=h[b],g=e[b],g=(2*(g*g-a*a)+1.5*g+.5*a)/(g+a+.5),c[b]=g*(1-.25*g)-(a-.125)/(1-a);else for(b=0;b<d;b++)f[b]&&(a=h[b],g=e[b],g=(2*(g*g-a*a)+1.5*g+.5*a)/(g+a+.5),c[b]=g*(1-.25*g)-(a-.125)/(1-a));return[c]},_calculatePVI:function(f,e,h,d,c){var b=h.length,a=new Float32Array(b),
g,m,k,l=Math.sqrt(1+d*d);if(null==f)for(g=0;g<b;g++)m=h[g],k=e[g],a[g]=(k-d*m-c)/l;else for(g=0;g<b;g++)f[g]&&(m=h[g],k=e[g],a[g]=(k-d*m-c)/l);return[a]},_calculateGVITM:function(f,e,h,d,c,b,a){var g=e.length,m=new Float32Array(g),k;if(null==f)for(k=0;k<g;k++)m[k]=-.2848*e[k]-.2435*h[k]-.5436*d[k]+.7243*c[k]+.084*b[k]-1.18*a[k];else for(k=0;k<g;k++)f[k]&&(m[k]=-.2848*e[k]-.2435*h[k]-.5436*d[k]+.7243*c[k]+.084*b[k]-1.18*a[k]);return[m]},_calculateSultan:function(f,e,h,d,c,b,a){h=e.length;var g=new Float32Array(h),
m=new Float32Array(h),k=new Float32Array(h),l;if(null==f)for(l=0;l<h;l++)g[l]=b[l]/a[l]*100,m[l]=b[l]/e[l]*100,k[l]=d[l]/c[l]*(b[l]/c[l])*100;else for(l=0;l<h;l++)f[l]&&(g[l]=b[l]/a[l]*100,m[l]=b[l]/e[l]*100,k[l]=d[l]/c[l]*(b[l]/c[l])*100);return[g,m,k]},_calculateVARI:function(f,e,h,d){var c=e.length,b=new Float32Array(c),a,g,m,k;if(null==f)for(a=0;a<c;a++)g=e[a],m=h[a],k=d[a],b[a]=(m-g)/(m+g-k);else for(a=0;a<c;a++)if(f[a])for(a=0;a<c;a++)g=e[a],m=h[a],k=d[a],b[a]=(m-g)/(m+g-k);return[b]}}});