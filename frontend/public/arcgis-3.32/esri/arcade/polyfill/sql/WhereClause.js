// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/arcade/polyfill/sql/WhereClause",["require","exports","dojo/has","./StandardizedFunctions","./WhereGrammar"],function(w,k,x,h,G){function m(c,a){c+="";return c.length>=a?c:Array(a-c.length+1).join("0")+c}function n(c,a,b,f,d,e,g,q,h){void 0===b&&(b="0");void 0===f&&(f="0");void 0===d&&(d="0");void 0===e&&(e="0");void 0===g&&(g="");void 0===q&&(q="0");void 0===h&&(h="0");return"+"===g||"-"===g?(c=m(parseInt(c,10),4)+"-"+m(parseInt(a,10),2)+"-"+m(parseInt(b,10),2),a="",10>parseFloat(e)&&
(a="0"),f=m(parseInt(f,10),2)+":"+m(parseInt(d,10),2)+":"+(a+parseFloat(e).toString()),g=""+g+m(parseInt(q,10),2)+":"+m(parseInt(h,10),2),new Date(c+"T"+f+g)):new Date(parseInt(c,10),parseInt(a,10),parseInt(b,10),parseInt(f,10),parseInt(d,10),parseFloat(e))}function y(c){var a=H.exec(c);if(null!==a){c=a[1];var b=a[2],f=a[3],d=a[4],e=a[5],g=a[6];return n(c,b,f,d,e,g)}a=I.exec(c);if(null!==a){c=a[1];var b=a[2],f=a[3],d=a[4],e=a[5],g=a[6],h=a[7],k=a[8],a=a[9];return n(c,b,f,d,e,g,h,k,a)}a=J.exec(c);
if(null!==a)return c=a[1],b=a[2],f=a[3],d=a[4],e=a[5],h=a[6],k=a[7],a=a[8],n(c,b,f,d,e,"0",h,k,a);a=K.exec(c);if(null!==a)return c=a[1],b=a[2],f=a[3],d=a[4],e=a[5],n(c,b,f,d,e);a=z.exec(c);if(null!==a)return c=a[1],b=a[2],f=a[3],n(c,b,f);throw Error("SQL Invalid Timestamp");}function A(c){c=z.exec(c);if(null===c)throw Error("SQL Invalid Date");var a=c[2],b=c[3];return new Date(parseInt(c[1],10),parseInt(a,10)-1,parseInt(b,10))}function r(c){return Array.isArray(c)?c:[c]}function p(c){return null!==
c?!0!==c:null}function B(c,a){return null!=c&&null!=a?!0===c&&!0===a:!1===c||!1===a?!1:null}function C(c,a){return null!=c&&null!=a?!0===c||!0===a:!0===c||!0===a?!0:null}function t(c,a){if(null==c)return null;for(var b=!1,f=0;f<a.length;f++){var d=a[f];if(null==d)b=null;else if(c===d){b=!0;break}}return b}function u(c,a,b){if(null==c)return null;var f="",d,e=d||(d={});e[e.Normal=0]="Normal";e[e.Escaped=1]="Escaped";for(e=d=0;e<a.length;e++){var g=a.charAt(e);switch(d){case 0:g===b?d=1:f=0<="-[]/{}()*+?.\\^$|".indexOf(g)?
f+("\\"+g):"%"===g?f+".*":"_"===g?f+".":f+g;break;case 1:f=0<="-[]/{}()*+?.\\^$|".indexOf(g)?f+("\\"+g):f+g,d=0}}return(new RegExp("^"+f+"$")).test(c)}function l(c){return c instanceof Date?c.valueOf():c}function D(c,a,b){if(null==a||null==b)return null;a=l(a);b=l(b);switch(c){case "\x3c\x3e":return a!==b;case "\x3d":return a===b;case "\x3e":return a>b;case "\x3c":return a<b;case "\x3e\x3d":return a>=b;case "\x3c\x3d":return a<=b}}function v(c){for(var a=[],b={},f=0;f<c.length;f++){var d=c[f],e=d.toLowerCase();
void 0===b[e]&&(a.push(d),b[e]=1)}return a}function E(c,a,b){if(a instanceof h.SqlInterval)if(b instanceof Date)switch(c){case "+":return new Date(a.valueInMilliseconds()+b.getTime());case "-":return a.valueInMilliseconds()-b.getTime();case "*":return a.valueInMilliseconds()*b.getTime();case "/":return a.valueInMilliseconds()/b.getTime()}else if(b instanceof h.SqlInterval)switch(c){case "+":return h.SqlInterval.createFromMilliseconds(a.valueInMilliseconds()+b.valueInMilliseconds());case "-":return h.SqlInterval.createFromMilliseconds(a.valueInMilliseconds()-
b.valueInMilliseconds());case "*":return a.valueInMilliseconds()*b.valueInMilliseconds();case "/":return a.valueInMilliseconds()/b.valueInMilliseconds()}else a=a.valueInMilliseconds();else if(b instanceof h.SqlInterval)if(a instanceof Date)switch(c){case "+":return new Date(b.valueInMilliseconds()+a.getTime());case "-":return new Date(a.getTime()-b.valueInMilliseconds());case "*":return a.getTime()*b.valueInMilliseconds();case "/":return a.getTime()/b.valueInMilliseconds()}else b=b.valueInMilliseconds();
else if(a instanceof Date&&"number"===typeof b)switch(b*=864E5,a=a.getTime(),c){case "+":return new Date(a+b);case "-":return new Date(a-b);case "*":return new Date(a*b);case "/":return new Date(a/b)}else if(b instanceof Date&&"number"===typeof a)switch(a*=864E5,b=b.getTime(),c){case "+":return new Date(a+b);case "-":return new Date(a-b);case "*":return new Date(a*b);case "/":return new Date(a/b)}switch(c){case "+":return a+b;case "-":return a-b;case "*":return a*b;case "/":return a/b}}function F(c,
a,b,f){c=f.getAttribute(c,a);return null!=c&&1===b[a]?new Date(c):c}Object.defineProperty(k,"__esModule",{value:!0});var z=/^(\d{4})-(\d{1,2})-(\d{1,2})$/,H=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2}(\.[0-9]+)?)$/,I=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2}(\.[0-9]+)?)(\+|\-)(\d{1,2}):(\d{1,2})$/,J=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})(\+|\-)(\d{1,2}):(\d{1,2})$/,K=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})$/,L=function(){function c(){}c.makeBool=
function(a){return!0===a};c.featureValue=function(a,b,c,d){return F(a,b,c,d)};c.equalsNull=function(a){return null===a};c.applyLike=function(a,b,c){return u(a,b,c)};c.ensureArray=function(a){return r(a)};c.applyIn=function(a,b){return t(a,b)};c.currentDate=function(){var a=new Date;a.setHours(0,0,0,0);return a};c.makeSqlInterval=function(a,b,c){return h.SqlInterval.createFromValueAndQualifer(a,b,c)};c.convertInterval=function(a){return a instanceof h.SqlInterval?a.valueInMilliseconds():a};c.currentTimestamp=
function(){return new Date};c.compare=function(a,b,c){return D(a,b,c)};c.calculate=function(a,b,c){return E(a,b,c)};c.makeComparable=function(a){return l(a)};c.evaluateFunction=function(a,b){return h.evaluateFunction(a,b)};c.lookup=function(a,b){a=b[a];return void 0===a?null:a};c.between=function(a,b){return null==a||null==b[0]||null==b[1]?null:a>=b[0]&&a<=b[1]};c.notbetween=function(a,b){return null==a||null==b[0]||null==b[1]?null:a<b[0]||a>b[1]};c.ternaryNot=function(a){return p(a)};c.ternaryAnd=
function(a,b){return B(a,b)};c.ternaryOr=function(a,b){return C(a,b)};return c}();w=function(){function c(a,b){this.fieldsIndex=b;this.datefields={};this.parameters={};this.parseTree=G.WhereGrammar.parse(a);a=this.extractExpressionInfo(b);b=a.isStandardized;this.referencedFieldNames=a.referencedFieldNames;this.isStandardized=b}c.create=function(a,b){return new c(a,b)};Object.defineProperty(c.prototype,"fieldNames",{get:function(){return this.referencedFieldNames},enumerable:!0,configurable:!0});c.prototype.testSet=
function(a,b){void 0===b&&(b=k.defaultAttributeAdapter);for(var c={},d=function(f){c[f]=a.map(function(a){return b.getAttribute(a,f)})},e=0,g=this.fieldNames;e<g.length;e++)d(g[e]);return!!this.evaluateNode(this.parseTree,{attributes:c},k.defaultAttributeAdapter)};c.prototype.calculateValue=function(a,b){void 0===b&&(b=k.defaultAttributeAdapter);a=this.evaluateNode(this.parseTree,a,b);return a instanceof h.SqlInterval?a.valueInMilliseconds()/864E5:a};c.prototype.calculateValueCompiled=function(a,
b){void 0===b&&(b=k.defaultAttributeAdapter);if(null!=this.parseTree._compiledVersion)return this.parseTree._compiledVersion(a,this.parameters,b,this.datefields);if(x("csp-restrictions"))return this.calculateValue(a,b);this.compileMe();return this.parseTree._compiledVersion(a,this.parameters,b,this.datefields)};c.prototype.testFeature=function(a,b){void 0===b&&(b=k.defaultAttributeAdapter);return!!this.evaluateNode(this.parseTree,a,b)};c.prototype.testFeatureCompiled=function(a,b){void 0===b&&(b=
k.defaultAttributeAdapter);if(null!=this.parseTree._compiledVersion)return!!this.parseTree._compiledVersion(a,this.parameters,b,this.datefields);if(x("csp-restrictions"))return this.testFeature(a,b);this.compileMe();return!!this.parseTree._compiledVersion(a,this.parameters,b,this.datefields)};c.prototype.getFunctions=function(){var a=[];this.visitAll(this.parseTree,function(b){"function"===b.type&&a.push(b.name.toLowerCase())});return v(a)};c.prototype.getVariables=function(){var a=[];this.visitAll(this.parseTree,
function(b){"param"===b.type&&a.push(b.value.toLowerCase())});return v(a)};c.prototype.compileMe=function(){var a="return this.convertInterval("+this.evaluateNodeToJavaScript(this.parseTree)+")";this.parseTree._compiledVersion=(new Function("feature","lookups","attributeAdapter","datefields",a)).bind(L)};c.prototype.extractExpressionInfo=function(a){var b=this,c=[],d=!0;this.visitAll(this.parseTree,function(f){switch(f.type){case "column_ref":var e=f.column.toUpperCase();if("CURRENT_DATE"!==e&&"CURRENT_TIMESTAMP"!==
e){var k=(e=a.get(f.column))&&e.name;!e||"date"!==e.type&&"esriFieldTypeDate"!==e.type||(b.datefields[e.name]=1);void 0!==k?(c.push(k),f.column=k):c.push(f.column)}break;case "function":e=f.name,f=f.args.value.length,d&&(d=h.isStandardized(e,f))}});return{referencedFieldNames:v(c),isStandardized:d}};c.prototype.visitAll=function(a,b){if(null!=a)switch(b(a),a.type){case "when_clause":this.visitAll(a.operand,b);this.visitAll(a.value,b);break;case "case_expression":for(var c=0,d=a.clauses;c<d.length;c++){var e=
d[c];this.visitAll(e,b)}"simple"===a.format&&this.visitAll(a.operand,b);null!==a.else&&this.visitAll(a.else,b);break;case "expr_list":c=0;for(a=a.value;c<a.length;c++)e=a[c],this.visitAll(e,b);break;case "unary_expr":this.visitAll(a.expr,b);break;case "binary_expr":this.visitAll(a.left,b);this.visitAll(a.right,b);break;case "function":this.visitAll(a.args,b)}};c.prototype.evaluateNodeToJavaScript=function(a){switch(a.type){case "interval":return"this.makeSqlInterval("+this.evaluateNodeToJavaScript(a.value)+
", "+JSON.stringify(a.qualifier)+","+JSON.stringify(a.op)+")";case "case_expression":var b="";if("simple"===a.format)for(var c="this.makeComparable("+this.evaluateNodeToJavaScript(a.operand)+")",b="( ",d=0;d<a.clauses.length;d++)b+=" ("+c+" \x3d\x3d\x3d this.makeComparable("+this.evaluateNodeToJavaScript(a.clauses[d].operand)+")) ? ("+this.evaluateNodeToJavaScript(a.clauses[d].value)+") : ";else for(b="( ",d=0;d<a.clauses.length;d++)b+=" this.makeBool("+this.evaluateNodeToJavaScript(a.clauses[d].operand)+
")\x3d\x3d\x3dtrue ? ("+this.evaluateNodeToJavaScript(a.clauses[d].value)+") : ";b=null!==a.else?b+this.evaluateNodeToJavaScript(a.else):b+"null";return b+" )";case "param":return"this.lookup("+JSON.stringify(a.value.toLowerCase())+",lookups)";case "expr_list":b="[";c=0;for(a=a.value;c<a.length;c++)d=a[c],"["!==b&&(b+=","),b+=this.evaluateNodeToJavaScript(d);return b+"]";case "unary_expr":return"this.ternaryNot("+this.evaluateNodeToJavaScript(a.expr)+")";case "binary_expr":switch(a.operator){case "AND":return"this.ternaryAnd("+
this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+" )";case "OR":return"this.ternaryOr("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+" )";case "IS":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return"this.equalsNull("+this.evaluateNodeToJavaScript(a.left)+")";case "ISNOT":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return"(!(this.equalsNull("+this.evaluateNodeToJavaScript(a.left)+")))";case "IN":return"this.applyIn("+
this.evaluateNodeToJavaScript(a.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(a.right)+"))";case "NOT IN":return"this.ternaryNot(this.applyIn("+this.evaluateNodeToJavaScript(a.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(a.right)+")))";case "BETWEEN":return"this.between("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+")";case "NOTBETWEEN":return"this.notbetween("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+
")";case "LIKE":return"this.applyLike("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+","+JSON.stringify(a.escape)+")";case "NOT LIKE":return"this.ternaryNot(this.applyLike("+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+","+JSON.stringify(a.escape)+"))";case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":return"this.compare("+JSON.stringify(a.operator)+","+this.evaluateNodeToJavaScript(a.left)+","+
this.evaluateNodeToJavaScript(a.right)+")";case "*":case "-":case "+":case "/":return"this.calculate("+JSON.stringify(a.operator)+","+this.evaluateNodeToJavaScript(a.left)+","+this.evaluateNodeToJavaScript(a.right)+")"}throw Error("Not Supported Operator "+a.operator);case "null":case "bool":case "string":case "number":return JSON.stringify(a.value);case "date":return"(new Date("+A(a.value).getTime().toString()+"))";case "timestamp":return"(new Date("+y(a.value).getTime().toString()+"))";case "column_ref":return"CURRENT_DATE"===
a.column.toUpperCase()?"this.currentDate()":"CURRENT_TIMESTAMP"===a.column.toUpperCase()?"this.currentTimestamp()":"this.featureValue(feature,"+JSON.stringify(a.column)+",datefields,attributeAdapter)";case "function":return"this.evaluateFunction("+JSON.stringify(a.name)+","+this.evaluateNodeToJavaScript(a.args)+")"}throw Error("Unsupported sql syntax "+a.type);};c.prototype.evaluateNode=function(a,b,c){switch(a.type){case "interval":return b=this.evaluateNode(a.value,b,c),h.SqlInterval.createFromValueAndQualifer(b,
a.qualifier,a.op);case "case_expression":if("simple"===a.format)for(var d=l(this.evaluateNode(a.operand,b,c)),e=0;e<a.clauses.length;e++){if(d===l(this.evaluateNode(a.clauses[e].operand,b,c)))return this.evaluateNode(a.clauses[e].value,b,c)}else for(e=0;e<a.clauses.length;e++)if(!0===this.evaluateNode(a.clauses[e].operand,b,c))return this.evaluateNode(a.clauses[e].value,b,c);return null!==a.else?this.evaluateNode(a.else,b,c):null;case "param":return this.parameters[a.value.toLowerCase()];case "expr_list":d=
[];e=0;for(a=a.value;e<a.length;e++){var f=a[e];d.push(this.evaluateNode(f,b,c))}return d;case "unary_expr":return p(this.evaluateNode(a.expr,b,c));case "binary_expr":switch(a.operator){case "AND":return B(this.evaluateNode(a.left,b,c),this.evaluateNode(a.right,b,c));case "OR":return C(this.evaluateNode(a.left,b,c),this.evaluateNode(a.right,b,c));case "IS":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return null===this.evaluateNode(a.left,b,c);case "ISNOT":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");
return null!==this.evaluateNode(a.left,b,c);case "IN":return d=r(this.evaluateNode(a.right,b,c)),t(this.evaluateNode(a.left,b,c),d);case "NOT IN":return d=r(this.evaluateNode(a.right,b,c)),p(t(this.evaluateNode(a.left,b,c),d));case "BETWEEN":return d=this.evaluateNode(a.left,b,c),a=this.evaluateNode(a.right,b,c),null==d||null==a[0]||null==a[1]?null:d>=l(a[0])&&d<=l(a[1]);case "NOTBETWEEN":return d=this.evaluateNode(a.left,b,c),a=this.evaluateNode(a.right,b,c),null==d||null==a[0]||null==a[1]?null:
d<l(a[0])||d>l(a[1]);case "LIKE":return u(this.evaluateNode(a.left,b,c),this.evaluateNode(a.right,b,c),a.escape);case "NOT LIKE":return p(u(this.evaluateNode(a.left,b,c),this.evaluateNode(a.right,b,c),a.escape));case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":return D(a.operator,this.evaluateNode(a.left,b,c),this.evaluateNode(a.right,b,c));case "-":case "+":case "*":case "/":return E(a.operator,this.evaluateNode(a.left,b,c),this.evaluateNode(a.right,b,c))}throw Error("Not Supported Operator "+
a.operator);case "null":case "bool":case "string":case "number":return a.value;case "date":return A(a.value);case "timestamp":return y(a.value);case "column_ref":return"CURRENT_DATE"===a.column.toUpperCase()?(f=new Date,f.setHours(0,0,0,0),f):"CURRENT_TIMESTAMP"===a.column.toUpperCase()?new Date:F(b,a.column,this.datefields,c);case "function":return b=this.evaluateNode(a.args,b,c),h.evaluateFunction(a.name,b)}throw Error("Unsupported sql syntax "+a.type);};return c}();k.WhereClause=w;k.defaultAttributeAdapter=
{getAttribute:function(c,a){return(c&&"object"===typeof c.attributes?c.attributes:c)[a]}}});